# ğŸ¥ Audit Report â€” Revenue Management System
**NgÃ y:** 12/02/2026 | **Pháº¡m vi:** Full Audit | **Auditor:** BÃ¡c sÄ© Khang

## TÃ³m táº¯t

| | Sá»‘ lÆ°á»£ng |
|---|---|
| ğŸ”´ **Critical** | 1 |
| ğŸŸ¡ **Warnings** | 6 |
| ğŸŸ¢ **Suggestions** | 4 |

**Tá»•ng quan:** Dá»± Ã¡n khÃ¡ "khá»e máº¡nh" â€” khÃ´ng cÃ³ lá»— há»•ng SQL injection, XSS, hay hardcoded secrets. Váº¥n Ä‘á» nghiÃªm trá»ng duy nháº¥t lÃ  package `xlsx` cÃ³ lá»— há»•ng báº£o máº­t chÆ°a Ä‘Æ°á»£c vÃ¡.

---

## ğŸ”´ Critical Issues (Pháº£i sá»­a ngay)

### 1. Package `xlsx` cÃ³ lá»— há»•ng báº£o máº­t HIGH (CVSS 7.8)

- **File:** `package.json` â†’ dependency `xlsx`
- **Váº¥n Ä‘á»:** 2 lá»— há»•ng:
  - **Prototype Pollution** ([GHSA-4r6h-8v6p-xvw6](https://github.com/advisories/GHSA-4r6h-8v6p-xvw6)) â€” Hacker cÃ³ thá»ƒ chiáº¿m quyá»n server
  - **ReDoS** ([GHSA-5pgg-2g8v-p4x9](https://github.com/advisories/GHSA-5pgg-2g8v-p4x9)) â€” Hacker gá»­i file Excel Ä‘áº·c biá»‡t â†’ server treo
- **Háº­u quáº£:** NgÆ°á»i dÃ¹ng upload file Excel Ä‘á»™c háº¡i â†’ server bá»‹ táº¥n cÃ´ng
- **CÃ¡ch sá»­a:** Chuyá»ƒn sang `xlsx` phiÃªn báº£n thÆ°Æ¡ng máº¡i (SheetJS Pro) hoáº·c dÃ¹ng thay tháº¿ miá»…n phÃ­:
  ```
  npm uninstall xlsx
  npm install exceljs
  ```
  > âš ï¸ `npm audit fix` khÃ´ng sá»­a Ä‘Æ°á»£c vÃ¬ khÃ´ng cÃ³ báº£n vÃ¡ miá»…n phÃ­.

---

## ğŸŸ¡ Warnings (NÃªn sá»­a)

### 2. `console.log` trong API routes (18 chá»—)

- **Files:** `api/upload/cancellation/route.ts` (12), `api/rate-shopper/scan/route.ts` (3), `api/pricing/ota-channels/route.ts` (2), `api/admin/users/[id]/route.ts` (1)
- **Váº¥n Ä‘á»:** Log chi tiáº¿t nhÆ° hotel_id, file size, user info ra server logs. Trong production, log quÃ¡ nhiá»u vá»«a tá»‘n tÃ i nguyÃªn, vá»«a cÃ³ thá»ƒ lá»™ thÃ´ng tin nháº¡y cáº£m náº¿u log bá»‹ truy cáº­p.
- **CÃ¡ch sá»­a:** DÃ¹ng log level: giá»¯ `console.error` cho lá»—i tháº­t, chuyá»ƒn `console.log` sang logger cÃ³ on/off theo environment:
  ```ts
  const log = process.env.NODE_ENV === 'development' ? console.log : () => {}
  ```

### 3. `allowDangerousEmailAccountLinking: true` trong Google OAuth

- **File:** [auth.ts](file:///c:/Apps/Antigravity/revenue-management-system/apps/web/lib/auth.ts#L22)
- **Váº¥n Ä‘á»:** Cho phÃ©p liÃªn káº¿t tÃ i khoáº£n email tá»± Ä‘á»™ng mÃ  khÃ´ng xÃ¡c minh. Náº¿u 2 Google accounts cÃ¹ng email â†’ tá»± Ä‘á»™ng merge, cÃ³ thá»ƒ bá»‹ lá»£i dá»¥ng.
- **Háº­u quáº£ thá»±c táº¿:** Rá»§i ro tháº¥p vÃ¬ chá»‰ dÃ¹ng Google OAuth (khÃ´ng cÃ³ provider khÃ¡c). NhÆ°ng náº¿u thÃªm provider sau â†’ nguy hiá»ƒm.
- **CÃ¡ch sá»­a:** Náº¿u chá»‰ cÃ³ 1 provider (Google), rá»§i ro cháº¥p nháº­n Ä‘Æ°á»£c. Ghi comment giáº£i thÃ­ch lÃ½ do báº­t.

### 4. Rate limiting chá»‰ cÃ³ á»Ÿ invite redeem

- **File:** Chá»‰ cÃ³ `api/invite/redeem/route.ts` dÃ¹ng `tryRateLimit()`
- **Váº¥n Ä‘á»:** CÃ¡c API khÃ¡c (login, upload, admin actions) khÃ´ng cÃ³ rate limiting. Hacker cÃ³ thá»ƒ brute-force hoáº·c spam upload.
- **CÃ¡ch sá»­a:** ThÃªm rate limit cho:
  - `/api/upload/*` (ngÄƒn spam upload)
  - `/api/admin/*` (ngÄƒn brute-force admin actions)
  - `/api/onboarding` (ngÄƒn táº¡o nhiá»u hotel)

### 5. Prisma ráº¥t cÅ© (5.10.2 â†’ 7.4.0)

- **File:** `package.json`
- **Váº¥n Ä‘á»:** CÃ¡ch phiÃªn báº£n má»›i nháº¥t **2 major versions** (5.x â†’ 6.x â†’ 7.x). Bá» lá»¡ performance improvements, security patches, vÃ  features má»›i.
- **CÃ¡ch sá»­a:** Upgrade dáº§n, kiá»ƒm tra [migration guide](https://www.prisma.io/docs/orm/more/upgrade-guides):
  ```
  npm install prisma@latest @prisma/client@latest
  npx prisma generate
  ```
  > âš ï¸ Breaking changes cÃ³ thá»ƒ xáº£y ra khi nháº£y major version. NÃªn test ká»¹ trÆ°á»›c.

### 6. Auth JWT callback cÃ³ 3 queries tuáº§n tá»±

- **File:** [auth.ts](file:///c:/Apps/Antigravity/revenue-management-system/apps/web/lib/auth.ts#L26-L132) â€” `findUnique` â†’ `findMany` â†’ `findMany`
- **Váº¥n Ä‘á»:** Má»—i láº§n load/refresh JWT token â†’ 3 DB queries tuáº§n tá»± (user â†’ hotelUsers â†’ hotels). TrÃªn má»—i request cÃ³ session check, Ä‘iá»u nÃ y cháº­m.
- **CÃ¡ch sá»­a:** Gá»™p thÃ nh 1 query vá»›i `include`:
  ```ts
  const user = await prisma.user.findUnique({
    where: { email },
    include: { hotel_users: { include: { hotel: true } } }
  })
  ```
  > LÆ°u Ã½: File comment ghi "Nested Prisma include fails silently in Edge runtime" â€” xÃ¡c nháº­n láº¡i xem auth.ts cÃ³ cháº¡y Edge khÃ´ng.

### 7. next-auth dÃ¹ng báº£n beta (5.0.0-beta.30)

- **File:** `package.json`
- **Váº¥n Ä‘á»:** Äang dÃ¹ng beta, báº£n stable lÃ  4.24.13. Beta cÃ³ thá»ƒ cÃ³ breaking changes báº¥t ngá».
- **LÆ°u Ã½:** Next.js 16 + App Router thÆ°á»ng cáº§n v5 beta. Theo dÃµi khi v5 stable release.

---

## ğŸŸ¢ Suggestions (TÃ¹y chá»n)

### 8. 3 TODOs chÆ°a xá»­ lÃ½

| File | TODO |
|------|------|
| `lib/rate-shopper/actions/get-intraday-view.ts:183` | Integrate with actual pricing module |
| `lib/demo/demoHotel.ts:69` | Seed sample data with data_source='SAMPLE' |
| `app/api/subscription/route.ts:45` | Implement export tracking |

### 9. Debug lá»—i `/analytics` page chÆ°a xong

- **Tá»« session.json:** Client-side exception trÃªn `rms.pakhos.com/analytics` váº«n chÆ°a debug. Cáº§n kiá»ƒm tra browser console.

### 10. thiáº¿u README cáº­p nháº­t

- **Váº¥n Ä‘á»:** README khÃ´ng pháº£n Ã¡nh Ä‘áº§y Ä‘á»§ 50+ features hiá»‡n táº¡i, setup guide, hay deployment guide.
- **Gá»£i Ã½:** DÃ¹ng `/code` Ä‘á»ƒ táº¡o README chuyÃªn nghiá»‡p tá»« brain.json.

### 11. Landing page chÆ°a gá»­i email tháº­t

- **Váº¥n Ä‘á»:** `RESEND_API_KEY` chÆ°a set trÃªn Vercel landing â†’ lead form submit nhÆ°ng khÃ´ng gá»­i notification email.

---

## ğŸ“Š Äiá»ƒm Sá»©c Khá»e

| Háº¡ng má»¥c | Äiá»ƒm | Ghi chÃº |
|----------|------|---------|
| ğŸ”’ Báº£o máº­t | â­â­â­â­ (4/5) | Tá»‘t: RBAC + JWT + middleware. Trá»«: xlsx vuln, thiáº¿u rate limit |
| ğŸ“ Code Quality | â­â­â­â­ (4/5) | Sáº¡ch, TypeScript strict. Trá»«: console.logs, 3 TODOs |
| âš¡ Performance | â­â­â­â­ (4/5) | Cached stats, batch queries. Trá»«: auth 3 queries |
| ğŸ“¦ Dependencies | â­â­â­ (3/5) | Framework latest âœ…. Prisma ráº¥t cÅ©, xlsx vuln |
| ğŸ“– Documentation | â­â­â­ (3/5) | brain.json tá»‘t, README cáº§n update |

**Tá»•ng:** â­â­â­â­ (3.6/5) â€” KhÃ¡ khá»e, cáº§n xá»­ lÃ½ xlsx vulnerability

---

## Káº¿t luáº­n

Dá»± Ã¡n **khÃ¡ tá»‘t** cho giai Ä‘oáº¡n production hiá»‡n táº¡i:
- âœ… KhÃ´ng cÃ³ SQL injection, XSS, hardcoded secrets
- âœ… Auth + RBAC + Middleware hoáº¡t Ä‘á»™ng Ä‘Ãºng
- âœ… .env trong .gitignore, khÃ´ng commit secrets
- âš ï¸ Cáº§n sá»­a xlsx vulnerability (CRITICAL)
- âš ï¸ NÃªn thÃªm rate limiting cho upload/admin APIs
- âš ï¸ Upgrade Prisma khi cÃ³ thá»i gian
