generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Hotel {
  hotel_id              String                 @id @default(uuid()) @db.Uuid
  name                  String
  slug                  String?                @unique
  timezone              String                 @default("Asia/Ho_Chi_Minh")
  capacity              Int
  currency              String                 @default("VND")
  country               String                 @default("VN")   // ISO 3166-1 alpha-2 code
  phone                 String?
  created_at            DateTime               @default(now())
  default_base_rate     Decimal?               @db.Decimal(12, 2)
  max_rate              Decimal?               @db.Decimal(12, 2)
  min_rate              Decimal?               @db.Decimal(12, 2)
  fiscal_start_day      Int                    @default(1)
  ladder_steps          String?
  company_email         String?

  // Demo Hotel System
  is_demo               Boolean                @default(false)
  demo_owner_id         String?                @db.Uuid
  expires_at            DateTime?

  // Organization tenant
  org_id                String?                @db.Uuid
  organization          Organization?          @relation(fields: [org_id], references: [id])

  cancellations_raw     CancellationRaw[]
  daily_otb             DailyOTB[]
  demand_forecast       DemandForecast[]
  features_daily        FeaturesDaily[]
  hotel_users           HotelUser[]
  hotel_invites         HotelInvite[]
  import_jobs           ImportJob[]
  ota_channels          OTAChannel[]
  price_recommendations PriceRecommendations[]
  pricing_decisions     PricingDecision[]
  pricing_setting       PricingSetting?
  reservations_raw      ReservationsRaw[]
  room_types            RoomType[]
  users                 User[]

  // Dynamic Pricing by OCC
  season_configs        SeasonConfig[]
  occ_tier_configs      OccTierConfig[]

  // Rate Shopper relations
  competitors               Competitor[]
  rate_shop_requests        RateShopRequest[]
  market_snapshots          MarketSnapshot[]
  rate_shop_recommendations RateShopRecommendation[]
  rate_shop_usage_monthly   RateShopUsageTenantMonthly[]

  // Commercialization
  subscription              Subscription?
  payment_transactions      PaymentTransaction[]

  // PLG — Usage tracking
  usage_monthly             UsageMonthly[]
  usage_daily               UsageDaily[]
  active_promo_code_id      String?                @db.Uuid

  // PLG — Reseller
  reseller_attributions     ResellerAttribution[]
  promo_redemptions         PromoRedemption[]
  invoices                  Invoice[]

  // Analytics Layer P1 — Cancel Rate Stats
  cancel_rate_stats         CancelRateStats[]

  // Dynamic Pricing Config
  pricing_configs           PricingConfig[]

  @@map("hotels")
}

model User {
  id                String            @id @default(uuid()) @map("user_id") @db.Uuid
  hotel_id          String?           @db.Uuid
  email             String            @unique
  created_at        DateTime          @default(now())
  image             String?           @map("avatar_url")
  name              String?
  emailVerified     DateTime?         @map("email_verified")
  is_active         Boolean           @default(true)
  role              UserRole          @default(viewer)
  phone             String?
  accounts          Account[]
  hotel_users       HotelUser[]
  org_members       OrgMember[]
  pricing_decisions PricingDecision[]
  sessions          Session[]
  hotel             Hotel?            @relation(fields: [hotel_id], references: [hotel_id])

  @@map("users")
}

model HotelUser {
  id           String    @id @default(uuid()) @db.Uuid
  user_id      String    @db.Uuid
  hotel_id     String    @db.Uuid
  role         UserRole  @default(viewer)
  is_primary   Boolean   @default(false)
  is_active    Boolean   @default(true)
  last_seen_at DateTime?
  created_at   DateTime  @default(now())
  hotel        Hotel     @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)
  user         User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, hotel_id])
  @@index([hotel_id])
  @@map("hotel_users")
}

model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ImportJob {
  job_id            String            @id @default(uuid()) @db.Uuid
  hotel_id          String            @db.Uuid
  file_name         String
  file_hash         String?
  status            JobStatus         @default(pending)
  error_summary     String?
  created_at        DateTime          @default(now())
  finished_at       DateTime?
  error_log         Json?
  total_rows        Int?
  import_type       ImportType        @default(RESERVATION)
  snapshot_ts       DateTime?         @db.Timestamptz(6)  // For OTB dedup: when the snapshot represents
  cancellations_raw CancellationRaw[]
  hotel             Hotel             @relation(fields: [hotel_id], references: [hotel_id])
  reservations_raw  ReservationsRaw[]

  @@unique([hotel_id, file_hash], map: "uq_import_hotel_hash")
  @@map("import_jobs")
}

model ReservationsRaw {
  id                      String            @id @default(uuid()) @db.Uuid
  hotel_id                String            @db.Uuid
  job_id                  String            @db.Uuid
  reservation_id          String
  booking_date            DateTime          @db.Date
  arrival_date            DateTime          @db.Date
  departure_date          DateTime          @db.Date
  rooms                   Int
  revenue                 Decimal           @db.Decimal
  status                  ReservationStatus
  cancel_date             DateTime?         @db.Date
  loaded_at               DateTime          @default(now())
  book_time               DateTime?         @db.Timestamptz(6)
  cancel_reason           String?
  cancel_source           String?
  cancel_time             DateTime?         @db.Timestamptz(6)
  last_modified_time      DateTime?         @db.Timestamptz(6)
  reservation_id_norm     String?
  room_code               String?           // RoomTypeCode from XML (SBD/STW/SGD/STRP...)
  room_code_norm          String?
  company_name            String?           // ClientName from XML = Source/Account (OTA/Agent)
  // --- GM Reporting Dimensions (v2) ---
  guest_group_name        String?           // GroupName from XML = guest name / group code
  salesperson_name        String?           // SlsName from XML Group Header = sales rep
  net_rate_per_room_night Decimal?          @db.Decimal // GNetRate from XML
  pax                     Int?              // NumPax from XML
  room_nights             Int?              // Rnight from XML (rooms × nights)
  nights                  Int?              // @night from XML or departure - arrival
  account_name_norm       String?           // Normalized: UPPER(TRIM(company_name))
  segment                 String?           // Inferred: OTA / AGENT / DIRECT / UNKNOWN
  create_clerk            String?           // createclerk from XML
  matched_cancellations   CancellationRaw[] @relation("MatchedCancellation")
  hotel                   Hotel             @relation(fields: [hotel_id], references: [hotel_id])
  job                     ImportJob         @relation(fields: [job_id], references: [job_id])

  @@unique([hotel_id, reservation_id, job_id, room_code], name: "uq_res_job_room")
  @@index([hotel_id, reservation_id], map: "idx_res_raw_dedup")
  @@index([hotel_id, reservation_id_norm, arrival_date, room_code_norm], map: "idx_res_raw_match1")
  @@index([hotel_id, reservation_id_norm, arrival_date], map: "idx_res_raw_match2")
  @@index([hotel_id, book_time, cancel_time, arrival_date, departure_date], map: "idx_res_raw_otb")
  @@index([hotel_id, segment, arrival_date], map: "idx_res_raw_segment")
  @@index([hotel_id, account_name_norm, arrival_date], map: "idx_res_raw_account")
  @@index([hotel_id, room_code, arrival_date], map: "idx_res_raw_roomcode")
  @@index([hotel_id, book_time, arrival_date], map: "idx_res_raw_booktime")
  @@map("reservations_raw")
}

model DailyOTB {
  hotel_id    String   @db.Uuid
  as_of_date  DateTime @db.Date
  stay_date   DateTime @db.Date
  rooms_otb   Int
  revenue_otb Decimal  @db.Decimal
  created_at  DateTime @default(now())
  hotel       Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@index([hotel_id, as_of_date], map: "idx_otb_as_of")
  @@index([hotel_id, stay_date], map: "idx_otb_stay")
  @@map("daily_otb")
}

model FeaturesDaily {
  hotel_id         String   @db.Uuid
  as_of_date       DateTime @db.Date
  stay_date        DateTime @db.Date
  rooms_otb        Int?     // Rooms on the books (from DailyOTB snapshot)
  dow              Int?
  is_weekend       Boolean?
  month            Int?
  // Revenue fields (D16: P0)
  revenue_otb      Decimal? @db.Decimal
  stly_revenue_otb Decimal? @db.Decimal
  // Pickup fields
  pickup_t30       Int?
  pickup_t7        Int?
  pickup_t3        Int?
  pace_vs_ly       Float?
  remaining_supply Int?
  // Cancel Forecast (Phase 02)
  expected_cxl     Int?     // Expected cancellation rooms
  net_remaining    Int?     // remaining_supply + expected_cxl (projected available)
  cxl_rate_used    Float?   // Cancel rate applied
  cxl_confidence   String?  // 'high' | 'medium' | 'low' | 'fallback'
  created_at       DateTime @default(now())
  pickup_t15       Int?
  pickup_t5        Int?
  stly_is_approx   Boolean?
  pickup_source    Json?
  hotel            Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@index([hotel_id, stay_date, as_of_date], map: "idx_features_stay_asof")
  @@map("features_daily")
}


model DemandForecast {
  hotel_id         String   @db.Uuid
  as_of_date       DateTime @db.Date
  stay_date        DateTime @db.Date
  remaining_demand Int?
  model_version    String?
  confidence       String?  // 'high' | 'medium' | 'low' | 'fallback'
  forecast_trace   Json?    // Array of trace strings for debugging
  created_at       DateTime @default(now())
  hotel            Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@map("demand_forecast")
}

model PriceRecommendations {
  hotel_id          String   @db.Uuid
  as_of_date        DateTime @db.Date
  stay_date         DateTime @db.Date
  current_price     Decimal? @db.Decimal
  recommended_price Decimal? @db.Decimal
  expected_revenue  Decimal? @db.Decimal
  uplift_pct        Float?
  explanation       String?
  created_at        DateTime @default(now())
  hotel             Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@unique([hotel_id, stay_date, as_of_date], name: "unique_rec")
  @@map("price_recommendations")
}

model PricingDecision {
  decision_id  String         @id @default(uuid()) @db.Uuid
  hotel_id     String         @db.Uuid
  user_id      String         @db.Uuid
  as_of_date   DateTime       @db.Date
  stay_date    DateTime       @db.Date
  action       DecisionAction
  system_price Decimal?       @db.Decimal
  final_price  Decimal?       @db.Decimal
  reason       String?
  decided_at   DateTime       @default(now())
  hotel        Hotel          @relation(fields: [hotel_id], references: [hotel_id])
  user         User           @relation(fields: [user_id], references: [id])

  @@index([hotel_id])
  @@index([user_id])
  @@map("pricing_decisions")
}

model CancellationRaw {
  id                     String           @id @default(uuid()) @db.Uuid
  hotel_id               String           @db.Uuid
  job_id                 String           @db.Uuid
  folio_num              String
  arrival_date           DateTime         @db.Date
  cancel_time            DateTime         @db.Timestamptz(6)
  as_of_date             DateTime         @db.Date
  nights                 Int
  rate_amount            Decimal          @db.Decimal(12, 2)
  total_revenue          Decimal          @db.Decimal(12, 2)
  channel                String?
  sale_group             String?
  room_type              String?
  room_code              String?
  guest_name             String?
  created_at             DateTime         @default(now())
  folio_num_norm         String?
  match_notes            String?
  match_status           String?
  matched_at             DateTime?        @db.Timestamptz(6)
  matched_reservation_id String?          @db.Uuid
  room_code_norm         String?
  hotel                  Hotel            @relation(fields: [hotel_id], references: [hotel_id])
  job                    ImportJob        @relation(fields: [job_id], references: [job_id])
  matched_reservation    ReservationsRaw? @relation("MatchedCancellation", fields: [matched_reservation_id], references: [id])

  @@unique([hotel_id, folio_num_norm, arrival_date, cancel_time], name: "uq_cancel_event")
  @@index([hotel_id, as_of_date], map: "idx_cancel_as_of")
  @@index([hotel_id, cancel_time], map: "idx_cancel_time")
  @@index([hotel_id, arrival_date], map: "idx_cancel_arrival")
  @@index([hotel_id, match_status], map: "idx_cancel_match_status")
  @@map("cancellations_raw")
}

model RoomType {
  id          String   @id @default(cuid())
  hotel_id    String   @db.Uuid
  name        String
  description String?
  net_price   Float
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  hotel            Hotel           @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)
  season_net_rates SeasonNetRate[]

  @@unique([hotel_id, name], name: "uq_room_type_name")
  @@index([hotel_id])
  @@map("room_types")
}

model OTAChannel {
  id         String             @id @default(cuid())
  hotel_id   String             @db.Uuid
  name       String
  code       String
  calc_type  CalcType           @default(PROGRESSIVE)
  commission Float
  is_active  Boolean            @default(true)
  created_at DateTime           @default(now())
  updated_at DateTime           @updatedAt
  campaigns  CampaignInstance[]
  hotel      Hotel              @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, code], name: "uq_ota_channel_code")
  @@index([hotel_id])
  @@map("ota_channels")
}

model PromotionCatalog {
  id                      String             @id
  vendor                  String
  name                    String
  description             String?
  group_type              PromotionGroup
  sub_category            String?
  default_pct             Float?
  allow_stack             Boolean            @default(true)
  max_one_in_group        Boolean            @default(false)
  max_one_per_subcategory Boolean            @default(false)
  instances               CampaignInstance[]

  @@index([vendor, group_type])
  @@map("promotion_catalog")
}

model CampaignInstance {
  id             String           @id @default(cuid())
  hotel_id       String           @db.Uuid
  ota_channel_id String
  promo_id       String
  discount_pct   Float
  is_active      Boolean          @default(true)
  start_date     DateTime?        @db.Date
  end_date       DateTime?        @db.Date
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  ota_channel    OTAChannel       @relation(fields: [ota_channel_id], references: [id], onDelete: Cascade)
  promo          PromotionCatalog @relation(fields: [promo_id], references: [id])

  @@index([hotel_id, ota_channel_id])
  @@index([promo_id])
  @@map("campaign_instances")
}

model PricingSetting {
  id               String   @id @default(cuid())
  hotel_id         String   @unique @db.Uuid
  currency         String   @default("VND")
  rounding_rule    String   @default("CEIL_1000")
  max_discount_cap Float    @default(80)
  // D31: Step change limit (0.2 = 20%)
  max_step_change_pct Float  @default(0.2)
  // D25: Manual override bypasses guardrails by default
  enforce_guardrails_on_manual Boolean @default(false)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  hotel            Hotel    @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@map("pricing_settings")
}


enum JobStatus {
  pending
  processing
  completed
  failed
}

enum ReservationStatus {
  booked
  cancelled
}

enum DecisionAction {
  accept
  override
}

enum ImportType {
  RESERVATION
  CANCELLATION
}

enum CalcType {
  PROGRESSIVE
  ADDITIVE
  SINGLE_DISCOUNT
}

enum PromotionGroup {
  SEASONAL
  ESSENTIAL
  TARGETED
  GENIUS
  PORTFOLIO
  CAMPAIGN
}

enum UserRole {
  super_admin
  hotel_admin
  manager
  viewer
}

// ════════════════════════════════════════════════════════════════════
// Onboarding — Invite & Event Tracking
// ════════════════════════════════════════════════════════════════════

model HotelInvite {
  invite_id  String    @id @default(uuid()) @db.Uuid
  hotel_id   String    @db.Uuid
  token_hash String    @unique
  short_code String?
  email      String?
  role       UserRole  @default(viewer)
  max_uses   Int       @default(5)
  used_count Int       @default(0)
  status     String    @default("active")
  is_default Boolean   @default(false)
  expires_at DateTime
  created_by String    @db.Uuid
  created_at DateTime  @default(now())
  used_by    String?   @db.Uuid
  used_at    DateTime?
  hotel      Hotel     @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, short_code])
  @@index([hotel_id])
  @@map("hotel_invites")
}

model ProductEvent {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  hotel_id   String?  @db.Uuid
  event_type String
  event_data Json?
  session_id String?
  created_at DateTime @default(now())

  @@unique([hotel_id, event_type, session_id])
  @@index([user_id, event_type, created_at])
  @@index([hotel_id, event_type, created_at])
  @@map("product_events")
}

// Rate limiting for Vercel serverless (no in-memory)
model RateLimitHit {
  id         String   @id @default(uuid()) @db.Uuid
  ip         String
  key        String   // e.g., "invite_redeem", "export"
  created_at DateTime @default(now())

  @@index([ip, key, created_at])
  @@map("rate_limit_hits")
}

// ════════════════════════════════════════════════════════════════════
// Commercialization — Enums & Model
// ════════════════════════════════════════════════════════════════════

enum PlanTier {
  STANDARD
  SUPERIOR
  DELUXE
  SUITE
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  PAST_DUE
  CANCELLED
  REFUNDED
}

enum RoomBand {
  R30   // ≤ 30 rooms
  R80   // 31–80 rooms
  R150  // 81–150 rooms
  R300P // 151–300+ rooms
}

// ── Payment Gateway Enums ───────────────────────────────────────────

enum PaymentGateway {
  SEPAY
  PAYPAL
  ZALO_MANUAL
}

enum PricingConfigType {
  BASE_PRICE
  BAND_MULTIPLIER
  TERM_DISCOUNT
}

enum PricingScope {
  GLOBAL
  HOTEL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ── Payment Transaction Model ───────────────────────────────────────

model PaymentTransaction {
  id                      String          @id @default(uuid()) @db.Uuid

  // Ownership (multi-tenancy)
  hotel_id                String?         @db.Uuid   // Nullable: demo users pay before creating hotel
  user_id                 String          @db.Uuid

  // Payment info
  gateway                 PaymentGateway
  order_id                String          @unique      // RMS-{hotelId.slice(0,8)}-{timestamp}
  gateway_transaction_id  String?                      // SePay id / PayPal subscription_id
  amount                  Decimal         @db.Decimal(12, 2)
  currency                String          @default("VND")  // VND or USD
  status                  PaymentStatus   @default(PENDING)

  // What was purchased (snapshot at time of purchase)
  purchased_tier          PlanTier?
  purchased_room_band     RoomBand?

  // Timestamps (P1 — operational debugging)
  expires_at              DateTime?       // PENDING auto-expire (created_at + 30min)
  completed_at            DateTime?       // When status changed to COMPLETED
  failed_at               DateTime?       // When status changed to FAILED
  failed_reason           String?         // Why it failed (amount_mismatch, timeout, etc.)

  // Gateway event tracking (P1 — reconciliation)
  gateway_event_id        String?         // PayPal event.id
  provider_customer_ref   String?         // PayPal payer email/id

  // Billing term (snapshot at time of purchase)
  billing_cycle           String?         // 'monthly' | '3-months'
  term_months             Int?            // 1 or 3

  // Meta
  description             String?
  raw_payload             Json?           // Webhook payload gốc
  created_at              DateTime        @default(now())

  // Relations
  hotel                   Hotel?          @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  // Indexes
  @@unique([gateway, gateway_transaction_id])  // Chống webhook duplicate
  @@index([hotel_id])
  @@index([user_id])                           // Fast orphan payment lookup
  @@index([status])
  @@index([status, expires_at])                // P1: fast query for PENDING auto-expire
  @@map("payment_transactions")
}

// ── Subscription Model ──────────────────────────────────────────────

model Subscription {
  id                        String             @id @default(uuid()) @db.Uuid
  hotel_id                  String?            @unique @db.Uuid  // @deprecated — use org_id
  plan                      PlanTier           @default(STANDARD)
  status                    SubscriptionStatus @default(ACTIVE)

  // Organization ownership (Cách 2)
  org_id                    String?            @unique @db.Uuid
  organization              Organization?      @relation(fields: [org_id], references: [id], onDelete: Cascade)

  // Room Band Pricing
  room_band                 RoomBand           @default(R30)
  capacity_snapshot         Int                @default(0)
  price_multiplier          Float              @default(1.0)

  // External payment — single source of truth
  external_provider         String?            // 'SEPAY' | 'PAYPAL' | 'ZALO_MANUAL'
  external_customer_id      String?
  external_subscription_id  String?            // PayPal subscription ID
  current_period_start      DateTime?
  current_period_end        DateTime?

  // Feature Limits (Admin can override per hotel)
  max_users                 Int                @default(1)
  max_properties            Int                @default(1)
  max_imports_month         Int                @default(3)
  max_exports_day           Int                @default(1)
  max_export_rows           Int                @default(30)
  included_rate_shops_month Int                @default(0)
  data_retention_months     Int                @default(6)

  created_at                DateTime           @default(now())
  updated_at                DateTime           @updatedAt

  // PLG — Trial fields
  trial_ends_at             DateTime?
  trial_bonus_granted       Boolean            @default(false)

  hotel                     Hotel?             @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@map("subscriptions")
}

// ════════════════════════════════════════════════════════════════════
// Organization — Tenant Model
// ════════════════════════════════════════════════════════════════════

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

model Organization {
  id           String        @id @default(uuid()) @db.Uuid
  name         String
  slug         String?
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt

  hotels       Hotel[]
  members      OrgMember[]
  subscription Subscription?

  @@map("organizations")
}

model OrgMember {
  id           String       @id @default(uuid()) @db.Uuid
  org_id       String       @db.Uuid
  user_id      String       @db.Uuid
  role         OrgRole      @default(MEMBER)
  created_at   DateTime     @default(now())

  organization Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([org_id, user_id])
  @@index([user_id])
  @@map("org_members")
}

// ════════════════════════════════════════════════════════════════════
// PLG — Usage Tracking
// ════════════════════════════════════════════════════════════════════

model UsageMonthly {
  id             String    @id @default(uuid()) @db.Uuid
  hotel_id       String    @db.Uuid
  month          DateTime  // First day of month
  imports        Int       @default(0)
  playbook_views Int       @default(0)
  last_rollup_at DateTime?
  hotel          Hotel     @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, month])
  @@map("usage_monthly")
}

model UsageDaily {
  id       String   @id @default(uuid()) @db.Uuid
  hotel_id String   @db.Uuid
  date     DateTime @db.Date
  exports  Int      @default(0)
  hotel    Hotel    @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, date])
  @@map("usage_daily")
}

// ════════════════════════════════════════════════════════════════════
// PLG — Reseller + Promo (S2)
// ════════════════════════════════════════════════════════════════════

enum AttachMethod {
  LINK         // ?ref=RES123 → cookie 30d
  COUPON_CODE  // Promo code with reseller_id
  MANUAL       // Admin manual attribution
}

enum AttributionStatus {
  ACTIVE
  CHURNED
  GRACE_PERIOD
}

enum TemplateType {
  GLOBAL
  RESELLER
  CAMPAIGN
}

enum RedemptionStatus {
  ACTIVE
  VOIDED
  EXPIRED
}

model Reseller {
  id             String               @id @default(uuid()) @db.Uuid
  name           String
  email          String               @unique
  phone          String?
  ref_code       String               @unique // e.g. RES123
  is_active      Boolean              @default(true)
  created_at     DateTime             @default(now())
  updated_at     DateTime             @updatedAt
  attributions   ResellerAttribution[]
  contracts      ResellerContract[]
  promo_codes    PromoCode[]

  @@map("resellers")
}

model ResellerAttribution {
  id              String            @id @default(uuid()) @db.Uuid
  hotel_id        String            @db.Uuid
  reseller_id     String            @db.Uuid
  attach_method   AttachMethod
  status          AttributionStatus @default(ACTIVE)
  effective_from  DateTime          @default(now())
  effective_to    DateTime?         // NULL = still active
  ended_reason    String?           // e.g. "churned", "manual_close"
  created_at      DateTime          @default(now())
  hotel           Hotel             @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)
  reseller        Reseller          @relation(fields: [reseller_id], references: [id])

  @@index([hotel_id])
  @@index([reseller_id])
  @@map("reseller_attributions")
}

model ResellerContract {
  id              String   @id @default(uuid()) @db.Uuid
  reseller_id     String   @db.Uuid
  commission_rate Decimal  @db.Decimal(5, 4) // 0.2000 = 20%
  effective_from  DateTime @default(now())
  effective_to    DateTime?
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  reseller        Reseller @relation(fields: [reseller_id], references: [id])

  @@index([reseller_id])
  @@map("reseller_contracts")
}

model PromoCode {
  id                   String           @id @default(uuid()) @db.Uuid
  code                 String           @unique
  template_type        TemplateType
  percent_off          Decimal          @db.Decimal(5, 2) // e.g. 10.00 = 10%
  description          String?
  reseller_id          String?          @db.Uuid
  plan_eligible        PlanTier[]       // which plans can use this code
  is_active            Boolean          @default(true)
  max_redemptions      Int?             // NULL = unlimited
  current_redemptions  Int              @default(0)
  starts_at            DateTime         @default(now())
  expires_at           DateTime?
  created_at           DateTime         @default(now())
  reseller             Reseller?        @relation(fields: [reseller_id], references: [id])
  redemptions          PromoRedemption[]

  @@map("promo_codes")
}

model PromoRedemption {
  id              String           @id @default(uuid()) @db.Uuid
  promo_code_id   String           @db.Uuid
  hotel_id        String           @db.Uuid
  status          RedemptionStatus @default(ACTIVE)
  redeemed_at     DateTime         @default(now())
  voided_at       DateTime?
  void_reason     String?
  promo_code      PromoCode        @relation(fields: [promo_code_id], references: [id])
  hotel           Hotel            @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@index([hotel_id])
  @@index([promo_code_id])
  @@map("promo_redemptions")
}

// ════════════════════════════════════════════════════════════════════
// PLG — Billing + Commission + Payout + Audit + Portal (S3)
// ════════════════════════════════════════════════════════════════════

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum CommissionType {
  EARNED
  REVERSED
  ADJUSTED
}

enum PayoutStatus {
  DRAFT
  APPROVED
  PAID
  REJECTED
}

enum AuditAction {
  PROMO_REDEEMED
  PROMO_VOIDED
  COMMISSION_EARNED
  COMMISSION_REVERSED
  PAYOUT_APPROVED
  PAYOUT_PAID
  PAYOUT_REJECTED
  SUBSCRIPTION_CHANGED
  TRIAL_STARTED
  TRIAL_BONUS_GRANTED
  ATTRIBUTION_CREATED
  ATTRIBUTION_CLOSED
  ADMIN_OVERRIDE
  // Pricing Config
  PRICING_CONFIG_CREATED
  PRICING_CONFIG_UPDATED
  PRICING_CONFIG_DELETED
  SETTING_CHANGED
}

model Invoice {
  id                String        @id @default(uuid()) @db.Uuid
  hotel_id          String        @db.Uuid
  invoice_number    String        @unique
  amount            Decimal       @db.Decimal(12, 2)
  currency          String        @default("VND")
  status            InvoiceStatus @default(DRAFT)
  period_start      DateTime
  period_end        DateTime
  plan              PlanTier
  promo_code_id     String?       @db.Uuid
  discount_percent  Decimal?      @db.Decimal(5, 2)
  net_amount        Decimal?      @db.Decimal(12, 2) // after discount
  paid_at           DateTime?
  due_date          DateTime?
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  hotel             Hotel         @relation(fields: [hotel_id], references: [hotel_id])
  receipts          PaymentReceipt[]
  commission_ledger CommissionLedger[]

  @@index([hotel_id])
  @@index([status])
  @@map("invoices")
}

model PaymentReceipt {
  id            String  @id @default(uuid()) @db.Uuid
  invoice_id    String  @db.Uuid
  amount        Decimal @db.Decimal(12, 2)
  method        String  // "bank_transfer", "stripe", "sepay"
  reference     String? // transaction reference
  received_at   DateTime @default(now())
  invoice       Invoice @relation(fields: [invoice_id], references: [id])

  @@index([invoice_id])
  @@map("payment_receipts")
}

model CommissionLedger {
  id              String         @id @default(uuid()) @db.Uuid
  reseller_id     String         @db.Uuid
  hotel_id        String         @db.Uuid
  invoice_id      String?        @db.Uuid
  type            CommissionType
  amount          Decimal        @db.Decimal(12, 2) // positive=earned, negative=reversed
  rate            Decimal        @db.Decimal(5, 4)
  description     String?
  payout_item_id  String?        @db.Uuid
  created_at      DateTime       @default(now())
  invoice         Invoice?       @relation(fields: [invoice_id], references: [id])

  @@index([reseller_id, created_at])
  @@index([payout_item_id])
  @@map("commission_ledger")
}

model PayoutRun {
  id           String       @id @default(uuid()) @db.Uuid
  period       String       // "2026-02"
  status       PayoutStatus @default(DRAFT)
  approved_by  String?      @db.Uuid
  approved_at  DateTime?
  paid_at      DateTime?
  created_at   DateTime     @default(now())
  items        PayoutItem[]

  @@map("payout_runs")
}

model PayoutItem {
  id           String     @id @default(uuid()) @db.Uuid
  payout_run_id String    @db.Uuid
  reseller_id  String     @db.Uuid
  amount       Decimal    @db.Decimal(12, 2)
  status       PayoutStatus @default(DRAFT)
  statement_url String?
  created_at   DateTime   @default(now())
  payout_run   PayoutRun  @relation(fields: [payout_run_id], references: [id])

  @@index([reseller_id])
  @@map("payout_items")
}

model AuditLog {
  id         String      @id @default(uuid()) @db.Uuid
  actor_id   String?     @db.Uuid
  action     AuditAction
  entity_type String     // "promo_code", "commission", etc.
  entity_id  String?     @db.Uuid
  hotel_id   String?     @db.Uuid
  metadata   Json?
  created_at DateTime    @default(now())

  @@index([action, created_at])
  @@index([hotel_id, created_at])
  @@index([actor_id])
  @@map("audit_logs")
}

model ResellerToken {
  id          String   @id @default(uuid()) @db.Uuid
  reseller_id String   @db.Uuid
  token       String   @unique
  expires_at  DateTime
  used_at     DateTime?
  created_at  DateTime @default(now())

  @@index([reseller_id])
  @@map("reseller_tokens")
}

// ════════════════════════════════════════════════════════════════════
// Rate Shopper — Enums (8 total)
// ════════════════════════════════════════════════════════════════════

enum RateShopCacheStatus {
  FRESH
  STALE
  EXPIRED
  REFRESHING
  FAILED
}

enum RateShopAvailabilityStatus {
  AVAILABLE
  SOLD_OUT
  NO_RATE
}

enum RateShopDataConfidence {
  HIGH
  MED
  LOW
}

enum RateShopRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  COALESCED
}

enum RateShopRecommendationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum RateShopDemandStrength {
  WEAK
  NORMAL
  STRONG
}

enum RateShopQueryType {
  PROPERTY_DETAILS
  LISTING
}

enum RateShopProvider {
  SERPAPI
}

// ════════════════════════════════════════════════════════════════════
// Rate Shopper — Models
// ════════════════════════════════════════════════════════════════════

model Competitor {
  id                     String   @id @default(uuid()) @db.Uuid
  hotel_id               String   @db.Uuid
  name                   String
  google_place_id        String?
  serpapi_property_token String?
  address                String?
  star_rating            Int?
  tier                   Int      @default(1) // 1=primary, 2=secondary
  is_active              Boolean  @default(true)
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  hotel Hotel            @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)
  rates CompetitorRate[]

  @@unique([hotel_id, serpapi_property_token])
  @@index([hotel_id])
  @@index([is_active, serpapi_property_token])
  @@map("competitors")
}

model RateShopCache {
  id               String            @id @default(uuid()) @db.Uuid
  cache_key        String            @unique
  query_type       RateShopQueryType @default(PROPERTY_DETAILS)
  provider         RateShopProvider  @default(SERPAPI)
  canonical_params Json

  // ---- Materialized columns (indexed, from canonical_params) ----
  property_token String?
  check_in_date  String? @db.VarChar(10) // YYYY-MM-DD string
  check_out_date String? @db.VarChar(10)
  adults         Int?
  length_of_stay Int?
  currency       String? @db.VarChar(5)
  offset_days    Int?

  // ---- Cache state ----
  status              RateShopCacheStatus @default(STALE)
  raw_response        Json?
  raw_response_ref    String? // object storage signed URL
  fetched_at          DateTime?
  expires_at          DateTime            @default(now())
  stale_until         DateTime            @default(now())
  is_vendor_cache_hit Boolean?

  // ---- Lock & Backoff ----
  refresh_lock_until    DateTime?
  refreshing_request_id String?   @db.Uuid
  fail_streak           Int       @default(0)
  backoff_until         DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  rates    CompetitorRate[]
  requests RateShopRequest[]

  @@index([expires_at])
  @@index([status])
  @@index([query_type, check_in_date])
  @@index([property_token, check_in_date])
  @@index([offset_days, expires_at])
  @@index([status, backoff_until, expires_at])
  @@index([check_out_date])
  @@map("rate_shop_cache")
}

model RateShopRequest {
  id             String                @id @default(uuid()) @db.Uuid
  hotel_id       String                @db.Uuid
  cache_key      String
  check_in_date  String                @db.VarChar(10)
  check_out_date String?               @db.VarChar(10)
  adults         Int                   @default(2)
  status         RateShopRequestStatus @default(PENDING)
  requested_at   DateTime              @default(now())
  requested_date DateTime              @db.Date

  provider                RateShopProvider @default(SERPAPI)
  estimated_searches      Int              @default(1)
  credit_consumed         Boolean          @default(false)
  is_vendor_cache_hit     Boolean?
  coalesced_to_request_id String?          @db.Uuid

  query_type    RateShopQueryType?
  http_status   Int?
  error_message String?

  cache RateShopCache @relation(fields: [cache_key], references: [cache_key], onDelete: Restrict)
  hotel Hotel         @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@index([hotel_id, check_in_date])
  @@index([cache_key])
  @@index([hotel_id, requested_date])
  @@map("rate_shop_requests")
}

model CompetitorRate {
  id            String   @id @default(uuid()) @db.Uuid
  competitor_id String   @db.Uuid
  cache_id      String   @db.Uuid
  check_in_date String   @db.VarChar(10)
  source        String
  scraped_at    DateTime @default(now())

  availability_status RateShopAvailabilityStatus @default(AVAILABLE)
  data_confidence     RateShopDataConfidence     @default(MED)

  total_rate_lowest         Decimal? @db.Decimal(14, 0)
  total_rate_before_tax     Decimal? @db.Decimal(14, 0)
  rate_per_night_lowest     Decimal? @db.Decimal(14, 0)
  rate_per_night_before_tax Decimal? @db.Decimal(14, 0)
  representative_price      Decimal? @db.Decimal(14, 0)
  price_source_level        Int?

  is_official    Boolean @default(false)
  raw_price_json Json?

  competitor Competitor    @relation(fields: [competitor_id], references: [id], onDelete: Cascade)
  cache      RateShopCache @relation(fields: [cache_id], references: [id], onDelete: Cascade)

  @@index([competitor_id, check_in_date])
  @@index([cache_id])
  @@index([check_in_date])
  @@map("competitor_rates")
}

model MarketSnapshot {
  id             String @id @default(uuid()) @db.Uuid
  hotel_id       String @db.Uuid
  check_in_date  String @db.VarChar(10)
  length_of_stay Int    @default(1)
  adults         Int    @default(2)
  snapshot_date  String @db.VarChar(10)

  my_rate              Decimal? @db.Decimal(14, 0)
  comp_min             Decimal? @db.Decimal(14, 0)
  comp_max             Decimal? @db.Decimal(14, 0)
  comp_avg             Decimal? @db.Decimal(14, 0)
  comp_median          Decimal? @db.Decimal(14, 0)
  comp_available_count Int      @default(0)
  sold_out_count       Int      @default(0)
  no_rate_count        Int      @default(0)

  price_index Decimal? @db.Decimal(6, 4)
  gap_pct     Decimal? @db.Decimal(6, 4)
  delta_pct   Decimal? @db.Decimal(6, 4)

  market_confidence RateShopDataConfidence @default(MED)
  demand_strength   RateShopDemandStrength @default(NORMAL)
  recommended_rate  Decimal?               @db.Decimal(14, 0)
  reason_codes      String[]

  is_latest  Boolean  @default(true)
  created_at DateTime @default(now())

  hotel Hotel @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, check_in_date, length_of_stay, adults, snapshot_date])
  @@index([hotel_id, check_in_date, is_latest])
  @@index([is_latest])
  @@map("market_snapshots")
}

model RateShopRecommendation {
  id            String @id @default(uuid()) @db.Uuid
  hotel_id      String @db.Uuid
  check_in_date String @db.VarChar(10)
  snapshot_date String @db.VarChar(10)

  current_rate     Decimal?                     @db.Decimal(14, 0)
  recommended_rate Decimal?                     @db.Decimal(14, 0)
  delta_pct        Decimal?                     @db.Decimal(6, 4)
  reason_codes     String[]
  confidence       RateShopDataConfidence       @default(MED)
  status           RateShopRecommendationStatus @default(PENDING)

  created_at DateTime @default(now())

  hotel Hotel @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@index([hotel_id, check_in_date])
  @@index([hotel_id, status])
  @@map("rate_shop_recommendations")
}

model RateShopUsageDaily {
  usage_date    String   @db.VarChar(10) // YYYY-MM-DD (getVNDate)
  searches_used Int      @default(0)
  budget_limit  Int      @default(500)
  safe_mode_on  Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@id([usage_date])
  @@map("rate_shop_usage_daily")
}

model RateShopUsageTenantMonthly {
  hotel_id      String   @db.Uuid
  billing_month String   @db.VarChar(7) // YYYY-MM (getVNMonth)
  searches_used Int      @default(0)
  quota_cap     Int      @default(200)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  hotel Hotel @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@id([hotel_id, billing_month])
  @@map("rate_shop_usage_tenant_monthly")
}

// ════════════════════════════════════════════════════════════════════
// Dynamic Pricing by OCC — Season & Occupancy Tier Configuration
// ════════════════════════════════════════════════════════════════════

model SeasonConfig {
  id          String   @id @default(uuid()) @db.Uuid
  hotel_id    String   @db.Uuid
  name        String   // "Normal Season", "High Season", "Holiday"
  code        String   // "NORMAL", "HIGH", "HOLIDAY"
  date_ranges Json     // [{"start":"2026-05-01","end":"2026-10-31"}]
  priority    Int      @default(0) // Holiday(3) > High(2) > Normal(1)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  hotel       Hotel    @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)
  net_rates   SeasonNetRate[]

  @@unique([hotel_id, code])
  @@index([hotel_id])
  @@map("season_configs")
}

model OccTierConfig {
  id              String   @id @default(uuid()) @db.Uuid
  hotel_id        String   @db.Uuid
  tier_index      Int      // 0, 1, 2, 3
  label           String   // "0-35%", "35-65%", "65-85%", ">85%"
  occ_min         Float    // 0–1 decimal (e.g., 0.0, 0.35, 0.65, 0.85)
  occ_max         Float    // 0–1 decimal (e.g., 0.35, 0.65, 0.85, 1.0)
  multiplier      Float    // 1.0, 1.10, 1.20, 1.30 — used when adjustment_type = MULTIPLY
  adjustment_type String   @default("MULTIPLY") // "MULTIPLY" | "FIXED"
  fixed_amount    Float    @default(0)           // VND amount — used when adjustment_type = FIXED
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  hotel       Hotel    @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, tier_index])
  @@index([hotel_id])
  @@map("occ_tier_configs")
}

model SeasonNetRate {
  id              String       @id @default(uuid()) @db.Uuid
  hotel_id        String       @db.Uuid
  season_id       String       @db.Uuid
  room_type_id    String       // cuid — matches RoomType.id (NOT uuid)
  net_rate        Decimal      @db.Decimal(12, 2)
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  season          SeasonConfig @relation(fields: [season_id], references: [id], onDelete: Cascade)
  room_type       RoomType     @relation(fields: [room_type_id], references: [id], onDelete: Cascade)

  @@unique([season_id, room_type_id])
  @@index([hotel_id])
  @@map("season_net_rates")
}

// ━━━━ Analytics Layer P1: Cancel Rate Statistics ━━━━
model CancelRateStats {
  id                  String   @id @default(uuid()) @db.Uuid
  hotel_id            String   @db.Uuid
  booking_lead_bucket String   // '0-3d', '4-7d', '8-14d', '15-30d', '31-60d', '61d+'
  dow                 Int      // 0=Sun, 1=Mon, ... 6=Sat
  season_label        String   // 'peak', 'shoulder', 'off_peak', 'default'
  segment             String   // 'OTA', 'AGENT', 'DIRECT', 'UNKNOWN', 'ALL'
  cancel_rate         Float    // 0.0 - 0.8 (smoothed + clamped)
  raw_rate            Float    // before Bayesian smoothing
  total_rooms         Int      // SUM(rooms) — stay_date-exploded grain
  cancelled_rooms     Int      // SUM(cancelled rooms)
  confidence          String   // 'high', 'medium', 'low'
  mapping_version     String   @default("v1")
  // Training window metadata
  window_start        DateTime @db.Date
  window_end          DateTime @db.Date
  data_row_count      Int
  unknown_pct         Float    @default(0)
  computed_at         DateTime @default(now())

  hotel Hotel @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, booking_lead_bucket, dow, season_label, segment])
  @@index([hotel_id])
  @@map("cancel_rate_stats")
}

// ════════════════════════════════════════════════════════════════════
// Dynamic Pricing Config
// ════════════════════════════════════════════════════════════════════

model PricingConfig {
  id             String            @id @default(cuid())
  config_type    PricingConfigType
  tier           PlanTier?         // only for BASE_PRICE
  room_band      RoomBand?         // only for BAND_MULTIPLIER
  term_months    Int?              // only for TERM_DISCOUNT (3, 6, 12)

  // ── Values (no Float for money) ──
  amount_vnd     Int?              // VND (dong), for BASE_PRICE
  percent        Int?              // 0–99, for TERM_DISCOUNT
  multiplier     Decimal?          @db.Decimal(6, 4) // for BAND_MULTIPLIER

  // ── Time-based effectiveness ──
  effective_from DateTime          @default(now())
  effective_to   DateTime?         // null = indefinite

  // ── Scope & Priority ──
  scope          PricingScope      @default(GLOBAL)
  hotel_id       String?           @db.Uuid
  priority       Int               @default(0) // higher = wins

  // ── Metadata ──
  label          String?
  created_at     DateTime          @default(now())
  updated_at     DateTime          @updatedAt
  updated_by     String?

  hotel          Hotel?            @relation(fields: [hotel_id], references: [hotel_id])

  @@index([config_type, effective_from, effective_to])
  @@index([scope, hotel_id, config_type, tier, room_band, term_months, effective_from])
  @@map("pricing_configs")
}

model PricingConfigAudit {
  id             String      @id @default(cuid())
  config_id      String
  action         AuditAction
  field_changed  String?     // e.g. "amount_vnd"
  old_value      String?
  new_value      String?
  changed_by     String
  changed_at     DateTime    @default(now())
  note           String?

  @@index([config_id])
  @@index([changed_by])
  @@map("pricing_config_audit")
}

// ════════════════════════════════════════════════════════════════════
// System Settings (global key-value store)
// ════════════════════════════════════════════════════════════════════
model SystemSetting {
  key        String   @id          // e.g. "paypal_mode"
  value      String                // e.g. "one-time" | "subscription"
  updated_by String?
  updated_at DateTime @updatedAt

  @@map("system_settings")
}
