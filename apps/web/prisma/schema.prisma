generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Hotel {
  hotel_id              String                 @id @default(uuid()) @db.Uuid
  name                  String
  timezone              String                 @default("Asia/Ho_Chi_Minh")
  capacity              Int
  currency              String                 @default("VND")
  created_at            DateTime               @default(now())
  default_base_rate     Decimal?               @db.Decimal(12, 2)
  max_rate              Decimal?               @db.Decimal(12, 2)
  min_rate              Decimal?               @db.Decimal(12, 2)
  fiscal_start_day      Int                    @default(1)
  ladder_steps          String?
  company_email         String?
  cancellations_raw     CancellationRaw[]
  daily_otb             DailyOTB[]
  demand_forecast       DemandForecast[]
  features_daily        FeaturesDaily[]
  hotel_users           HotelUser[]
  import_jobs           ImportJob[]
  ota_channels          OTAChannel[]
  price_recommendations PriceRecommendations[]
  pricing_decisions     PricingDecision[]
  pricing_setting       PricingSetting?
  reservations_raw      ReservationsRaw[]
  room_types            RoomType[]
  users                 User[]

  // Rate Shopper relations
  competitors               Competitor[]
  rate_shop_requests        RateShopRequest[]
  market_snapshots          MarketSnapshot[]
  rate_shop_recommendations RateShopRecommendation[]
  rate_shop_usage_monthly   RateShopUsageTenantMonthly[]

  @@map("hotels")
}

model User {
  id                String            @id @default(uuid()) @map("user_id") @db.Uuid
  hotel_id          String?           @db.Uuid
  email             String            @unique
  created_at        DateTime          @default(now())
  image             String?           @map("avatar_url")
  name              String?
  emailVerified     DateTime?         @map("email_verified")
  is_active         Boolean           @default(true)
  role              UserRole          @default(viewer)
  phone             String?
  accounts          Account[]
  hotel_users       HotelUser[]
  pricing_decisions PricingDecision[]
  sessions          Session[]
  hotel             Hotel?            @relation(fields: [hotel_id], references: [hotel_id])

  @@map("users")
}

model HotelUser {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  hotel_id   String   @db.Uuid
  role       UserRole @default(viewer)
  is_primary Boolean  @default(false)
  created_at DateTime @default(now())
  hotel      Hotel    @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, hotel_id])
  @@index([hotel_id])
  @@map("hotel_users")
}

model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ImportJob {
  job_id            String            @id @default(uuid()) @db.Uuid
  hotel_id          String            @db.Uuid
  file_name         String
  file_hash         String?
  status            JobStatus         @default(pending)
  error_summary     String?
  created_at        DateTime          @default(now())
  finished_at       DateTime?
  error_log         Json?
  total_rows        Int?
  import_type       ImportType        @default(RESERVATION)
  cancellations_raw CancellationRaw[]
  hotel             Hotel             @relation(fields: [hotel_id], references: [hotel_id])
  reservations_raw  ReservationsRaw[]

  @@map("import_jobs")
}

model ReservationsRaw {
  id                    String            @id @default(uuid()) @db.Uuid
  hotel_id              String            @db.Uuid
  job_id                String            @db.Uuid
  reservation_id        String
  booking_date          DateTime          @db.Date
  arrival_date          DateTime          @db.Date
  departure_date        DateTime          @db.Date
  rooms                 Int
  revenue               Decimal           @db.Decimal
  status                ReservationStatus
  cancel_date           DateTime?         @db.Date
  loaded_at             DateTime          @default(now())
  book_time             DateTime?         @db.Timestamptz(6)
  cancel_reason         String?
  cancel_source         String?
  cancel_time           DateTime?         @db.Timestamptz(6)
  last_modified_time    DateTime?         @db.Timestamptz(6)
  reservation_id_norm   String?
  room_code             String?
  room_code_norm        String?
  company_name          String? // OTA/Agent/Company name from XML
  matched_cancellations CancellationRaw[] @relation("MatchedCancellation")
  hotel                 Hotel             @relation(fields: [hotel_id], references: [hotel_id])
  job                   ImportJob         @relation(fields: [job_id], references: [job_id])

  @@unique([hotel_id, reservation_id, job_id], name: "uq_res_job")
  @@index([hotel_id, reservation_id_norm, arrival_date, room_code_norm], map: "idx_res_raw_match1")
  @@index([hotel_id, reservation_id_norm, arrival_date], map: "idx_res_raw_match2")
  @@index([hotel_id, book_time, cancel_time, arrival_date, departure_date], map: "idx_res_raw_otb")
  @@map("reservations_raw")
}

model DailyOTB {
  hotel_id    String   @db.Uuid
  as_of_date  DateTime @db.Date
  stay_date   DateTime @db.Date
  rooms_otb   Int
  revenue_otb Decimal  @db.Decimal
  created_at  DateTime @default(now())
  hotel       Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@index([hotel_id, as_of_date], map: "idx_otb_as_of")
  @@index([hotel_id, stay_date], map: "idx_otb_stay")
  @@map("daily_otb")
}

model FeaturesDaily {
  hotel_id         String   @db.Uuid
  as_of_date       DateTime @db.Date
  stay_date        DateTime @db.Date
  dow              Int?
  is_weekend       Boolean?
  month            Int?
  pickup_t30       Int?
  pickup_t7        Int?
  pickup_t3        Int?
  pace_vs_ly       Float?
  remaining_supply Int?
  created_at       DateTime @default(now())
  pickup_t15       Int?
  pickup_t5        Int?
  hotel            Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@map("features_daily")
}

model DemandForecast {
  hotel_id         String   @db.Uuid
  as_of_date       DateTime @db.Date
  stay_date        DateTime @db.Date
  remaining_demand Int?
  model_version    String?
  created_at       DateTime @default(now())
  hotel            Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@map("demand_forecast")
}

model PriceRecommendations {
  hotel_id          String   @db.Uuid
  as_of_date        DateTime @db.Date
  stay_date         DateTime @db.Date
  current_price     Decimal? @db.Decimal
  recommended_price Decimal? @db.Decimal
  expected_revenue  Decimal? @db.Decimal
  uplift_pct        Float?
  explanation       String?
  created_at        DateTime @default(now())
  hotel             Hotel    @relation(fields: [hotel_id], references: [hotel_id])

  @@id([hotel_id, as_of_date, stay_date])
  @@unique([hotel_id, stay_date, as_of_date], name: "unique_rec")
  @@map("price_recommendations")
}

model PricingDecision {
  decision_id  String         @id @default(uuid()) @db.Uuid
  hotel_id     String         @db.Uuid
  user_id      String         @db.Uuid
  as_of_date   DateTime       @db.Date
  stay_date    DateTime       @db.Date
  action       DecisionAction
  system_price Decimal?       @db.Decimal
  final_price  Decimal?       @db.Decimal
  reason       String?
  decided_at   DateTime       @default(now())
  hotel        Hotel          @relation(fields: [hotel_id], references: [hotel_id])
  user         User           @relation(fields: [user_id], references: [id])

  @@map("pricing_decisions")
}

model CancellationRaw {
  id                     String           @id @default(uuid()) @db.Uuid
  hotel_id               String           @db.Uuid
  job_id                 String           @db.Uuid
  folio_num              String
  arrival_date           DateTime         @db.Date
  cancel_time            DateTime         @db.Timestamptz(6)
  as_of_date             DateTime         @db.Date
  nights                 Int
  rate_amount            Decimal          @db.Decimal(12, 2)
  total_revenue          Decimal          @db.Decimal(12, 2)
  channel                String?
  sale_group             String?
  room_type              String?
  room_code              String?
  guest_name             String?
  created_at             DateTime         @default(now())
  folio_num_norm         String?
  match_notes            String?
  match_status           String?
  matched_at             DateTime?        @db.Timestamptz(6)
  matched_reservation_id String?          @db.Uuid
  room_code_norm         String?
  hotel                  Hotel            @relation(fields: [hotel_id], references: [hotel_id])
  job                    ImportJob        @relation(fields: [job_id], references: [job_id])
  matched_reservation    ReservationsRaw? @relation("MatchedCancellation", fields: [matched_reservation_id], references: [id])

  @@unique([hotel_id, folio_num_norm, arrival_date, cancel_time], name: "uq_cancel_event")
  @@index([hotel_id, as_of_date], map: "idx_cancel_as_of")
  @@index([hotel_id, cancel_time], map: "idx_cancel_time")
  @@index([hotel_id, arrival_date], map: "idx_cancel_arrival")
  @@index([hotel_id, match_status], map: "idx_cancel_match_status")
  @@map("cancellations_raw")
}

model RoomType {
  id          String   @id @default(cuid())
  hotel_id    String   @db.Uuid
  name        String
  description String?
  net_price   Float
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  hotel       Hotel    @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, name], name: "uq_room_type_name")
  @@index([hotel_id])
  @@map("room_types")
}

model OTAChannel {
  id         String             @id @default(cuid())
  hotel_id   String             @db.Uuid
  name       String
  code       String
  calc_type  CalcType           @default(PROGRESSIVE)
  commission Float
  is_active  Boolean            @default(true)
  created_at DateTime           @default(now())
  updated_at DateTime           @updatedAt
  campaigns  CampaignInstance[]
  hotel      Hotel              @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, code], name: "uq_ota_channel_code")
  @@index([hotel_id])
  @@map("ota_channels")
}

model PromotionCatalog {
  id                      String             @id
  vendor                  String
  name                    String
  description             String?
  group_type              PromotionGroup
  sub_category            String?
  default_pct             Float?
  allow_stack             Boolean            @default(true)
  max_one_in_group        Boolean            @default(false)
  max_one_per_subcategory Boolean            @default(false)
  instances               CampaignInstance[]

  @@index([vendor, group_type])
  @@map("promotion_catalog")
}

model CampaignInstance {
  id             String           @id @default(cuid())
  hotel_id       String           @db.Uuid
  ota_channel_id String
  promo_id       String
  discount_pct   Float
  is_active      Boolean          @default(true)
  start_date     DateTime?        @db.Date
  end_date       DateTime?        @db.Date
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  ota_channel    OTAChannel       @relation(fields: [ota_channel_id], references: [id], onDelete: Cascade)
  promo          PromotionCatalog @relation(fields: [promo_id], references: [id])

  @@index([hotel_id, ota_channel_id])
  @@index([promo_id])
  @@map("campaign_instances")
}

model PricingSetting {
  id               String   @id @default(cuid())
  hotel_id         String   @unique @db.Uuid
  currency         String   @default("VND")
  rounding_rule    String   @default("CEIL_1000")
  max_discount_cap Float    @default(80)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  hotel            Hotel    @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@map("pricing_settings")
}

enum JobStatus {
  pending
  processing
  completed
  failed
}

enum ReservationStatus {
  booked
  cancelled
}

enum DecisionAction {
  accept
  override
}

enum ImportType {
  RESERVATION
  CANCELLATION
}

enum CalcType {
  PROGRESSIVE
  ADDITIVE
}

enum PromotionGroup {
  SEASONAL
  ESSENTIAL
  TARGETED
}

enum UserRole {
  super_admin
  hotel_admin
  manager
  viewer
}

// ════════════════════════════════════════════════════════════════════
// Rate Shopper — Enums (8 total)
// ════════════════════════════════════════════════════════════════════

enum RateShopCacheStatus {
  FRESH
  STALE
  EXPIRED
  REFRESHING
  FAILED
}

enum RateShopAvailabilityStatus {
  AVAILABLE
  SOLD_OUT
  NO_RATE
}

enum RateShopDataConfidence {
  HIGH
  MED
  LOW
}

enum RateShopRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  COALESCED
}

enum RateShopRecommendationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum RateShopDemandStrength {
  WEAK
  NORMAL
  STRONG
}

enum RateShopQueryType {
  PROPERTY_DETAILS
  LISTING
}

enum RateShopProvider {
  SERPAPI
}

// ════════════════════════════════════════════════════════════════════
// Rate Shopper — Models
// ════════════════════════════════════════════════════════════════════

model Competitor {
  id                     String   @id @default(uuid()) @db.Uuid
  hotel_id               String   @db.Uuid
  name                   String
  google_place_id        String?
  serpapi_property_token String?
  address                String?
  star_rating            Int?
  tier                   Int      @default(1) // 1=primary, 2=secondary
  is_active              Boolean  @default(true)
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  hotel Hotel            @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)
  rates CompetitorRate[]

  @@unique([hotel_id, serpapi_property_token])
  @@index([hotel_id])
  @@index([is_active, serpapi_property_token])
  @@map("competitors")
}

model RateShopCache {
  id               String            @id @default(uuid()) @db.Uuid
  cache_key        String            @unique
  query_type       RateShopQueryType @default(PROPERTY_DETAILS)
  provider         RateShopProvider  @default(SERPAPI)
  canonical_params Json

  // ---- Materialized columns (indexed, from canonical_params) ----
  property_token String?
  check_in_date  String? @db.VarChar(10) // YYYY-MM-DD string
  check_out_date String? @db.VarChar(10)
  adults         Int?
  length_of_stay Int?
  currency       String? @db.VarChar(5)
  offset_days    Int?

  // ---- Cache state ----
  status              RateShopCacheStatus @default(STALE)
  raw_response        Json?
  raw_response_ref    String? // object storage signed URL
  fetched_at          DateTime?
  expires_at          DateTime            @default(now())
  stale_until         DateTime            @default(now())
  is_vendor_cache_hit Boolean?

  // ---- Lock & Backoff ----
  refresh_lock_until    DateTime?
  refreshing_request_id String?   @db.Uuid
  fail_streak           Int       @default(0)
  backoff_until         DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  rates    CompetitorRate[]
  requests RateShopRequest[]

  @@index([expires_at])
  @@index([status])
  @@index([query_type, check_in_date])
  @@index([property_token, check_in_date])
  @@index([offset_days, expires_at])
  @@index([status, backoff_until, expires_at])
  @@index([check_out_date])
  @@map("rate_shop_cache")
}

model RateShopRequest {
  id             String                @id @default(uuid()) @db.Uuid
  hotel_id       String                @db.Uuid
  cache_key      String
  check_in_date  String                @db.VarChar(10)
  check_out_date String?               @db.VarChar(10)
  adults         Int                   @default(2)
  status         RateShopRequestStatus @default(PENDING)
  requested_at   DateTime              @default(now())
  requested_date DateTime              @db.Date

  provider                RateShopProvider @default(SERPAPI)
  estimated_searches      Int              @default(1)
  credit_consumed         Boolean          @default(false)
  is_vendor_cache_hit     Boolean?
  coalesced_to_request_id String?          @db.Uuid

  query_type    RateShopQueryType?
  http_status   Int?
  error_message String?

  cache RateShopCache @relation(fields: [cache_key], references: [cache_key], onDelete: Restrict)
  hotel Hotel         @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@index([hotel_id, check_in_date])
  @@index([cache_key])
  @@index([hotel_id, requested_date])
  @@map("rate_shop_requests")
}

model CompetitorRate {
  id            String   @id @default(uuid()) @db.Uuid
  competitor_id String   @db.Uuid
  cache_id      String   @db.Uuid
  check_in_date String   @db.VarChar(10)
  source        String
  scraped_at    DateTime @default(now())

  availability_status RateShopAvailabilityStatus @default(AVAILABLE)
  data_confidence     RateShopDataConfidence     @default(MED)

  total_rate_lowest         Decimal? @db.Decimal(14, 0)
  total_rate_before_tax     Decimal? @db.Decimal(14, 0)
  rate_per_night_lowest     Decimal? @db.Decimal(14, 0)
  rate_per_night_before_tax Decimal? @db.Decimal(14, 0)
  representative_price      Decimal? @db.Decimal(14, 0)
  price_source_level        Int?

  is_official    Boolean @default(false)
  raw_price_json Json?

  competitor Competitor    @relation(fields: [competitor_id], references: [id], onDelete: Cascade)
  cache      RateShopCache @relation(fields: [cache_id], references: [id], onDelete: Cascade)

  @@index([competitor_id, check_in_date])
  @@index([cache_id])
  @@index([check_in_date])
  @@map("competitor_rates")
}

model MarketSnapshot {
  id             String @id @default(uuid()) @db.Uuid
  hotel_id       String @db.Uuid
  check_in_date  String @db.VarChar(10)
  length_of_stay Int    @default(1)
  adults         Int    @default(2)
  snapshot_date  String @db.VarChar(10)

  my_rate              Decimal? @db.Decimal(14, 0)
  comp_min             Decimal? @db.Decimal(14, 0)
  comp_max             Decimal? @db.Decimal(14, 0)
  comp_avg             Decimal? @db.Decimal(14, 0)
  comp_median          Decimal? @db.Decimal(14, 0)
  comp_available_count Int      @default(0)
  sold_out_count       Int      @default(0)
  no_rate_count        Int      @default(0)

  price_index Decimal? @db.Decimal(6, 4)
  gap_pct     Decimal? @db.Decimal(6, 4)
  delta_pct   Decimal? @db.Decimal(6, 4)

  market_confidence RateShopDataConfidence @default(MED)
  demand_strength   RateShopDemandStrength @default(NORMAL)
  recommended_rate  Decimal?               @db.Decimal(14, 0)
  reason_codes      String[]

  is_latest  Boolean  @default(true)
  created_at DateTime @default(now())

  hotel Hotel @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@unique([hotel_id, check_in_date, length_of_stay, adults, snapshot_date])
  @@index([hotel_id, check_in_date, is_latest])
  @@index([is_latest])
  @@map("market_snapshots")
}

model RateShopRecommendation {
  id            String @id @default(uuid()) @db.Uuid
  hotel_id      String @db.Uuid
  check_in_date String @db.VarChar(10)
  snapshot_date String @db.VarChar(10)

  current_rate     Decimal?                     @db.Decimal(14, 0)
  recommended_rate Decimal?                     @db.Decimal(14, 0)
  delta_pct        Decimal?                     @db.Decimal(6, 4)
  reason_codes     String[]
  confidence       RateShopDataConfidence       @default(MED)
  status           RateShopRecommendationStatus @default(PENDING)

  created_at DateTime @default(now())

  hotel Hotel @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@index([hotel_id, check_in_date])
  @@index([hotel_id, status])
  @@map("rate_shop_recommendations")
}

model RateShopUsageDaily {
  usage_date    String   @db.VarChar(10) // YYYY-MM-DD (getVNDate)
  searches_used Int      @default(0)
  budget_limit  Int      @default(500)
  safe_mode_on  Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@id([usage_date])
  @@map("rate_shop_usage_daily")
}

model RateShopUsageTenantMonthly {
  hotel_id      String   @db.Uuid
  billing_month String   @db.VarChar(7) // YYYY-MM (getVNMonth)
  searches_used Int      @default(0)
  quota_cap     Int      @default(200)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  hotel Hotel @relation(fields: [hotel_id], references: [hotel_id], onDelete: Cascade)

  @@id([hotel_id, billing_month])
  @@map("rate_shop_usage_tenant_monthly")
}
