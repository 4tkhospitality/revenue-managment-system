{
  "updated_at": "2026-02-16T23:38:00+07:00",
  "working_on": {
    "feature": "Onboarding Flow Fixes + Admin Improvements",
    "task": "Fixed onboarding redirect loop, updated sample CSV, added country display to admin users, cascade delete users",
    "status": "deployed",
    "files": [
      "apps/web/app/onboarding/page.tsx",
      "apps/web/app/api/onboarding/complete/route.ts",
      "apps/web/app/api/admin/users/route.ts",
      "apps/web/app/api/admin/users/[id]/route.ts",
      "apps/web/app/admin/components/AdminUsers.tsx",
      "apps/web/public/sample-reservations.csv",
      "apps/web/lib/constants/countries.ts"
    ],
    "blockers": [],
    "notes": "All fixes pushed. Need to test onboarding flow after Vercel deploy to confirm redirect loop is resolved."
  },
  "pending_tasks": [
    {
      "task": "Test onboarding redirect fix end-to-end after Vercel deploy",
      "priority": "critical",
      "notes": "Delete test user → onboard again → verify 'Vào Dashboard' goes to /dashboard not back to step 1"
    },
    {
      "task": "Add payment env vars to Vercel Dashboard (production)",
      "priority": "critical",
      "notes": "SEPAY_API_KEY, SEPAY_WEBHOOK_SECRET, SEPAY_BANK_ACCOUNT, SEPAY_BANK_NAME, PAYPAL_CLIENT_ID, PAYPAL_SECRET, PAYPAL_API_URL, PAYPAL_WEBHOOK_ID — then redeploy"
    },
    {
      "task": "Switch PayPal from Sandbox to Live when ready",
      "priority": "high",
      "notes": "Change PAYPAL_API_URL from sandbox to https://api-m.paypal.com and use Live credentials"
    },
    {
      "task": "Set up Vercel cron for /api/cron/check-subscription",
      "priority": "high",
      "notes": "0 19 * * * (19:00 UTC = 02:00 VN)"
    },
    {
      "task": "GM Dashboard V2 Phase A — Top Accounts, Room/LOS Mix, Lead-time Buckets",
      "priority": "medium",
      "notes": "Plan complete, waiting for coding phase"
    },
    {
      "task": "Analytics Layer P1/P2 — Cancel Forecast, Demand Model, Price Optimizer",
      "priority": "medium",
      "notes": "Plans at .brain/plans/260215-1905-analytics-layer-p1p2/. Engine files created but need integration testing."
    }
  ],
  "recent_changes": [
    {
      "timestamp": "2026-02-16T23:34:00+07:00",
      "type": "bugfix",
      "description": "Fixed onboarding redirect loop (part 2): Set rms_active_hotel cookie in /api/onboarding/complete response + use window.location.href instead of router.push for hard redirect. Commit e19562a.",
      "files": [
        "apps/web/app/api/onboarding/complete/route.ts",
        "apps/web/app/onboarding/page.tsx"
      ]
    },
    {
      "timestamp": "2026-02-16T23:25:00+07:00",
      "type": "feature",
      "description": "Cascade delete users with all related data (pricing_decisions, product_events, payment_transactions, org_members, hotel_users, accounts, sessions). Uses $transaction. Also prevents self-deletion. Commit 13b0c94.",
      "files": [
        "apps/web/app/api/admin/users/[id]/route.ts"
      ]
    },
    {
      "timestamp": "2026-02-16T23:14:00+07:00",
      "type": "bugfix",
      "description": "Fixed onboarding redirect (part 1): added await updateSession() before router.push('/dashboard'). Updated sample CSV dates 2025→2026. Fixed required fields list from 4→7 fields. Commit 5333437.",
      "files": [
        "apps/web/app/onboarding/page.tsx",
        "apps/web/public/sample-reservations.csv"
      ]
    },
    {
      "timestamp": "2026-02-16T23:13:00+07:00",
      "type": "feature",
      "description": "Added country flag display to Admin Users page. API returns hotelCountry from hotel relation. Frontend shows flag emoji next to hotel name. Commit dafae9e.",
      "files": [
        "apps/web/app/api/admin/users/route.ts",
        "apps/web/app/admin/components/AdminUsers.tsx"
      ]
    },
    {
      "timestamp": "2026-02-16T22:20:00+07:00",
      "type": "feature",
      "description": "Added country field to Hotel model with countries.ts constant (ISO 3166-1 alpha-2, 60+ countries). Onboarding and admin hotel settings now support country selection with flag emoji. Commits a7ca741, 0035dbe.",
      "files": [
        "apps/web/prisma/schema.prisma",
        "apps/web/lib/constants/countries.ts",
        "apps/web/app/onboarding/page.tsx",
        "apps/web/app/settings/page.tsx"
      ]
    }
  ],
  "errors_encountered": [
    {
      "error": "Onboarding → 'Vào Dashboard' redirects back to onboarding step 1 (stuck in loop)",
      "solution": "Root cause: JWT session has stale hasPendingActivation=true and accessibleHotels=[]. Fix: 1) Set rms_active_hotel cookie in /api/onboarding/complete response 2) Use window.location.href instead of router.push for hard page reload with fresh cookies.",
      "resolved": true,
      "file": "apps/web/app/onboarding/page.tsx"
    },
    {
      "error": "User deletion fails when user has payment transactions (foreign key P2003)",
      "solution": "Changed to cascade delete: transaction deletes all related records (pricing_decisions, product_events, payment_transactions, org_members, hotel_users, accounts, sessions) before deleting user.",
      "resolved": true,
      "file": "apps/web/app/api/admin/users/[id]/route.ts"
    }
  ],
  "decisions_made": [
    {
      "decision": "Always hard delete users with cascade — no soft delete",
      "reason": "User explicitly chose option 2 (cascade delete). All related data (payments, events, decisions) gets permanently removed. Self-deletion is prevented."
    },
    {
      "decision": "Use window.location.href instead of router.push for post-onboarding navigation",
      "reason": "router.push (soft navigation) keeps stale JWT in memory. window.location.href forces full page reload, ensuring browser sends fresh cookies (including rms_active_hotel) to middleware."
    },
    {
      "decision": "Set rms_active_hotel cookie server-side in onboarding complete API",
      "reason": "Middleware checks for this cookie as fallback when accessibleHotels is empty in JWT. Setting it server-side guarantees it's available immediately."
    }
  ]
}