{
  "updated_at": "2026-02-17T21:16:00+07:00",
  "working_on": {
    "feature": "Pricing Unification + UUPM Redesign",
    "task": "Added reason column to Detailed Mode, committed and pushed",
    "status": "completed",
    "files": [
      "apps/web/components/dashboard/QuickModePanel.tsx",
      "apps/web/components/dashboard/QuickModePricingWrapper.tsx",
      "apps/web/components/dashboard/RecommendationTable.tsx",
      "apps/web/app/dashboard/page.tsx"
    ],
    "blockers": [],
    "notes": "3 commits today: (1) f6d5e2b UUPM light theme redesign, (2) 0e5ca60 action badge + reason column in Detailed Mode. Both pushed to main."
  },
  "pending_tasks": [
    {
      "task": "Account Mapping Admin Page",
      "priority": "medium",
      "notes": "Quick fix done (Unknown → Direct/Walk-in). Need full admin page to let users map company_name to accounts/segments. Brainstorm needed."
    },
    {
      "task": "Distribution & Conversion Clinic — Channel Revenue & Risk (P0)",
      "priority": "medium",
      "notes": "Brainstorm complete. Data exists in reservations_raw + OTAChannel.commission. Needs: 1 API route (channel-performance) + 1 UI component."
    },
    {
      "task": "Switch PayPal from Sandbox to Live",
      "priority": "critical",
      "notes": "Change 4 env vars on Vercel: PAYPAL_API_URL=https://api-m.paypal.com, PAYPAL_CLIENT_ID (Live), PAYPAL_SECRET (Live), PAYPAL_WEBHOOK_ID (Live). Then redeploy."
    },
    {
      "task": "Add payment env vars to Vercel Dashboard (production)",
      "priority": "critical",
      "notes": "SEPAY_API_KEY, SEPAY_WEBHOOK_SECRET, SEPAY_BANK_ACCOUNT, SEPAY_BANK_NAME — then redeploy"
    },
    {
      "task": "Manual Verification — Pricing Unification ACs",
      "priority": "high",
      "notes": "Run AC-1 to AC-9 on live app: STOP_SELL badge, delta rounding, deep-link preservation, mode toggle, Accept All logic."
    }
  ],
  "recent_changes": [
    {
      "timestamp": "2026-02-17T21:14:00+07:00",
      "type": "feature",
      "description": "Added 'Hành động' badge + 'Lý do' column to RecommendationTable (Detailed Mode). Computes action/deltaPct/reasonTextVi from PricingLogic + OCC context in dashboard/page.tsx. Commit 0e5ca60.",
      "files": [
        "apps/web/components/dashboard/RecommendationTable.tsx",
        "apps/web/app/dashboard/page.tsx"
      ]
    },
    {
      "timestamp": "2026-02-17T21:05:00+07:00",
      "type": "feature",
      "description": "UUPM light theme redesign of QuickModePanel + QuickModePricingWrapper. Navy CTA, semantic badges, collapsible mode guide for GM, Source of Truth section. Commit f6d5e2b.",
      "files": [
        "apps/web/components/dashboard/QuickModePanel.tsx",
        "apps/web/components/dashboard/QuickModePricingWrapper.tsx"
      ]
    },
    {
      "timestamp": "2026-02-17T20:30:00+07:00",
      "type": "feature",
      "description": "Pricing Unification: schema migration (action, delta_pct, reason_code, reason_text_vi on price_recommendations), pipeline update, UI Quick Mode + navigation merge. AC-6 idempotency test passed.",
      "files": [
        "prisma/schema.prisma",
        "apps/web/lib/pricing/engine/runPricingEngine.ts",
        "apps/web/components/dashboard/QuickModePanel.tsx",
        "apps/web/components/dashboard/QuickModePricingWrapper.tsx",
        "apps/web/app/dashboard/page.tsx"
      ]
    },
    {
      "timestamp": "2026-02-17T19:34:00+07:00",
      "type": "improvement",
      "description": "PDF export: JPEG 80% + scale 1.5x (lighter files), smart page-break scans for whitespace rows to avoid cutting text. Commit c128358.",
      "files": [
        "apps/web/lib/pdf/exportToPdf.ts"
      ]
    }
  ],
  "errors_encountered": [
    {
      "error": "'Cancellations theo Ngày hủy' shows no data when CSV/XLSX uploaded",
      "solution": "Section read from cancellationRaw (XML-only table). Fixed to read from reservationsRaw which is the unified table for all upload formats (CSV/XLSX/XML).",
      "resolved": true,
      "file": "apps/web/app/data/page.tsx"
    },
    {
      "error": "Cancel forecast chart ('Dự báo Hủy phòng') always empty",
      "solution": "Two causes: (1) buildCancelStats lookback 365 days was too short for some data → expanded to 730. (2) /api/analytics/features route omitted expected_cxl fields from response mapping → added 4 cancel forecast fields.",
      "resolved": true,
      "file": "apps/web/app/api/analytics/features/route.ts"
    },
    {
      "error": "PDF export cuts text at page boundaries, file too heavy",
      "solution": "Replaced PNG scale 2x with JPEG 80% scale 1.5x (lighter). Added findSmartCutPoint() that scans bottom 15% of each page for whitespace rows to cut at.",
      "resolved": true,
      "file": "apps/web/lib/pdf/exportToPdf.ts"
    }
  ],
  "decisions_made": [
    {
      "decision": "Pricing Unification: 1 Engine, 2 Display Modes (Quick + Detailed)",
      "reason": "Quick Mode for daily 1-click review, Detailed Mode for in-depth OTB/forecast analysis. Both read from same price_recommendations table. Reduces confusion and maintenance."
    },
    {
      "decision": "UUPM SaaS Pro Light theme applied to all pricing components",
      "reason": "Consistency with rest of dashboard. Navy #1E3A8A CTA, semantic badges (emerald/amber/rose), white surface cards, slate text hierarchy per design-specs.md V01.7."
    },
    {
      "decision": "Reason text computed from OCC + supply/demand context",
      "reason": "GM needs to know WHY system recommends each price. Taxonomy: OCC% based (high OCC → increase, low OCC → decrease), demand vs supply comparison, deadband |delta| < 1% = KEEP."
    },
    {
      "decision": "reservationsRaw is the single source of truth for all cancellations",
      "reason": "CSV, XLSX, and XML booked data all go to reservationsRaw. cancellationRaw is only for separate XML cancel reports. For unified cancellation display, always query reservationsRaw WHERE status=cancelled OR cancel_time IS NOT NULL."
    },
    {
      "decision": "Cancel stats lookback window set to 730 days (2 years)",
      "reason": "365 days was too short for hotels with historical data spanning longer periods. 730 days ensures adequate training data for cancel rate statistics."
    },
    {
      "decision": "PDF uses JPEG 80% at scale 1.5x with smart page-break",
      "reason": "PNG at 2x was too heavy. JPEG 80% is visually equivalent but ~60% smaller. Smart cut point algorithm scans for bright (white) horizontal lines in the bottom 15% of each page to avoid cutting through text rows."
    }
  ]
}