{
  "meta": {
    "schema_version": "1.2.4",
    "awf_version": "4.1.2",
    "last_updated": "2026-02-07T16:03:00+07:00"
  },
  "project": {
    "name": "revenue-management-system",
    "type": "SaaS Web App",
    "status": "Production - Deployed to Vercel",
    "description": "RMS Version 01.2 - Revenue Management System with OTA Pricing Module + User Management + Cancellation Bridge. Full-stack TypeScript.",
    "github": "https://github.com/4tkhospitality/revenue-managment-system"
  },
  "tech_stack": {
    "frontend": {
      "framework": "Next.js 16.1.6 (App Router + Turbopack)",
      "language": "TypeScript",
      "styling": "Tailwind CSS",
      "components": "Custom + Lucide Icons",
      "charts": "Recharts",
      "theme": "Light SaaS Pro (lavender gray #F5F7FB, white surfaces, subtle shadows)"
    },
    "backend": {
      "framework": "Next.js Server Actions + API Routes",
      "auth": "NextAuth.js v5 (Google OAuth)",
      "csv_parser": "Papaparse",
      "xml_parser": "fast-xml-parser",
      "forecasting": "Heuristic (TS)",
      "pricing": "Ladder Pricing Strategy (TS)"
    },
    "database": {
      "type": "PostgreSQL 16",
      "orm": "Prisma 5.10.2",
      "hosting": "Supabase"
    },
    "deployment": {
      "vcs": "GitHub",
      "hosting": "Vercel",
      "tools": "Docker, Shell Scripts",
      "strategy": "Git-based Auto Deploy",
      "vercel_config": {
        "root_directory": "apps/web",
        "framework": "Next.js",
        "build_command": "npm run build (auto)",
        "output_directory": "Next.js default",
        "env_vars": [
          "DATABASE_URL",
          "DIRECT_URL",
          "DEFAULT_HOTEL_ID",
          "NEXT_PUBLIC_DEFAULT_HOTEL_ID",
          "GOOGLE_CLIENT_ID",
          "GOOGLE_CLIENT_SECRET",
          "ADMIN_EMAIL"
        ]
      }
    }
  },
  "database_schema": {
    "summary": "RMS Schema designed for Multi-tenancy with RBAC User Management (V01) + Cancellation Bridge (V01.1).",
    "tables": [
      {
        "name": "hotels",
        "description": "Tenant root. Stores hotel metadata, capacity, pricing config, timezone, ladder_steps."
      },
      {
        "name": "users",
        "description": "System users with global role (super_admin/viewer) and is_active flag.",
        "v01_changes": "Added UserRole enum, is_active field, hotel_users relation",
        "v012_changes": "Added phone field for contact number"
      },
      {
        "name": "hotel_users",
        "description": "Junction table for User-Hotel many-to-many with per-hotel roles (hotel_admin/manager/viewer).",
        "v01_new": true
      },
      {
        "name": "import_jobs",
        "description": "Tracks CSV/XML file uploads and processing status."
      },
      {
        "name": "reservations_raw",
        "description": "Append-only raw booking data from PMS. Linked to ImportJob.",
        "v011_changes": "Added book_time, cancel_time, cancel_reason, cancel_source, last_modified_time, reservation_id_norm, room_code, room_code_norm. FK from cancellations_raw."
      },
      {
        "name": "cancellations_raw",
        "description": "Cancellation records from Crystal Reports XML. Linked to ImportJob.",
        "v011_changes": "Added folio_num_norm, room_code_norm, matched_reservation_id (FK), matched_at, match_status, match_notes. Unique constraint uq_cancel_event."
      },
      {
        "name": "daily_otb",
        "description": "Fact table. Snapshots of OTB by stay_date. Built from reservations with time-travel logic."
      },
      {
        "name": "features_daily",
        "description": "Computed features (Pickup T30/15/7/5, Pace, Weekend, Month)."
      },
      {
        "name": "demand_forecast",
        "description": "Forecast outputs. Remaining Demand predictions."
      },
      {
        "name": "price_recommendations",
        "description": "Pricing engine outputs. Suggestions for GM."
      },
      {
        "name": "pricing_decisions",
        "description": "Audit log of user actions (Accept/Override)."
      },
      {
        "name": "room_types",
        "description": "V01.2: Room types with NET base prices for OTA pricing.",
        "v012_new": true
      },
      {
        "name": "ota_channels",
        "description": "V01.2: OTA channels with commission rates and calc mode (Progressive/Additive).",
        "v012_new": true
      },
      {
        "name": "promotion_catalog",
        "description": "V01.2: Global promotion templates for 5 OTAs. 61 promotions total (Agoda:17, Booking:15, Traveloka:10, Trip.com:11, Expedia:8). Includes allow_stack, description fields.",
        "v012_new": true
      },
      {
        "name": "campaign_instances",
        "description": "V01.2: Links promotions to OTA channels per hotel.",
        "v012_new": true
      },
      {
        "name": "pricing_settings",
        "description": "V01.2: Hotel-specific pricing settings (currency, rounding, max discount).",
        "v012_new": true
      }
    ],
    "enums": [
      {
        "name": "UserRole",
        "values": [
          "super_admin",
          "hotel_admin",
          "manager",
          "viewer"
        ],
        "description": "Role hierarchy: super_admin > hotel_admin > manager > viewer"
      },
      {
        "name": "CalcType",
        "values": [
          "PROGRESSIVE",
          "ADDITIVE"
        ],
        "description": "V01.2: BAR calculation mode. PROGRESSIVE = NET/(1-comm)/Π(1-dᵢ), ADDITIVE = NET/(1-comm)/(1-Σdᵢ)"
      },
      {
        "name": "PromotionGroup",
        "values": [
          "SEASONAL",
          "ESSENTIAL",
          "TARGETED"
        ],
        "description": "V01.2: Promotion stacking rules. SEASONAL=max 1, TARGETED=max 1 per subcategory"
      },
      {
        "name": "CalcMode (conceptual)",
        "values": [
          "PROGRESSIVE (Agoda, Booking, Traveloka)",
          "ADDITIVE (Trip.com/Ctrip)",
          "ISOLATED (Expedia - no stacking)"
        ],
        "description": "OTA-specific calculation modes for promotion stacking"
      }
    ],
    "v011_indexes": [
      "idx_res_raw_match1 (hotel_id, reservation_id_norm, arrival_date, room_code_norm)",
      "idx_res_raw_match2 (hotel_id, reservation_id_norm, arrival_date)",
      "idx_res_raw_otb (hotel_id, book_time, cancel_time, arrival_date, departure_date)",
      "idx_cancel_match_status (hotel_id, match_status)",
      "uq_cancel_event (hotel_id, folio_num_norm, arrival_date, cancel_time)"
    ]
  },
  "api_endpoints": [
    {
      "path": "Server Action: ingestCSV",
      "explained": "Processes uploaded CSV, validates rows, saves to reservations_raw."
    },
    {
      "path": "Server Action: ingestXML",
      "explained": "Parses Crystal Reports PMS XML format. Aggregates by ConfirmNum."
    },
    {
      "path": "Server Action: ingestCancellationXml",
      "explained": "V01.1: Parses cancellation XML, normalizes keys, runs bridge to match reservations.",
      "v011_new": true
    },
    {
      "path": "Server Action: buildDailyOTB",
      "explained": "V01.1: Time-travel OTB with asOfTs, book_time fallback, revenue split per night.",
      "v011_updated": true
    },
    {
      "path": "Server Action: backfillOTB",
      "explained": "V01.1: Backfill OTB snapshots for historical dates.",
      "v011_new": true
    },
    {
      "path": "POST /api/user/switch-hotel",
      "explained": "Sets active hotel via httpOnly cookie (rms_active_hotel).",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/users",
      "explained": "List all users with hotel assignments (super_admin only).",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/users",
      "explained": "Create new user with optional hotel assignments.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]",
      "explained": "Update user role, is_active status.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]/hotels",
      "explained": "Replace user's hotel assignments.",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/hotels",
      "explained": "List all hotels with user counts.",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/hotels",
      "explained": "Create new hotel.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/hotels/[id]",
      "explained": "Update hotel settings.",
      "v01_new": true
    },
    {
      "path": "GET /api/pricing/room-types",
      "explained": "V01.2: List room types for active hotel.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/room-types",
      "explained": "V01.2: Create room type with NET price.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/room-types/[id]",
      "explained": "V01.2: Update or delete room type.",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/ota-channels",
      "explained": "V01.2: List OTA channels with active campaigns.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/ota-channels",
      "explained": "V01.2: Create OTA channel with commission and calc mode.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/ota-channels/[id]",
      "explained": "V01.2: Update or delete OTA channel.",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/campaigns",
      "explained": "V01.2: List campaigns (promo instances) for hotel.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/campaigns",
      "explained": "V01.2: Create campaign linking promo to OTA channel.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/campaigns/[id]",
      "explained": "V01.2: Update or delete campaign.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/calc-matrix",
      "explained": "V01.2: Calculate full price matrix (RoomTypes × Channels).",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/catalog",
      "explained": "V01.2: Get promotion catalog by vendor (agoda, booking, traveloka, ctrip, expedia).",
      "v012_updated": true
    }
  ],
  "features": [
    "PMS-agnostic CSV Import",
    "Crystal Reports XML Import",
    "Cancellation XML Import with Auto-Bridge (V01.1)",
    "Data Inspector Page with Build OTB, Build Features, Run Forecast buttons",
    "Reset & Rebuild Button (clears derived data)",
    "Import Jobs Pagination (10/page)",
    "Daily OTB Time-Travel with asOfTs (V01.1)",
    "Dashboard with KPI Cards, OTB Chart, Recommendations Table",
    "Real Pricing Engine Integration (Ladder Strategy)",
    "Settings: Timezone, Fiscal Start Day, Ladder Config",
    "Comprehensive Guide/Help Page",
    "Excel Export",
    "SaaS Pro Light Theme (consistent across all pages)",
    "Google OAuth Authentication (NextAuth.js v5)",
    "Role-Based Access Control (super_admin/hotel_admin/manager/viewer)",
    "Multi-Hotel User Support with HotelSwitcher",
    "Admin Panel (Users + Hotels management)",
    "Blocked User auto sign-out",
    "Mobile Responsive Layout with Hamburger Menu",
    "Dashboard Cancellation Stats (Room-nights + Lost Revenue)",
    "Data Inspector Match Status Breakdown (Matched/Unmatched/Ambiguous)",
    "Login Page with 4TK Brand Colors (#204183, Glassmorphism)",
    "Sidebar Logout Button with User Info",
    "Consistent Gradient Headers across all pages (including Admin)",
    "V01.2: OTA Pricing Module - Calculate BAR from NET with commissions and promotions",
    "V01.2: Room Types Management (CRUD)",
    "V01.2: OTA Channels Configuration (commission, calc mode)",
    "V01.2: Promotions Tab (campaign picker, validation panel)",
    "V01.2: Overview Tab (price matrix, heatmap, CSV export)",
    "V01.2: Booking.com Promotions (Genius, Mobile, Deals) - 10 promotions",
    "V01.2: Editable Discount Percentage - User can modify % per campaign",
    "V01.2: Demo Hotel - Default hotel for new users without assignment",
    "V01.2: User Phone Field - Contact number in user profile",
    "V01.2: Vendor-specific Discount Validation - Agoda 80% cap, Booking.com no limit",
    "Delete Data By Month - Super admin can delete reservations/cancellations by month with confirmation",
    "Cached Stats with TTL - 5-minute cache for reservation and cancellation statistics",
    "Top 3 Agents by Company Name - Groups agents from XML ClientName field",
    "All-time Cancellation Stats - Uses all data instead of 30-day filter for accurate display",
    "V01.2: Full 5-OTA Promotion Catalogs - Agoda(17), Booking(15), Traveloka(10), Trip.com(11), Expedia(8) = 61 total",
    "V01.2: OTA-Specific Validation Rules - Expedia ISOLATED, Trip.com ADDITIVE boxes, Booking Deep Deals no-stack",
    "V01.2: Promotion Descriptions - Each promo has description field from OTA Partner Hubs",
    "Auto-detect Hotel ID - Dashboard, Build OTB, Build Features, Forecast, Reset all auto-detect from reservation data",
    "Super Admin Demo Hotel Bypass - Super Admin sees all features (Settings, Guide) even on Demo Hotel",
    "Dashboard date-aware cancellation stats - uses OTB as_of_date instead of today for historical data",
    "Multi-Hotel Active Context - getActiveHotelId() prioritizes cookie > session > fallback. All pages use active hotel instead of auto-detect",
    "HotelSwitcher Dark Sidebar - Super Admin sees ALL hotels dropdown, dark theme matching sidebar, blue accent for active hotel",
    "Auto Demo Hotel Assignment - New users auto-assigned to Demo Hotel on first login (auth.ts jwt callback)",
    "OTB Date Display - Shows 'Chưa có dữ liệu' with amber styling when no OTB data exists",
    "Upload Hotel Banner - Upload page shows active hotel name + ID for clarity",
    "No-Hotel-Access Auto-Refresh - Page auto-refreshes session to trigger Demo Hotel assignment, Zalo support link"
  ],
  "cancellation_bridge_v011": {
    "status": "Implemented",
    "description": "Bridges cancellation records to reservations for accurate OTB calculation",
    "files": [
      "lib/normalize.ts - Key normalization (UPPER, TRIM, alphanumeric only)",
      "lib/cancellationBridge.ts - Bridge logic with matching, conflict resolution, DQ checks"
    ],
    "matching_algorithm": {
      "strategy": "take:2 for ambiguity detection",
      "order": [
        "last_modified_time desc",
        "book_time desc",
        "loaded_at desc"
      ],
      "keys": [
        "reservation_id_norm",
        "arrival_date",
        "room_code_norm (optional)"
      ]
    },
    "match_statuses": [
      "matched",
      "unmatched",
      "ambiguous",
      "conflict",
      "dq_issue",
      "unsupported_partial"
    ],
    "time_travel_otb": {
      "formula": "booking_date <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)",
      "book_time_fallback": "booking_date at 00:00:00 if book_time is null",
      "revenue_split": "total/nights per night, remainder to last night"
    }
  },
  "user_management_v01": {
    "status": "Implemented",
    "roles": {
      "super_admin": "Global admin - access all hotels, all features",
      "hotel_admin": "Per-hotel admin - full access within assigned hotels",
      "manager": "Per-hotel manager - view + some edit permissions",
      "viewer": "Per-hotel read-only access"
    },
    "pages": [
      "/admin/users - User management with create/assign modals",
      "/admin/hotels - Hotel management with create/edit modals",
      "/select-hotel - Multi-hotel picker for users with multiple assignments",
      "/blocked - Blocked user page (auto sign-out)",
      "/no-hotel-access - Users without hotel assignments",
      "/unauthorized - Permission denied page"
    ],
    "components": [
      "HotelSwitcher - Dropdown in sidebar to switch active hotel",
      "Sidebar - Hamburger menu on mobile, logout button with user info in footer",
      "LoginPage - Glassmorphism card with 4TK brand gradient background",
      "AdminPages - Gradient blue header matching Data Inspector style"
    ]
  },
  "decisions": [
    "Full-stack Next.js for MVP speed",
    "UUIDs for all Primary Keys (SaaS scalability)",
    "Append-Only reservations for audit trail",
    "Use Supabase for Database Hosting",
    "Heuristic Forecasting instead of ML for V01",
    "Ladder Pricing Strategy with configurable presets",
    "Use fast-xml-parser for server-side XML parsing",
    "Light SaaS Pro theme with lavender gray (#F5F7FB) background",
    "NextAuth.js v5 with Google OAuth for authentication",
    "JWT-based session with user role and accessible hotels",
    "httpOnly cookie for active hotel persistence",
    "HotelUser junction table for many-to-many user-hotel relationships",
    "Separate global role (User.role) and per-hotel role (HotelUser.role)",
    "V01.1: Bridge cancellations to reservations for accurate OTB",
    "V01.1: Use timestamptz for cancel_time and book_time",
    "V01.1: Time-travel OTB using asOfTs parameter",
    "V01.2: Progressive mode = BAR / (1-comm) / Π(1-dᵢ) - compounds discounts",
    "V01.2: Additive mode = BAR / (1-comm) / (1-Σdᵢ) - sums discounts",
    "V01.2: Validation rules: max 1 Seasonal, max 1 Targeted per subcategory",
    "V01.2: Vendor-specific max discount: Agoda 80%, Booking.com no limit",
    "V01.2: Booking.com promotions mapped to existing PromotionGroup types",
    "V01.2: Demo Hotel (ID: 159fe315-79a0-48a3-adac-f47d4f56b748) as fallback for new users",
    "V01.2: Traveloka Channel Rate - applied before campaigns (Progressive mode)",
    "V01.2: Trip.com ADDITIVE mode - same box pick 1, different boxes stack additively (d₁+d₂+...)",
    "V01.2: Expedia ISOLATED mode - each promotion creates separate rate plan, no stacking",
    "V01.2: Booking.com Deep Deals (Limited-time, Deal of the Day) - allow_stack=false",
    "Auto-detect hotel_id from reservations_raw (groupBy most reservations) instead of env var DEFAULT_HOTEL_ID",
    "Super Admin bypasses Demo Hotel restrictions (Settings page, Guide page)",
    "Dashboard uses OTB as_of_date as reference date for cancellation stats and forecasts",
    "Multi-Hotel Active Context: getActiveHotelId() uses cookie→session→fallback chain with permission validation",
    "Super Admin fallback: first real hotel by created_at (skips Demo Hotel) for deterministic behavior",
    "Cookie is a preference, not authorization: server validates user has access to cookie hotel_id",
    "Auto-assign Demo Hotel: existing users with 0 hotel assignments get Demo Hotel automatically on login",
    "signIn callback creates user, jwt callback assigns Demo Hotel if needed (race condition fix)"
  ],
  "ui_design": {
    "theme": "SaaS Pro Light",
    "colors": {
      "background": "#F5F7FB (lavender gray)",
      "surface": "#ffffff (white cards)",
      "primary": "#1E3A8A (royal blue)",
      "sidebar": "#204184 (LOGO_BLUE)",
      "text": "#1e293b (dark gray)",
      "border": "slate-200/80"
    },
    "brand_colors": {
      "primary": "#204183 (from logo)",
      "dark": "#0B1E3A (deep background)",
      "mid": "#16325F (gradient middle)",
      "light": "#AABAD1 (hover/highlight)"
    },
    "components": {
      "surface": "rounded-2xl bg-white border border-slate-200/80 shadow-[0_1px_2px_rgba(16,24,40,0.06)]",
      "header": "rounded-2xl px-6 py-4 text-white shadow-sm background: linear-gradient(to right, #1E3A8A, #102A4C)",
      "container": "mx-auto max-w-[1400px] px-8 py-6 space-y-6",
      "sidebar": "fixed left-0 w-64 h-screen bg-[#204184] text-white (hidden on mobile with hamburger toggle)",
      "login_page": "Gradient background (#0B1E3A → #16325F → #204183), glassmorphism card (bg-white/10 backdrop-blur-xl)"
    },
    "responsive": {
      "breakpoint": "lg (1024px)",
      "mobile": "Hamburger menu in fixed header, sidebar slides from left, overlay for close",
      "desktop": "Fixed sidebar always visible, ml-64 for main content"
    }
  },
  "knowledge_items": {
    "gotchas": [
      "DOMParser is browser-only, use fast-xml-parser for Node.js",
      "Prisma Date comparison requires exact match - normalize to midnight",
      "Prisma generate fails while dev server running (file lock) - restart server",
      "PrismaClient cannot run in Edge Middleware - use API routes for DB calls",
      "Vercel monorepo: Must set Root Directory to 'apps/web' in Project Settings",
      "Vercel monorepo: Framework Preset must be 'Next.js', not 'Other'",
      "TypeScript IDE may need restart after prisma generate to pick up new types",
      "Admin pages need layout.tsx to include sidebar (app/admin/layout.tsx)",
      "V01.1: Prisma.ModelGetPayload<object> for inferred types",
      "V01.1: Use prisma.$transaction for atomic bridge updates",
      "JWT callback: Nested Prisma include fails silently in Edge runtime - use separate queries",
      "JWT callback: Only fetch user data on initial sign-in (when account is present), not every request",
      "Session stale: If user's hotel assignments changed, they must logout and login again to refresh JWT",
      "Cookie activeHotelId may point to invalid hotel - middleware clears it and redirects to /select-hotel",
      "React hydration mismatch warnings from browser extensions (Liner) - safe to ignore",
      "DEFAULT_HOTEL_ID env var may not match uploaded data - always auto-detect hotel_id from reservations_raw",
      "Dashboard/cancellation queries using today's date will miss historical data - use OTB as_of_date",
      "NEXT_PUBLIC_DEFAULT_HOTEL_ID removed from client components - use getActiveHotelData() server action instead",
      "signIn callback creates user → jwt callback sees user exists but 0 hotels → must auto-assign Demo Hotel in jwt",
      "/api/debug-user endpoint doesn't exist → no-hotel-access page was calling it → JSON parse error (HTML 404)",
      "OTB date used today's date as fallback when no data → misleading. Changed to null + 'Chưa có dữ liệu'",
      "HotelSwitcher white dropdown clashes with dark sidebar → redesigned with dark theme (bg-[#0f1d36])"
    ],
    "formulas": {
      "rooms_otb": "SUM(num_rooms) from reservations for that stay_date",
      "remaining_supply": "Capacity − rooms_otb",
      "adr": "revenue_otb ÷ rooms_otb",
      "recommended_price": "PricingLogic.optimize(ADR, forecast_demand, remaining_supply)",
      "time_travel_active": "book_time <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)"
    },
    "data_pipeline": {
      "step1": "Upload CSV/XML → reservations_raw",
      "step1b": "Upload Cancellation XML → cancellations_raw → Bridge → reservations_raw",
      "step2": "Build OTB (time-travel) → daily_otb",
      "step3": "Build Features → features_daily",
      "step4": "Run Forecast → demand_forecast",
      "step5": "Pricing Engine → recommended_price (calculated on-the-fly)"
    }
  }
}