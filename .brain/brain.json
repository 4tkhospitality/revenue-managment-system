{
  "meta": {
    "schema_version": "1.1.0",
    "awf_version": "4.1.2",
    "last_updated": "2026-02-04T17:54:00+07:00"
  },
  "project": {
    "name": "revenue-management-system",
    "type": "SaaS Web App",
    "status": "Production - Deployed to Vercel",
    "description": "RMS Version 01.1 (MVP) - Revenue Management System with Pricing Engine + User Management + Cancellation Bridge. Full-stack TypeScript.",
    "github": "https://github.com/4tkhospitality/revenue-managment-system"
  },
  "tech_stack": {
    "frontend": {
      "framework": "Next.js 16.1.6 (App Router + Turbopack)",
      "language": "TypeScript",
      "styling": "Tailwind CSS",
      "components": "Custom + Lucide Icons",
      "charts": "Recharts",
      "theme": "Light SaaS Pro (lavender gray #F5F7FB, white surfaces, subtle shadows)"
    },
    "backend": {
      "framework": "Next.js Server Actions + API Routes",
      "auth": "NextAuth.js v5 (Google OAuth)",
      "csv_parser": "Papaparse",
      "xml_parser": "fast-xml-parser",
      "forecasting": "Heuristic (TS)",
      "pricing": "Ladder Pricing Strategy (TS)"
    },
    "database": {
      "type": "PostgreSQL 16",
      "orm": "Prisma 5.10.2",
      "hosting": "Supabase"
    },
    "deployment": {
      "vcs": "GitHub",
      "hosting": "Vercel",
      "tools": "Docker, Shell Scripts",
      "strategy": "Git-based Auto Deploy",
      "vercel_config": {
        "root_directory": "apps/web",
        "framework": "Next.js",
        "build_command": "npm run build (auto)",
        "output_directory": "Next.js default",
        "env_vars": [
          "DATABASE_URL",
          "DIRECT_URL",
          "DEFAULT_HOTEL_ID",
          "NEXT_PUBLIC_DEFAULT_HOTEL_ID",
          "GOOGLE_CLIENT_ID",
          "GOOGLE_CLIENT_SECRET",
          "ADMIN_EMAIL"
        ]
      }
    }
  },
  "database_schema": {
    "summary": "RMS Schema designed for Multi-tenancy with RBAC User Management (V01) + Cancellation Bridge (V01.1).",
    "tables": [
      {
        "name": "hotels",
        "description": "Tenant root. Stores hotel metadata, capacity, pricing config, timezone, ladder_steps."
      },
      {
        "name": "users",
        "description": "System users with global role (super_admin/viewer) and is_active flag.",
        "v01_changes": "Added UserRole enum, is_active field, hotel_users relation"
      },
      {
        "name": "hotel_users",
        "description": "Junction table for User-Hotel many-to-many with per-hotel roles (hotel_admin/manager/viewer).",
        "v01_new": true
      },
      {
        "name": "import_jobs",
        "description": "Tracks CSV/XML file uploads and processing status."
      },
      {
        "name": "reservations_raw",
        "description": "Append-only raw booking data from PMS. Linked to ImportJob.",
        "v011_changes": "Added book_time, cancel_time, cancel_reason, cancel_source, last_modified_time, reservation_id_norm, room_code, room_code_norm. FK from cancellations_raw."
      },
      {
        "name": "cancellations_raw",
        "description": "Cancellation records from Crystal Reports XML. Linked to ImportJob.",
        "v011_changes": "Added folio_num_norm, room_code_norm, matched_reservation_id (FK), matched_at, match_status, match_notes. Unique constraint uq_cancel_event."
      },
      {
        "name": "daily_otb",
        "description": "Fact table. Snapshots of OTB by stay_date. Built from reservations with time-travel logic."
      },
      {
        "name": "features_daily",
        "description": "Computed features (Pickup T30/15/7/5, Pace, Weekend, Month)."
      },
      {
        "name": "demand_forecast",
        "description": "Forecast outputs. Remaining Demand predictions."
      },
      {
        "name": "price_recommendations",
        "description": "Pricing engine outputs. Suggestions for GM."
      },
      {
        "name": "pricing_decisions",
        "description": "Audit log of user actions (Accept/Override)."
      }
    ],
    "enums": [
      {
        "name": "UserRole",
        "values": [
          "super_admin",
          "hotel_admin",
          "manager",
          "viewer"
        ],
        "description": "Role hierarchy: super_admin > hotel_admin > manager > viewer"
      }
    ],
    "v011_indexes": [
      "idx_res_raw_match1 (hotel_id, reservation_id_norm, arrival_date, room_code_norm)",
      "idx_res_raw_match2 (hotel_id, reservation_id_norm, arrival_date)",
      "idx_res_raw_otb (hotel_id, book_time, cancel_time, arrival_date, departure_date)",
      "idx_cancel_match_status (hotel_id, match_status)",
      "uq_cancel_event (hotel_id, folio_num_norm, arrival_date, cancel_time)"
    ]
  },
  "api_endpoints": [
    {
      "path": "Server Action: ingestCSV",
      "explained": "Processes uploaded CSV, validates rows, saves to reservations_raw."
    },
    {
      "path": "Server Action: ingestXML",
      "explained": "Parses Crystal Reports PMS XML format. Aggregates by ConfirmNum."
    },
    {
      "path": "Server Action: ingestCancellationXml",
      "explained": "V01.1: Parses cancellation XML, normalizes keys, runs bridge to match reservations.",
      "v011_new": true
    },
    {
      "path": "Server Action: buildDailyOTB",
      "explained": "V01.1: Time-travel OTB with asOfTs, book_time fallback, revenue split per night.",
      "v011_updated": true
    },
    {
      "path": "Server Action: backfillOTB",
      "explained": "V01.1: Backfill OTB snapshots for historical dates.",
      "v011_new": true
    },
    {
      "path": "POST /api/user/switch-hotel",
      "explained": "Sets active hotel via httpOnly cookie (rms_active_hotel).",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/users",
      "explained": "List all users with hotel assignments (super_admin only).",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/users",
      "explained": "Create new user with optional hotel assignments.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]",
      "explained": "Update user role, is_active status.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]/hotels",
      "explained": "Replace user's hotel assignments.",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/hotels",
      "explained": "List all hotels with user counts.",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/hotels",
      "explained": "Create new hotel.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/hotels/[id]",
      "explained": "Update hotel settings.",
      "v01_new": true
    }
  ],
  "features": [
    "PMS-agnostic CSV Import",
    "Crystal Reports XML Import",
    "Cancellation XML Import with Auto-Bridge (V01.1)",
    "Data Inspector Page with Build OTB, Build Features, Run Forecast buttons",
    "Reset & Rebuild Button (clears derived data)",
    "Import Jobs Pagination (10/page)",
    "Daily OTB Time-Travel with asOfTs (V01.1)",
    "Dashboard with KPI Cards, OTB Chart, Recommendations Table",
    "Real Pricing Engine Integration (Ladder Strategy)",
    "Settings: Timezone, Fiscal Start Day, Ladder Config",
    "Comprehensive Guide/Help Page",
    "Excel Export",
    "SaaS Pro Light Theme (consistent across all pages)",
    "Google OAuth Authentication (NextAuth.js v5)",
    "Role-Based Access Control (super_admin/hotel_admin/manager/viewer)",
    "Multi-Hotel User Support with HotelSwitcher",
    "Admin Panel (Users + Hotels management)",
    "Blocked User auto sign-out"
  ],
  "cancellation_bridge_v011": {
    "status": "Implemented",
    "description": "Bridges cancellation records to reservations for accurate OTB calculation",
    "files": [
      "lib/normalize.ts - Key normalization (UPPER, TRIM, alphanumeric only)",
      "lib/cancellationBridge.ts - Bridge logic with matching, conflict resolution, DQ checks"
    ],
    "matching_algorithm": {
      "strategy": "take:2 for ambiguity detection",
      "order": [
        "last_modified_time desc",
        "book_time desc",
        "loaded_at desc"
      ],
      "keys": [
        "reservation_id_norm",
        "arrival_date",
        "room_code_norm (optional)"
      ]
    },
    "match_statuses": [
      "matched",
      "unmatched",
      "ambiguous",
      "conflict",
      "dq_issue",
      "unsupported_partial"
    ],
    "time_travel_otb": {
      "formula": "booking_date <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)",
      "book_time_fallback": "booking_date at 00:00:00 if book_time is null",
      "revenue_split": "total/nights per night, remainder to last night"
    }
  },
  "user_management_v01": {
    "status": "Implemented",
    "roles": {
      "super_admin": "Global admin - access all hotels, all features",
      "hotel_admin": "Per-hotel admin - full access within assigned hotels",
      "manager": "Per-hotel manager - view + some edit permissions",
      "viewer": "Per-hotel read-only access"
    },
    "pages": [
      "/admin/users - User management with create/assign modals",
      "/admin/hotels - Hotel management with create/edit modals",
      "/select-hotel - Multi-hotel picker for users with multiple assignments",
      "/blocked - Blocked user page (auto sign-out)",
      "/no-hotel-access - Users without hotel assignments",
      "/unauthorized - Permission denied page"
    ],
    "components": [
      "HotelSwitcher - Dropdown in sidebar to switch active hotel",
      "Sidebar - Updated with Admin Panel link (super_admin only)"
    ]
  },
  "decisions": [
    "Full-stack Next.js for MVP speed",
    "UUIDs for all Primary Keys (SaaS scalability)",
    "Append-Only reservations for audit trail",
    "Use Supabase for Database Hosting",
    "Heuristic Forecasting instead of ML for V01",
    "Ladder Pricing Strategy with configurable presets",
    "Use fast-xml-parser for server-side XML parsing",
    "Light SaaS Pro theme with lavender gray (#F5F7FB) background",
    "NextAuth.js v5 with Google OAuth for authentication",
    "JWT-based session with user role and accessible hotels",
    "httpOnly cookie for active hotel persistence",
    "HotelUser junction table for many-to-many user-hotel relationships",
    "Separate global role (User.role) and per-hotel role (HotelUser.role)",
    "V01.1: Bridge cancellations to reservations for accurate OTB",
    "V01.1: Use timestamptz for cancel_time and book_time",
    "V01.1: Time-travel OTB using asOfTs parameter"
  ],
  "ui_design": {
    "theme": "SaaS Pro Light",
    "colors": {
      "background": "#F5F7FB (lavender gray)",
      "surface": "#ffffff (white cards)",
      "primary": "#1E3A8A (royal blue)",
      "sidebar": "#204184 (LOGO_BLUE)",
      "text": "#1e293b (dark gray)",
      "border": "slate-200/80"
    },
    "components": {
      "surface": "rounded-2xl bg-white border border-slate-200/80 shadow-[0_1px_2px_rgba(16,24,40,0.06)]",
      "header": "rounded-2xl px-6 py-4 text-white shadow-sm",
      "container": "mx-auto max-w-[1400px] px-8 py-6 space-y-6",
      "sidebar": "fixed left-0 w-64 h-screen bg-[#204184] text-white"
    }
  },
  "knowledge_items": {
    "gotchas": [
      "DOMParser is browser-only, use fast-xml-parser for Node.js",
      "Prisma Date comparison requires exact match - normalize to midnight",
      "Prisma generate fails while dev server running (file lock) - restart server",
      "PrismaClient cannot run in Edge Middleware - use API routes for DB calls",
      "Vercel monorepo: Must set Root Directory to 'apps/web' in Project Settings",
      "Vercel monorepo: Framework Preset must be 'Next.js', not 'Other'",
      "TypeScript IDE may need restart after prisma generate to pick up new types",
      "Admin pages need layout.tsx to include sidebar (app/admin/layout.tsx)",
      "V01.1: Prisma.ModelGetPayload<object> for inferred types",
      "V01.1: Use prisma.$transaction for atomic bridge updates"
    ],
    "formulas": {
      "rooms_otb": "SUM(num_rooms) from reservations for that stay_date",
      "remaining_supply": "Capacity − rooms_otb",
      "adr": "revenue_otb ÷ rooms_otb",
      "recommended_price": "PricingLogic.optimize(ADR, forecast_demand, remaining_supply)",
      "time_travel_active": "book_time <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)"
    },
    "data_pipeline": {
      "step1": "Upload CSV/XML → reservations_raw",
      "step1b": "Upload Cancellation XML → cancellations_raw → Bridge → reservations_raw",
      "step2": "Build OTB (time-travel) → daily_otb",
      "step3": "Build Features → features_daily",
      "step4": "Run Forecast → demand_forecast",
      "step5": "Pricing Engine → recommended_price (calculated on-the-fly)"
    }
  }
}