{
  "meta": {
    "schema_version": "1.1.0",
    "awf_version": "4.1.2",
    "last_updated": "2026-02-03T11:03:00+07:00"
  },
  "project": {
    "name": "revenue-management-system",
    "type": "SaaS Web App",
    "status": "Development - Full Pipeline Working (Upload → OTB → Features → Forecast → Pricing)",
    "description": "RMS Version 01 (MVP) - Revenue Management System with Pricing Engine. Full-stack TypeScript.",
    "github": "https://github.com/4tkhospitality/revenue-managment-system"
  },
  "tech_stack": {
    "frontend": {
      "framework": "Next.js 14+ (App Router)",
      "language": "TypeScript",
      "styling": "Tailwind CSS",
      "components": "Custom + Lucide Icons",
      "charts": "Recharts"
    },
    "backend": {
      "framework": "Next.js Server Actions + API Routes",
      "csv_parser": "Papaparse",
      "xml_parser": "fast-xml-parser",
      "forecasting": "Heuristic (TS)",
      "pricing": "Ladder Pricing Strategy (TS)"
    },
    "database": {
      "type": "PostgreSQL",
      "version": "16",
      "orm": "Prisma",
      "hosting": "Supabase"
    },
    "deployment": {
      "vcs": "GitHub",
      "tools": "Docker, Shell Scripts",
      "strategy": "One-click Run"
    }
  },
  "database_schema": {
    "summary": "RMS Schema designed for Multi-tenancy and Time-Travel OTB calculation.",
    "tables": [
      {
        "name": "hotels",
        "description": "Tenant root. Stores hotel metadata, capacity, pricing config, timezone, ladder_steps."
      },
      {
        "name": "users",
        "description": "System users linked to hotels."
      },
      {
        "name": "import_jobs",
        "description": "Tracks CSV/XML file uploads and processing status."
      },
      {
        "name": "reservations_raw",
        "description": "Append-only raw booking data from PMS. Linked to ImportJob."
      },
      {
        "name": "daily_otb",
        "description": "Fact table. Snapshots of OTB by stay_date. Built from reservations."
      },
      {
        "name": "features_daily",
        "description": "Computed features (Pickup T30/15/7/5, Pace, Weekend, Month)."
      },
      {
        "name": "demand_forecast",
        "description": "Forecast outputs. Remaining Demand predictions."
      },
      {
        "name": "price_recommendations",
        "description": "Pricing engine outputs. Suggestions for GM."
      },
      {
        "name": "pricing_decisions",
        "description": "Audit log of user actions (Accept/Override)."
      }
    ],
    "hotel_fields": {
      "new_fields": [
        "timezone (default: Asia/Ho_Chi_Minh)",
        "fiscal_start_day (1-31, default: 1)",
        "ladder_steps (JSON array of price adjustment percentages)"
      ]
    }
  },
  "api_endpoints": [
    {
      "path": "Server Action: ingestCSV",
      "explained": "Processes uploaded CSV, validates rows, saves to reservations_raw."
    },
    {
      "path": "Server Action: ingestXML",
      "explained": "Parses Crystal Reports PMS XML format. Aggregates by ConfirmNum."
    },
    {
      "path": "Server Action: buildDailyOTB",
      "explained": "Calculates DailyOTB from reservations. Aggregates by stay_date."
    },
    {
      "path": "Server Action: buildFeatures",
      "explained": "Computes Pickup (T30, T15, T7, T5) and Pace vs LY."
    },
    {
      "path": "Server Action: runForecast",
      "explained": "Heuristic Model: Max(AvgPickup, T7) * LeadTimeFactor."
    },
    {
      "path": "Server Action: resetDerivedData",
      "explained": "Clears all derived data (OTB, Features, Forecast, Pricing) while keeping raw reservations."
    },
    {
      "path": "Server Action: submitDecision",
      "explained": "Log User Action: Accept/Override to pricing_decisions."
    },
    {
      "path": "GET/POST /api/settings",
      "explained": "Hotel settings management with timezone, fiscal_start_day, ladder_steps."
    },
    {
      "path": "GET /api/import-jobs",
      "explained": "Paginated list of import jobs. Query: page, pageSize."
    }
  ],
  "features": [
    "PMS-agnostic CSV Import",
    "Crystal Reports XML Import",
    "Data Inspector Page with Build OTB, Build Features, Run Forecast buttons",
    "Reset & Rebuild Button (clears derived data)",
    "Import Jobs Pagination (10/page)",
    "Daily OTB Time-Travel (Time-Machine View)",
    "Dashboard with KPI Cards, OTB Chart, Recommendations Table",
    "Real Pricing Engine Integration (Ladder Strategy)",
    "Quick Filters (Today/7/14/30 Days/Custom)",
    "Weekend Highlighting in Tables",
    "Formula Explanations in UI",
    "Accept/Override Decision Actions",
    "Remaining Demand Forecast (Heuristic)",
    "Settings: Timezone, Fiscal Start Day, Ladder Config",
    "Comprehensive Guide/Help Page",
    "Excel Export"
  ],
  "decisions": [
    "Full-stack Next.js for MVP speed",
    "UUIDs for all Primary Keys (SaaS scalability)",
    "Append-Only reservations for audit trail",
    "Use Supabase for Database Hosting",
    "Heuristic Forecasting instead of ML for V01",
    "Ladder Pricing Strategy with configurable presets (Conservative ±10%, Standard ±20%, Aggressive ±30%)",
    "Use fast-xml-parser for server-side XML parsing",
    "Dashboard uses PricingLogic.optimize() for real price recommendations",
    "Normalize dates to midnight for Prisma date comparisons",
    "Hotel capacity configurable in Settings (default 240)",
    "Timezone support for regional OTB calculations",
    "Git repository pushed to GitHub"
  ],
  "knowledge_items": {
    "gotchas": [
      "DOMParser is browser-only, use fast-xml-parser for Node.js",
      "Prisma Date comparison requires exact match - normalize to midnight",
      "apps/web was added as submodule - removed .git folder to fix",
      "Prisma generate fails while dev server running (file lock) - restart server",
      "PricingLogic.optimize takes (currentPrice, remainingDemand, remainingSupply)"
    ],
    "formulas": {
      "rooms_otb": "SUM(num_rooms) from reservations for that stay_date",
      "remaining_supply": "Capacity − rooms_otb",
      "adr": "revenue_otb ÷ rooms_otb",
      "recommended_price": "PricingLogic.optimize(ADR, forecast_demand, remaining_supply)",
      "forecast_demand": "baseDemand * lead_time_factor (from features_daily)"
    },
    "data_pipeline": {
      "step1": "Upload CSV/XML → reservations_raw",
      "step2": "Build OTB → daily_otb",
      "step3": "Build Features → features_daily",
      "step4": "Run Forecast → demand_forecast",
      "step5": "Pricing Engine → recommended_price (calculated on-the-fly)"
    }
  }
}