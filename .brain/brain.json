{
  "meta": {
    "schema_version": "2.0.0",
    "awf_version": "4.1.2",
    "last_updated": "2026-02-17T12:34:00+07:00"
  },
  "project": {
    "name": "revenue-management-system",
    "type": "SaaS Web App",
    "status": "Production - Deployed to Vercel (icn1 region)",
    "description": "RMS Version 02.1 - Revenue Management System with Room Band Pricing + Organization-based Multi-Hotel + OTB Time-Travel + OTA Pricing + Dynamic Pricing by OCC + Unified Pricing Logic + InsightsPanel V2 + Payment Gateway (SePay/PayPal/Zalo) + Analytics Layer (Cancel Forecast, Demand Model, Price Optimizer) + GM Dashboard V2 (Top Accounts, Room/LOS Mix, Lead-time Buckets). Full-stack TypeScript.",
    "github": "https://github.com/4tkhospitality/revenue-managment-system",
    "landing_page": {
      "path": "apps/landing",
      "framework": "Next.js 16.1.6 (App Router)",
      "domain": "pakhos.com / www.pakhos.com",
      "status": "V3 - Professional Visual Overhaul pushed to GitHub, pending Vercel deployment",
      "design": {
        "palette": "Navy #204184 (from logo) + Emerald #10b981 + Gold #d4a24e",
        "typography": "Inter (Google Fonts)",
        "icons": "Inline SVG line-art (no emoji)",
        "logo": "Inline SVG (white circle + 4TK text) — not PNG"
      },
      "i18n": "Vietnamese (vi.ts) + English (en.ts) with toggle",
      "sections": "Hero, How It Works, Revenue Share Model, Comparison Table, Technology, Results, Case Studies, Clients, Team, FAQ, Lead Form, Footer",
      "api": "/api/lead (POST — validates fields, logs lead, placeholder for Resend email)"
    }
  },
  "tech_stack": {
    "frontend": {
      "framework": "Next.js 16.1.6 (App Router + Turbopack)",
      "language": "TypeScript",
      "styling": "Tailwind CSS",
      "components": "Custom + Lucide Icons",
      "charts": "Recharts",
      "theme": "Light SaaS Pro (lavender gray #F5F7FB, white surfaces, subtle shadows)"
    },
    "backend": {
      "framework": "Next.js Server Actions + API Routes",
      "auth": "NextAuth.js v5 (Google OAuth)",
      "csv_parser": "Papaparse",
      "xml_parser": "fast-xml-parser",
      "forecasting": "Heuristic (TS)",
      "pricing": "Ladder Pricing Strategy (TS)"
    },
    "database": {
      "type": "PostgreSQL 16",
      "orm": "Prisma 5.10.2",
      "hosting": "Supabase"
    },
    "deployment": {
      "vcs": "GitHub",
      "hosting": "Vercel",
      "tools": "Docker, Shell Scripts",
      "strategy": "Git-based Auto Deploy",
      "vercel_config": {
        "root_directory": "apps/web",
        "framework": "Next.js",
        "build_command": "npm run build (auto)",
        "output_directory": "Next.js default",
        "region": "icn1 (Seoul - same as Supabase DB ap-northeast-2)",
        "env_vars": [
          "DATABASE_URL",
          "DIRECT_URL",
          "DEFAULT_HOTEL_ID",
          "NEXT_PUBLIC_DEFAULT_HOTEL_ID",
          "GOOGLE_CLIENT_ID",
          "GOOGLE_CLIENT_SECRET",
          "ADMIN_EMAIL",
          "SEPAY_API_KEY",
          "SEPAY_WEBHOOK_SECRET",
          "SEPAY_BANK_ACCOUNT",
          "SEPAY_BANK_NAME",
          "PAYPAL_CLIENT_ID",
          "PAYPAL_SECRET",
          "PAYPAL_API_URL",
          "PAYPAL_WEBHOOK_ID",
          "PAYPAL_PLAN_SUPERIOR_R30",
          "PAYPAL_PLAN_SUPERIOR_R80",
          "PAYPAL_PLAN_DELUXE_R30",
          "PAYPAL_PLAN_DELUXE_R80",
          "PAYPAL_PLAN_SUITE_R30",
          "PAYPAL_PLAN_SUITE_R80",
          "CRON_SECRET"
        ]
      }
    }
  },
  "database_schema": {
    "summary": "RMS Schema V02.1: Organization-based multi-tenancy with Room Band Pricing + Payment Transactions (SePay/PayPal/Zalo). Subscription owned by Org, not Hotel. PaymentTransaction model with P1 operational fields (expires_at, completed_at, failed_reason, gateway_event_id).",
    "tables": [
      {
        "name": "hotels",
        "description": "Tenant root. Stores hotel metadata, capacity, pricing config, timezone, ladder_steps, country (ISO 3166-1 alpha-2)."
      },
      {
        "name": "users",
        "description": "System users with global role (super_admin/viewer) and is_active flag.",
        "v01_changes": "Added UserRole enum, is_active field, hotel_users relation",
        "v012_changes": "Added phone field for contact number"
      },
      {
        "name": "hotel_users",
        "description": "Junction table for User-Hotel many-to-many with per-hotel roles (hotel_admin/manager/viewer).",
        "v01_new": true
      },
      {
        "name": "import_jobs",
        "description": "Tracks CSV/XML file uploads and processing status."
      },
      {
        "name": "reservations_raw",
        "description": "Append-only raw booking data from PMS. Linked to ImportJob.",
        "v011_changes": "Added book_time, cancel_time, cancel_reason, cancel_source, last_modified_time, reservation_id_norm, room_code, room_code_norm. FK from cancellations_raw."
      },
      {
        "name": "cancellations_raw",
        "description": "Cancellation records from Crystal Reports XML. Linked to ImportJob.",
        "v011_changes": "Added folio_num_norm, room_code_norm, matched_reservation_id (FK), matched_at, match_status, match_notes. Unique constraint uq_cancel_event."
      },
      {
        "name": "daily_otb",
        "description": "Fact table. Snapshots of OTB by stay_date. Built from reservations with time-travel logic."
      },
      {
        "name": "features_daily",
        "description": "Computed features (Pickup T30/15/7/5, Pace, Weekend, Month) + Cancel forecast fields (expected_cxl, net_remaining, cxl_rate_used, cxl_confidence)."
      },
      {
        "name": "demand_forecast",
        "description": "Forecast outputs. Remaining Demand predictions."
      },
      {
        "name": "price_recommendations",
        "description": "Pricing engine outputs. Suggestions for GM."
      },
      {
        "name": "pricing_decisions",
        "description": "Audit log of user actions (Accept/Override)."
      },
      {
        "name": "room_types",
        "description": "V01.2: Room types with NET base prices for OTA pricing.",
        "v012_new": true
      },
      {
        "name": "ota_channels",
        "description": "V01.2: OTA channels with commission rates and calc mode (Progressive/Additive).",
        "v012_new": true
      },
      {
        "name": "promotion_catalog",
        "description": "V01.2: Global promotion templates for 5 OTAs. 61 promotions total (Agoda:17, Booking:15, Traveloka:10, Trip.com:11, Expedia:8). Includes allow_stack, description fields.",
        "v012_new": true
      },
      {
        "name": "campaign_instances",
        "description": "V01.2: Links promotions to OTA channels per hotel.",
        "v012_new": true
      },
      {
        "name": "pricing_settings",
        "description": "V01.2: Hotel-specific pricing settings (currency, rounding, max discount).",
        "v012_new": true
      },
      {
        "name": "hotel_invites",
        "description": "V01.3: Team invite system. Token-based with hashed storage, expiration, rate limiting.",
        "v013_new": true
      },
      {
        "name": "product_events",
        "description": "V01.3: Product analytics tracking. User actions, trial triggers, exports.",
        "v013_new": true
      },
      {
        "name": "rate_limit_hits",
        "description": "V01.3: IP-based rate limiting table (Vercel-safe, no in-memory).",
        "v013_new": true
      },
      {
        "name": "subscriptions",
        "description": "V02.0: Org-level subscription with plan (STANDARD/SUPERIOR/DELUXE/SUITE), room_band (R30/R80/R150/R300P), capacity_snapshot, price_multiplier. Owned by org_id (not hotel_id).",
        "v020_updated": true
      },
      {
        "name": "organizations",
        "description": "V02.0: Tenant root for multi-hotel. Every hotel belongs to 1 org. Subscription is per-org. Has name, slug.",
        "v020_new": true
      },
      {
        "name": "org_members",
        "description": "V02.0: User-Org membership with OrgRole (OWNER/ADMIN/MEMBER). Seats counted here. Unique(org_id, user_id).",
        "v020_new": true
      },
      {
        "name": "occ_tiers",
        "description": "V01.8: Occupancy-based pricing tiers. Each tier has label, occ_min/occ_max (0-1), multiplier. Per-hotel. Indexed by hotel_id.",
        "v018_new": true
      },
      {
        "name": "seasons",
        "description": "V01.8: Named date ranges (Peak, Shoulder, Off-Peak, Tet, etc) with multiplier. Per-hotel. Validates no overlapping date ranges.",
        "v018_new": true
      },
      {
        "name": "season_rates",
        "description": "V01.8: Override BAR per room_type × season. Links to seasons and room_types. Unique constraint on (season_id, room_type_id).",
        "v018_new": true
      },
      {
        "name": "payment_transactions",
        "description": "V02.1: Payment transaction records. hotel_id NULLABLE for pay-first flow (demo users pay before creating hotel). Added billing_cycle ('monthly'|'3-months'), term_months (1|3). Indexes: hotel_id, user_id (orphan payment lookup), status, status+expires_at. P1 fields: expires_at, completed_at, failed_at, failed_reason, gateway_event_id, provider_customer_ref.",
        "v021_new": true,
        "v021_pay_first": "hotel_id nullable, user_id indexed for orphan payment detection"
      }
    ],
    "enums": [
      {
        "name": "UserRole",
        "values": [
          "super_admin",
          "hotel_admin",
          "manager",
          "viewer"
        ],
        "description": "Role hierarchy: super_admin > hotel_admin > manager > viewer"
      },
      {
        "name": "CalcType",
        "values": [
          "PROGRESSIVE",
          "ADDITIVE",
          "SINGLE_DISCOUNT"
        ],
        "description": "V01.2: BAR calculation mode. PROGRESSIVE = NET/(1-comm)/Π(1-dᵢ), ADDITIVE = NET/(1-comm)/(1-Σdᵢ), SINGLE_DISCOUNT = only highest discount applied"
      },
      {
        "name": "PromotionGroup",
        "values": [
          "SEASONAL",
          "ESSENTIAL",
          "TARGETED",
          "GENIUS",
          "PORTFOLIO",
          "CAMPAIGN"
        ],
        "description": "V01.6: 2-layer architecture. Engine layer (source-of-truth for stacking): SEASONAL/ESSENTIAL/TARGETED/GENIUS/PORTFOLIO/CAMPAIGN. UI layer: vendor-specific display labels."
      },
      {
        "name": "StackBehavior (TS type)",
        "values": [
          "STACKABLE",
          "HIGHEST_WINS",
          "EXCLUSIVE",
          "ONLY_WITH_GENIUS"
        ],
        "description": "V01.6: Engine-layer stacking rule per promotion. STACKABLE=combines with others, HIGHEST_WINS=portfolio pick best, EXCLUSIVE=blocks all, ONLY_WITH_GENIUS=blocks all except Genius."
      },
      {
        "name": "CalcMode (per channel defaults)",
        "values": [
          "ADDITIVE (Agoda 20%, Traveloka 15%, CTRIP 18%)",
          "PROGRESSIVE (Booking.com 18%)",
          "SINGLE_DISCOUNT (Expedia 17% - no stacking)"
        ],
        "description": "OTA-specific calculation modes for promotion stacking. Source of truth: lib/pricing/seed-defaults.ts"
      },
      {
        "name": "RoomBand",
        "values": [
          "R30",
          "R80",
          "R150",
          "R300P"
        ],
        "description": "V02.0: Room count bands for pricing. R30=≤30, R80=31-80, R150=81-150, R300P=151-300+."
      },
      {
        "name": "OrgRole",
        "values": [
          "OWNER",
          "ADMIN",
          "MEMBER"
        ],
        "description": "V02.0: Organization-level role. OWNER=billing admin, ADMIN=manage members, MEMBER=access."
      },
      {
        "name": "SubscriptionStatus",
        "values": [
          "ACTIVE",
          "TRIAL",
          "CANCELLED",
          "PAST_DUE",
          "REFUNDED"
        ],
        "description": "V02.1: Subscription lifecycle status. Added TRIAL and REFUNDED."
      },
      {
        "name": "PaymentGateway",
        "values": [
          "SEPAY",
          "PAYPAL",
          "ZALO_MANUAL"
        ],
        "description": "V02.1: Supported payment gateways.",
        "v021_new": true
      },
      {
        "name": "PaymentStatus",
        "values": [
          "PENDING",
          "COMPLETED",
          "FAILED",
          "REFUNDED"
        ],
        "description": "V02.1: Payment transaction lifecycle status.",
        "v021_new": true
      }
    ],
    "v011_indexes": [
      "idx_res_raw_match1 (hotel_id, reservation_id_norm, arrival_date, room_code_norm)",
      "idx_res_raw_match2 (hotel_id, reservation_id_norm, arrival_date)",
      "idx_res_raw_otb (hotel_id, book_time, cancel_time, arrival_date, departure_date)",
      "idx_cancel_match_status (hotel_id, match_status)",
      "uq_cancel_event (hotel_id, folio_num_norm, arrival_date, cancel_time)"
    ]
  },
  "api_endpoints": [
    {
      "path": "Server Action: ingestCSV",
      "explained": "Processes uploaded CSV, validates rows, saves to reservations_raw."
    },
    {
      "path": "Server Action: ingestXML",
      "explained": "Parses Crystal Reports PMS XML format. Aggregates by ConfirmNum."
    },
    {
      "path": "Server Action: ingestCancellationXml",
      "explained": "V01.1: Parses cancellation XML, normalizes keys, runs bridge to match reservations.",
      "v011_new": true
    },
    {
      "path": "Server Action: buildDailyOTB",
      "explained": "V01.1: Time-travel OTB with asOfTs, book_time fallback, revenue split per night.",
      "v011_updated": true
    },
    {
      "path": "Server Action: backfillOTB",
      "explained": "V01.1: Backfill OTB snapshots for historical dates.",
      "v011_new": true
    },
    {
      "path": "POST /api/user/switch-hotel",
      "explained": "Sets active hotel via httpOnly cookie (rms_active_hotel).",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/users",
      "explained": "List all users with hotel assignments (super_admin only).",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/users",
      "explained": "Create new user with optional hotel assignments.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]",
      "explained": "Update user role, is_active status.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]/hotels",
      "explained": "Replace user's hotel assignments.",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/hotels",
      "explained": "List all hotels with user counts.",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/hotels",
      "explained": "Create new hotel.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/hotels/[id]",
      "explained": "Update hotel settings.",
      "v01_new": true
    },
    {
      "path": "GET /api/pricing/room-types",
      "explained": "V01.2: List room types for active hotel.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/room-types",
      "explained": "V01.2: Create room type with NET price.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/room-types/[id]",
      "explained": "V01.2: Update or delete room type.",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/ota-channels",
      "explained": "V01.2: List OTA channels with active campaigns.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/ota-channels",
      "explained": "V01.2: Create OTA channel with commission and calc mode.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/ota-channels/[id]",
      "explained": "V01.2: Update or delete OTA channel.",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/campaigns",
      "explained": "V01.2: List campaigns (promo instances) for hotel.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/campaigns",
      "explained": "V01.2: Create campaign linking promo to OTA channel.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/campaigns/[id]",
      "explained": "V01.2: Update or delete campaign.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/calc-matrix",
      "explained": "V01.2: Calculate full price matrix (RoomTypes × Channels).",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/catalog",
      "explained": "V01.2: Get promotion catalog by vendor (agoda, booking, traveloka, ctrip, expedia).",
      "v012_updated": true
    },
    {
      "path": "POST /api/onboarding",
      "explained": "V01.3: Create hotel during onboarding wizard, auto-create subscription.",
      "v013_new": true
    },
    {
      "path": "POST /api/onboarding/complete",
      "explained": "V01.3: Mark onboarding complete, extend trial by 7 bonus days.",
      "v013_new": true
    },
    {
      "path": "POST /api/trial/activate",
      "explained": "V01.3: Trigger 7-day trial after quality import (≥10 reservations).",
      "v013_new": true
    },
    {
      "path": "POST /api/invite/create",
      "explained": "V01.3: Create team invite with token, role, expiration.",
      "v013_new": true
    },
    {
      "path": "POST /api/invite/redeem",
      "explained": "V01.3: Redeem invite token with rate limiting and atomic transaction.",
      "v013_new": true
    },
    {
      "path": "GET /api/otb/snapshots",
      "explained": "V01.4: List available OTB snapshots with row count per as_of_date.",
      "v014_new": true
    },
    {
      "path": "POST /api/otb/snapshots/build",
      "explained": "V01.4: Build single OTB snapshot with advisory lock. Supports rebuild flag.",
      "v014_new": true
    },
    {
      "path": "POST /api/otb/snapshots/backfill",
      "explained": "V01.4: Batch backfill snapshots with generate_series, chunking (limit=3), missing_only.",
      "v014_new": true
    },
    {
      "path": "POST /api/lead (landing)",
      "explained": "Landing page lead form submission. Validates required fields (name/email/phone/hotel/rooms), logs lead summary, placeholder for Resend email.",
      "v02_new": true
    },
    {
      "path": "GET /api/features/latest-date",
      "explained": "Returns max(as_of_date) from features_daily for a hotel. Used by RunForecast to align with Build Features.",
      "v02_new": true
    },
    {
      "path": "DELETE /api/data/delete-by-month?includeOtb=true",
      "explained": "Deletes reservations, cancellations, and optionally OTB+FeaturesDaily by month. Hotel_id filtered.",
      "v02_new": true
    },
    {
      "path": "GET/POST /api/pricing/occ-tiers",
      "explained": "V01.8: CRUD occupancy tiers per hotel. POST replaces all tiers atomically in transaction.",
      "v018_new": true
    },
    {
      "path": "GET/POST /api/pricing/seasons + DELETE /api/pricing/seasons/[id]",
      "explained": "V01.8: CRUD seasons per hotel. Validates no overlapping date ranges.",
      "v018_new": true
    },
    {
      "path": "GET/POST /api/pricing/season-rates + POST /api/pricing/season-rates/import",
      "explained": "V01.8: Season rate overrides per room_type×season. Import bulk-creates rates.",
      "v018_new": true
    },
    {
      "path": "POST /api/pricing/dynamic-matrix",
      "explained": "V01.8: Calculate dynamic pricing matrix. Returns per-cell finalPrice, trace[], violations[], effectiveDiscount. Inputs: room_types, channels, campaigns, occ_tiers, seasons, stayDate.",
      "v018_new": true
    },
    {
      "path": "POST /api/pricing/calc-preview",
      "explained": "V01.8: Quick preview of pricing for a single room×channel with full trace.",
      "v018_new": true
    },
    {
      "path": "GET/DELETE /api/invite/list",
      "explained": "V02.0: List active invites for current hotel (GET), revoke invite by ID (DELETE). Admin only.",
      "v020_new": true
    },
    {
      "path": "GET /api/organization",
      "explained": "V02.0: Get organization info for current hotel. Returns org name, slug, subscription with roomBand.",
      "v020_new": true
    },
    {
      "path": "GET /api/subscription/compliance",
      "explained": "V02.0: Check subscription compliance (room band vs actual capacity). Returns compliance status and warnings.",
      "v020_new": true
    },
    {
      "path": "POST /api/payments/sepay/create-checkout",
      "explained": "V02.1: Creates PENDING payment transaction for SePay VND transfer. Generates QR checkout URL. Concurrent lock + auto-expire old PENDING. Provider switching blocked.",
      "v021_new": true
    },
    {
      "path": "POST /api/payments/sepay/webhook",
      "explained": "V02.1: SePay webhook handler. 3-step Match→Validate→Dedup. HMAC-SHA256 signature. Amount comparison in VND integers. Atomic activation.",
      "v021_new": true
    },
    {
      "path": "POST /api/payments/paypal/activate",
      "explained": "V02.1: Activates PayPal subscription after user approval. Re-fetches from PayPal API (P1). Creates COMPLETED transaction + applies subscription change atomically.",
      "v021_new": true
    },
    {
      "path": "POST /api/payments/paypal/webhook",
      "explained": "V02.1: PayPal webhook handler. Handles 5 event types (ACTIVATED, SALE_COMPLETED, CANCELLED, EXPIRED, SUSPENDED). Signature verification via PayPal API.",
      "v021_new": true
    },
    {
      "path": "GET /api/cron/check-subscription",
      "explained": "V02.1: Daily cron job. Checks expired subscriptions, syncs with PayPal API, 3-day grace period for SePay, auto-expires PENDING transactions.",
      "v021_new": true
    },
    {
      "path": "POST /api/admin/activate-subscription",
      "explained": "V02.1: Admin-only manual subscription activation (Zalo flow). Creates ZALO_MANUAL PaymentTransaction.",
      "v021_new": true
    },
    {
      "path": "POST /api/track",
      "explained": "V02.1: PLG event tracking endpoint. Fire-and-forget from client.",
      "v021_new": true
    },
    {
      "path": "GET /api/payments/pending-activation",
      "explained": "V02.1: Detect orphan payments (COMPLETED with null hotel_id). Called on login to redirect pay-first users to onboarding.",
      "v021_new": true
    },
    {
      "path": "POST /api/payments/paypal/create-order",
      "explained": "V02.1: Creates PayPal one-time order with dynamic USD pricing. hotelId optional (pay-first flow). Provider switching block. Auto-cancel existing PENDING.",
      "v021_new": true
    },
    {
      "path": "POST /api/payments/paypal/capture-order",
      "explained": "V02.1: Captures PayPal order after user approval. Finds PENDING tx by gateway_transaction_id, marks COMPLETED, activates subscription (skip if hotel_id null).",
      "v021_new": true
    },
    {
      "path": "GET /api/analytics/cancel-forecast",
      "explained": "V02.1: Returns cancel forecast data (predicted vs actual cancellation rates).",
      "v021_new": true
    },
    {
      "path": "POST /api/analytics/forecast",
      "explained": "V02.1: Triggers demand forecast model run.",
      "v021_new": true
    },
    {
      "path": "POST /api/analytics/pipeline",
      "explained": "V02.1: Runs full analytics pipeline (cancel stats → features → demand → pricing).",
      "v021_new": true
    },
    {
      "path": "GET/POST /api/settings",
      "explained": "V02.0 updated: POST handler auto-syncs room_band in subscriptions when hotel capacity changes. Uses deriveBand() + $executeRaw.",
      "v020_updated": true
    },
    {
      "path": "GET /api/pricing/plans?band=R30",
      "explained": "V02.1: Public API for dynamic plan prices. Returns monthly/quarterly/discountPercent per tier for given room band. Used by pricing page and PaymentMethodModal. Falls back to hardcoded if DB empty.",
      "v021_new": true
    },
    {
      "path": "GET/PUT/DELETE /api/admin/pricing-config",
      "explained": "V02.1: Admin CRUD for pricing configs (BASE_PRICE, BAND_MULTIPLIER, TERM_DISCOUNT). PUT strips irrelevant fields by config_type. Timezone fix: appends +07:00 to datetime-local inputs.",
      "v021_new": true
    }
  ],
  "features": [
    "PMS-agnostic CSV Import",
    "Crystal Reports XML Import",
    "Cancellation XML Import with Auto-Bridge (V01.1)",
    "Data Inspector Page with Build OTB, Build Features, Run Forecast buttons",
    "Reset & Rebuild Button (clears derived data)",
    "Import Jobs Pagination (10/page)",
    "Daily OTB Time-Travel with asOfTs (V01.1)",
    "Dashboard with KPI Cards, OTB Chart, Recommendations Table",
    "Real Pricing Engine Integration (Ladder Strategy)",
    "Settings: Timezone, Fiscal Start Day, Ladder Config",
    "Comprehensive Guide/Help Page",
    "Excel Export",
    "SaaS Pro Light Theme (consistent across all pages)",
    "Google OAuth Authentication (NextAuth.js v5)",
    "Role-Based Access Control (super_admin/hotel_admin/manager/viewer)",
    "Multi-Hotel User Support with HotelSwitcher",
    "Admin Panel (Users + Hotels management)",
    "Blocked User auto sign-out",
    "Mobile Responsive Layout with Hamburger Menu",
    "Dashboard Cancellation Stats (Room-nights + Lost Revenue)",
    "Data Inspector Match Status Breakdown (Matched/Unmatched/Ambiguous)",
    "Login Page with 4TK Brand Colors (#204183, Glassmorphism)",
    "Sidebar Logout Button with User Info",
    "Consistent Gradient Headers across all pages (including Admin)",
    "V01.2: OTA Pricing Module - Calculate BAR from NET with commissions and promotions",
    "V01.2: Room Types Management (CRUD)",
    "V01.2: OTA Channels Configuration (commission, calc mode)",
    "V01.2: Promotions Tab (campaign picker, validation panel)",
    "V01.2: Overview Tab (price matrix, heatmap, CSV export)",
    "V01.2: Booking.com Promotions (Genius, Mobile, Deals) - 16 promotions with 2-layer architecture",
    "V01.2: Editable Discount Percentage - User can modify % per campaign",
    "V01.2: Demo Hotel - Default hotel for new users without assignment",
    "V01.2: User Phone Field - Contact number in user profile",
    "V01.2: Vendor-specific Discount Validation - Agoda 80% cap, Booking.com no limit",
    "Delete Data By Month - Super admin can delete reservations/cancellations by month with confirmation",
    "Cached Stats with TTL - 5-minute cache for reservation and cancellation statistics",
    "Top 3 Agents by Company Name - Groups agents from XML ClientName field",
    "All-time Cancellation Stats - Uses all data instead of 30-day filter for accurate display",
    "V01.2: Full 5-OTA Promotion Catalogs - Agoda(17), Booking(15), Traveloka(10), Trip.com(11), Expedia(8) = 61 total",
    "V01.2: OTA-Specific Validation Rules - Expedia ISOLATED, Trip.com ADDITIVE boxes, Booking Deep Deals no-stack",
    "V01.2: Promotion Descriptions - Each promo has description field from OTA Partner Hubs",
    "Auto-detect Hotel ID - Dashboard, Build OTB, Build Features, Forecast, Reset all auto-detect from reservation data",
    "Super Admin Demo Hotel Bypass - Super Admin sees all features (Settings, Guide) even on Demo Hotel",
    "Dashboard date-aware cancellation stats - uses OTB as_of_date instead of today for historical data",
    "Multi-Hotel Active Context - getActiveHotelId() prioritizes cookie > session > fallback. All pages use active hotel instead of auto-detect",
    "HotelSwitcher Dark Sidebar - Super Admin sees ALL hotels dropdown, dark theme matching sidebar, blue accent for active hotel",
    "Auto Demo Hotel Assignment - New users auto-assigned to Demo Hotel on first login (auth.ts jwt callback)",
    "OTB Date Display - Shows 'Chưa có dữ liệu' with amber styling when no OTB data exists",
    "Upload Hotel Banner - Upload page shows active hotel name + ID for clarity",
    "No-Hotel-Access Auto-Refresh - Page auto-refreshes session to trigger Demo Hotel assignment, Zalo support link",
    "V01.3: 4-Step Onboarding Wizard - Hotel Info → Pricing → Data Upload → Complete",
    "V01.3: Trial System - 7 days base + 7 days bonus for completing onboarding",
    "V01.3: Team Invite System - Token-based with rate limiting, expiration",
    "V01.3: Quota Management - Export/Team seat limits per subscription tier",
    "V01.3: Paywall Modal - Feature gating for export, team, audit",
    "V01.3: Data Validation Split - basicValidation (free) + auditReport (paid)",
    "V01.3: AuditTeaser Component - Upsell to Pro for full audit report",
    "V01.3: IP-based Rate Limiting - DB-backed, Vercel serverless safe",
    "V01.4: OTB Time-Travel Date Picker - Select historical as_of_date via URL (?as_of_date=YYYY-MM-DD)",
    "V01.4: OTB Snapshot APIs - GET list, POST build (single), POST backfill (batch)",
    "V01.4: Half-Open Cutoff Semantics - book_time < D+1 00:00, cancel_time >= D+1 00:00",
    "V01.4: Backfill with generate_series - Continuous calendar months, no gaps",
    "V01.4: Advisory Lock - pg_try_advisory_lock prevents concurrent builds",
    "V01.4: Chunked Backfill - Limit 3 snapshots/request for Vercel timeout safety",
    "Performance: Vercel Functions region icn1 (Seoul) matching Supabase DB region",
    "Performance: Prisma query logging (dev: query+warn+error, prod: warn+error)",
    "Performance: cachedStats.ts rewritten with aggregate/groupBy + hotel_id filter + 5-min TTL cache",
    "Performance: CancellationSection Promise.all + hotel_id filter (was 3 sequential queries)",
    "Performance: Dashboard batch merge 3→2 (cancellation query moved to batch 2)",
    "UX: Loading skeletons for Dashboard, Data, Pace & Pickup, So sánh giá pages",
    "Fix: Timezone bug in BuildFeatures - ISO string instead of Date object to prevent UTC+7 shift",
    "V01.5: OTA Growth Playbook - COMPLETE - 8 components integrated into Pricing page 'Tối ưu OTA' tab",
    "V01.5: OTAPlaybookGuide orchestrator with 6 sub-tabs (Scorecard, Booking, Agoda, ROI, Review, Boost)",
    "V01.5: BookingChecklist (411 lines) - 5 categories with localStorage persistence",
    "V01.5: AgodaChecklist (338 lines) - Content Score weights from Partner Hub",
    "V01.5: OTAHealthScorecard (223 lines) - Dual OTA weighted scoring with ScorecardInputModal",
    "V01.5: ROICalculator (263 lines) - Slider+input with Recharts bar chart visualization",
    "V01.5: ReviewCalculator (245 lines) - 2 modes: Official (no %) + Estimator (disclaimer)",
    "V01.5: WhenToBoost (251 lines) - 5 scenarios + Decision Log with localStorage",
    "V01.5: OTAGrowthPaywall - Premium gating for demo/non-paying users",
    "V01.5: Phase B (Booking APIs) conditional on Connectivity Partner access (currently paused)",
    "V01.5: Pricing page has 5 tabs: Hạng phòng, Kênh OTA, Khuyến mãi, Bảng giá, Tối ưu OTA",
    "Landing V2: Revenue-share messaging - 'No fixed salary, we earn % of revenue' as core message",
    "Landing V2: How It Works funnel (RMS → Pilot 30d → Done-for-you)",
    "Landing V2: Revenue Share Model - 4 pillars + transparency + media cost clarification",
    "Landing V2: Comparison Table - In-house vs 4TK (cost, risk, speed, tools, KPI)",
    "Landing V2: FAQ Accordion - 7 sensitive questions (%, revenue base, ads, contracts)",
    "Landing V2: Lead Form with qualifying fields (rooms, OCC/ADR, channels, PMS, needs)",
    "Landing V3: Professional visual overhaul - remove all emoji, SVG line-art icons",
    "Landing V3: Brand colors from logo (#204184 navy), Emerald accent, Gold secondary",
    "Landing V3: Inline SVG logo (white circle + 4TK) instead of dark PNG",
    "Excel (.xlsx) Upload Support - ingestCSV auto-detects CSV vs Excel format",
    "Split Excel Templates - Separate Booked and Cancelled templates with download links",
    "OTB Reset on Data Delete - Checkbox to clear OTB snapshots + FeaturesDaily when deleting month data",
    "Hotel Validation Before Import - Validates hotel_id exists before creating importJob (prevents FK errors)",
    "Friendly Upload Error Messages - Translates FK/unique/connection errors to Vietnamese",
    "Forecast as_of_date Alignment - RunForecast uses max(as_of_date) from features_daily instead of max(booking_date) from reservationsRaw",
    "Delete-by-month Hotel Filter - hotel_id in WHERE clause for both GET preview and DELETE operation",
    "V01.6: Booking.com 2-Layer Architecture - Engine groupType (GENIUS/TARGETED/PORTFOLIO/CAMPAIGN) separated from UI display labels",
    "V01.6: Free Nights Deal - Stay X / Pay Y input with auto-calculated discount % instead of manual entry",
    "V01.6: Stack Behavior Badges - Visual STACKABLE/EXCLUSIVE/HIGHEST_WINS indicators per promotion",
    "V01.6: 3-Tier Exclusion Engine - Campaign EXCLUSIVE→Business Bookers→Portfolio HIGHEST_WINS validation pipeline",
    "V01.6: Portfolio Highest-Wins Note - UI shows 'Booking chỉ áp dụng deal tốt nhất' below Portfolio group",
    "V01.6: Booking Toggle Label - 'Kết hợp giảm giá (lũy tiến theo Booking rules)' for Booking.com channels",
    "V01.7: Guide Page - Comprehensive OTA Pricing Section with 5-channel detailed documentation",
    "V01.7: Guide Dual Formulas - NET→BAR and BAR→NET with correct formulas per calc type",
    "V01.7: Guide Channel Cards - Agoda(ADDITIVE 20%), Booking(PROGRESSIVE 18%), Expedia(SINGLE_DISCOUNT 17%), Traveloka(ADDITIVE 15%), CTRIP(ADDITIVE 18%)",
    "V01.7: Guide Comparison Table - Quick comparison of all 5 channels: calc type, stacking, commission",
    "V01.7: Guide 3 Calc Types Explainer - Additive vs Progressive vs Single Discount with channel mapping",
    "V01.8: Dynamic Pricing by OCC - Occupancy-based tier pricing with season multipliers, guardrails (min_rate, max_discount), trace engine",
    "V01.8: OCC Tier Editor - CRUD with dirty-state tracking, inline row errors, beforeunload warning, disable Save when clean",
    "V01.8: Season Config Panel - Named seasons with date ranges, multiplier, color-coded labels",
    "V01.8: Season Rate Editor - Override BAR per room_type × season, import from CSV",
    "V01.8: Dynamic Pricing Matrix - Grid view (Room × Channel), cell-level guardrail borders (red left border + tooltip), sticky headers",
    "V01.8: Context Bar Chips - 3 chips: OCC% (blue/purple), Season (emerald/purple), Tier (indigo) + Override toggle",
    "V01.8: Cell Drill-Down Panel - Click cell → 320px side panel, read-only trace[], guardrail status, effective discount",
    "V01.8: Effective Discount Label - Shows 'Effective discount: X%' when BAR≠Display price, per-cell -X% tag",
    "V01.8: Enriched CSV Export - 8-line metadata header (hotel/channel/stayDate/season/occPct/tier/asOfTs/roundingStep) + viewMode-aware",
    "V01.8: Pricing page 6 tabs: Hạng phòng, Kênh OTA, Khuyến mãi, Bảng giá, Giá Linh Hoạt, Tối ưu OTA",
    "V01.8: Architecture doc ARCHITECTURE_PRICING.md - Describes engine pipeline, trace format, guardrail system",
    "V01.8: Golden tests pricing-golden.test.ts - Snapshot tests for pricing engine correctness",
    "V01.8: Lint script lint-pricing-architecture.ts - Validates no direct DB calls in engine, no client recompute",
    "V01.9: Phase 03 Unified Pricing — server-only engine as single source of truth, ~210 lines removed from PromotionsTab.tsx",
    "V01.9: usePricingPreview hook — AbortController for stale request cancellation, debounce 250ms, isRefreshing state",
    "V01.9: StackingResult type in engine.ts — ignored[] with human-readable reasons per dropped promo",
    "V01.9: PreviewResult enriched in service.ts — breakdown[], resolvedPromotions, calc_version v3.0.0",
    "V01.9: Promotions Tab loading states — Loader2 spinner replaces icons during refresh, opacity-60 transition",
    "V01.9: Golden tests expanded to 13 cases — Genius L1+L2 dedup, rounding tolerance ±1000, ignored[] verification",
    "V01.9: force-dynamic in calc-preview route.ts — prevents Next.js caching of pricing API responses",
    "V01.9: Booking.com 3-branch stacking — EXCLUSIVE (Deep Deal blocks ALL incl Genius), ONLY_WITH_GENIUS (Getaway + Genius), no-campaign (normal)",
    "V01.9: stackBehavior field propagated from catalog.ts through service.ts to engine.ts DiscountItem",
    "V01.9: Analytics tab redesign — charts-first layout, compact KPI strip with DOD inline, horizontal DatesToWatch chips",
    "V01.9: AnalyticsKpiRow compact strip — 7 metrics + DOD merged inline (~48px vs ~120px)",
    "V01.9: DatesToWatchPanel horizontal chip strip — scrollable pills (~48px vs ~200px vertical list)",
    "V01.9: InsightsPanel V2 Engine — 6 generators (compression, revenue_opportunity, pace_stly, pickup_acceleration, cancel_tiers, segment_mix) with top3 scoring",
    "V01.9: Insight Text Plain Vietnamese — All RM jargon (RN, ADR, STLY, OCC, pickup, forecast, uplift, RevPAR, segment, commission, leakage, promo) replaced with natural language",
    "V01.9: InsightsPanel 2-Tab Layout — Tab 1: Top actions + other insights, Tab 2: Ngày chú ý khác (compression extras). Pill-style tabs with count badges",
    "V01.9: Insight Card Labeled Sections — Expanded cards show Tình hình / Ý nghĩa / Nên làm / Tác động ước tính labels for GM readability",
    "V01.9: Forecast Data Fix — days30 limited to actual 30-day window, forecast query take:90 matching OTB coverage",
    "V02.0: Room Band Pricing — 4 bands (R30/R80/R150/R300P), org-level subscriptions, capacity_snapshot, price_multiplier",
    "V02.0: Auto-Sync Band on Capacity Change — deriveBand() runs after hotel capacity update in Settings + Admin API",
    "V02.0: Invite Management UI — Team page lists active invites with short codes, usage counts, expiry, revoke button",
    "V02.0: Sidebar Fix — /settings exact match only, /settings/team uses startsWith. No more double-highlight",
    "V02.0: Seat Counting Fix — checkSeatAvailability counts HotelUsers (not OrgMembers) for consistency with team page list",
    "V02.0: Team Page Seat Display — Shows 'X/Y thành viên (+N invite)' instead of inflated total",
    "V02.1: Booking.com Catalog IDs Fix — Aligned catalog.ts IDs with seed-pricing.ts to fix Campaign+Genius stacking bug",
    "V02.1: Trip.com Campaign Exclusive Stacking — Campaign deals block all other promos (engine resolveVendorStacking). If no Campaign, group-level dedup (max within Portfolio, max within Targeted)",
    "V02.1: Trip.com Campaign Badge — Shows 'Exclusive' (red) badge instead of 'Stackable' for CAMPAIGN group_type on Trip.com channels",
    "V02.1: Trip.com Campaign Warning Banner — Amber warning when Campaign blocks other active promos. Shown below Agoda stacking warning",
    "V02.1: PricingExplanation Server Trace — Uses previewData.trace[] from server (single source of truth) instead of local re-computation. Shows only resolved promos after stacking rules. Dropped promos shown in amber box with reasons",
    "V02.1: Step-by-Step VND Numbers — Each step (NET → Commission → Per-promo → BAR → Display → Net) shows actual formatted amounts for sales clarity",
    "V02.1: Round Favicon SVG — Replaced square PNG with circular SVG favicon",
    "V02.1: Self-Healing Catalog Pattern — service.ts + PromotionsTab.tsx prefer static catalog groupType over stale DB group_type. No DB migration needed. Applied to all 3 DiscountItem builders in service.ts and both card+table views in UI",
    "V02.1: Trip.com Promotions in catalog.ts — Added 11 CTRIP_PROMOTIONS (5 ESSENTIAL, 4 TARGETED, 1 Package, 1 CAMPAIGN) with stackBehavior EXCLUSIVE for Campaign. Included in _catalogMap + VENDOR_GROUP_LABELS + getPromotionsByVendor",
    "V02.1: Trip.com seed-pricing.ts Fix — Campaign group_type corrected from SEASONAL to CAMPAIGN, allow_stack from true to false",
    "V02.1: Pay-First Flow — Demo users can pay before creating hotel. hotel_id nullable in PaymentTransaction. Orphan payment detection + linking on onboarding completion",
    "V02.1: Orphan Payment API — /api/payments/pending-activation detects COMPLETED payments with null hotel_id",
    "V02.1: Onboarding Orphan Link — /api/onboarding/complete auto-links orphan payments to newly created hotel and activates subscription",
    "V02.1: PayPal One-Time Payment — create-order + capture-order API routes with dynamic USD pricing",
    "V02.1: Docs Updated to v01.9 — FSD, PRD_FRD, SRS, TECHNICAL_SPEC updated with payment gateway, pay-first flow, orphan payment sections",
    "V02.1: Dynamic Pricing Flow — Admin panel is single source of truth for all prices. Pricing page, PaymentMethodModal, SePay, PayPal all read from DB via getDynamicPrice()/getAllDynamicPrices()",
    "V02.1: GET /api/pricing/plans — Public API endpoint returning dynamic prices per tier for given room band. Used by pricing-plans page and PaymentMethodModal",
    "V02.1: Timezone Fix effective_from — datetime-local inputs parsed with +07:00 offset to prevent configs appearing as 'Scheduled' instead of 'Active'",
    "V02.1: Removed unstable_cache from pricing functions — Direct DB reads on every call (~5ms). Eliminates stale-cache problem. unstable_cache + revalidateTag incompatible with Next.js 16",
    "V02.1: Analytics Pipeline — 4-step engine: Cancel Stats → Build Features (w/ cancel forecast) → Demand Model V03 → Price Optimizer. All triggered via POST /api/analytics/pipeline",
    "V02.1: Cancel Forecast Engine — Bayesian smoothed cancel rates by lead-time bucket × segment × season. 6-level fallback chain. 41 unit tests.",
    "V02.1: Demand Model V03 — Weighted ensemble (pace 30%, pickup 25%, LY 20%, DOW 15%, season 10%). Returns demand_rooms, confidence_score, model_version.",
    "V02.1: Price Optimizer — OCC-based pricing with guardrails (min_rate, max_rate, max_daily_change). Respects PricingDecision overrides.",
    "V02.1: GM Dashboard V2 Phase A — TopAccountsTable (top 10 accounts by revenue + cancel rate), RoomLosMixPanel (donut + bar), LeadTimeBuckets (booking lead-time distribution)",
    "V02.1: Dashboard V2 panels integrated into Overview tab with Suspense wrapper in dashboard/page.tsx",
    "V02.1: Cancel-Aware Occupancy — dailyAction.ts uses net_remaining from FeaturesDaily for occupancy instead of raw capacity - roomsSold",
    "V02.1: Vercel Cron — /api/cron/check-subscription at 19:00 UTC (02:00 VN). Checks expired subs, syncs PayPal, 3-day grace for SePay, auto-expires PENDING txns",
    "V02.1: CancelForecastChart component — Visualizes predicted vs actual cancel rates on Analytics tab",
    "V02.1: FullPipelineButton — One-click trigger for complete analytics pipeline from Analytics tab"
  ],
  "cancellation_bridge_v011": {
    "status": "Implemented",
    "description": "Bridges cancellation records to reservations for accurate OTB calculation",
    "files": [
      "lib/normalize.ts - Key normalization (UPPER, TRIM, alphanumeric only)",
      "lib/cancellationBridge.ts - Bridge logic with matching, conflict resolution, DQ checks"
    ],
    "matching_algorithm": {
      "strategy": "take:2 for ambiguity detection",
      "order": [
        "last_modified_time desc",
        "book_time desc",
        "loaded_at desc"
      ],
      "keys": [
        "reservation_id_norm",
        "arrival_date",
        "room_code_norm (optional)"
      ]
    },
    "match_statuses": [
      "matched",
      "unmatched",
      "ambiguous",
      "conflict",
      "dq_issue",
      "unsupported_partial"
    ],
    "time_travel_otb": {
      "formula": "booking_date <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)",
      "book_time_fallback": "booking_date at 00:00:00 if book_time is null",
      "revenue_split": "total/nights per night, remainder to last night"
    }
  },
  "user_management_v01": {
    "status": "Implemented",
    "roles": {
      "super_admin": "Global admin - access all hotels, all features",
      "hotel_admin": "Per-hotel admin - full access within assigned hotels",
      "manager": "Per-hotel manager - view + some edit permissions",
      "viewer": "Per-hotel read-only access"
    },
    "pages": [
      "/admin/users - User management with create/assign modals",
      "/admin/hotels - Hotel management with create/edit modals",
      "/select-hotel - Multi-hotel picker for users with multiple assignments",
      "/blocked - Blocked user page (auto sign-out)",
      "/no-hotel-access - Users without hotel assignments",
      "/unauthorized - Permission denied page"
    ],
    "components": [
      "HotelSwitcher - Dropdown in sidebar to switch active hotel",
      "Sidebar - Hamburger menu on mobile, logout button with user info in footer",
      "LoginPage - Glassmorphism card with 4TK brand gradient background",
      "AdminPages - Gradient blue header matching Data Inspector style"
    ]
  },
  "decisions": [
    "Full-stack Next.js for MVP speed",
    "UUIDs for all Primary Keys (SaaS scalability)",
    "Append-Only reservations for audit trail",
    "Use Supabase for Database Hosting",
    "Heuristic Forecasting instead of ML for V01",
    "Ladder Pricing Strategy with configurable presets",
    "Use fast-xml-parser for server-side XML parsing",
    "Light SaaS Pro theme with lavender gray (#F5F7FB) background",
    "NextAuth.js v5 with Google OAuth for authentication",
    "JWT-based session with user role and accessible hotels",
    "httpOnly cookie for active hotel persistence",
    "HotelUser junction table for many-to-many user-hotel relationships",
    "Separate global role (User.role) and per-hotel role (HotelUser.role)",
    "V01.1: Bridge cancellations to reservations for accurate OTB",
    "V01.1: Use timestamptz for cancel_time and book_time",
    "V01.1: Time-travel OTB using asOfTs parameter",
    "V01.2: Progressive mode = BAR / (1-comm) / Π(1-dᵢ) - compounds discounts",
    "V01.2: Additive mode = BAR / (1-comm) / (1-Σdᵢ) - sums discounts",
    "V01.2: Validation rules: max 1 Seasonal, max 1 Targeted per subcategory",
    "V01.2: Vendor-specific max discount: Agoda 80%, Booking.com no limit",
    "V01.2: Booking.com promotions mapped to existing PromotionGroup types",
    "V01.2: Demo Hotel (ID: 159fe315-79a0-48a3-adac-f47d4f56b748) as fallback for new users",
    "V01.2: Traveloka Channel Rate - applied before campaigns (Additive mode, 15% commission)",
    "V01.2: Trip.com ADDITIVE mode - same box pick 1, different boxes stack additively (d₁+d₂+...)",
    "V01.2: Expedia ISOLATED mode - each promotion creates separate rate plan, no stacking",
    "V01.2: Booking.com Deep Deals (Limited-time, Deal of the Day) - allow_stack=false",
    "V01.6: 2-layer architecture for promotions: Engine layer = groupType + stackBehavior (source-of-truth for rules), UI layer = display labels (for GM usability)",
    "V01.6: GENIUS separated from TARGETED in PromotionGroup enum - Genius L1/L2/L3 are always stackable with everything",
    "V01.6: Campaign EXCLUSIVE blocks everything except Genius deals (Genius always passes through)",
    "V01.6: Business Bookers is EXCLUSIVE and blocks ALL including Genius (different from Campaign EXCLUSIVE)",
    "V01.6: Free Nights uses inverse formula: Stay X / Pay Y → discount_pct = round((1 - Y/X) × 100)",
    "V01.9: Booking.com 3-branch: EXCLUSIVE (Deep Deal/Black Friday) blocks ALL; ONLY_WITH_GENIUS (Getaway/Early2026) stacks with Genius only; no-campaign = normal stacking",
    "V01.9: stackBehavior from catalog propagated to DiscountItem — engine reads it for branch selection",
    "V01.9: Analytics charts-first layout — GM sees STLY+Supply immediately after KPI, Room Mix+LeadTime in row 4",
    "Auto-detect hotel_id from reservations_raw (groupBy most reservations) instead of env var DEFAULT_HOTEL_ID",
    "Super Admin bypasses Demo Hotel restrictions (Settings page, Guide page, OTA Growth tab)",
    "OTA Growth Playbook integrated into Pricing page (not Guide page) for logical grouping with OTA Pricing tabs",
    "Dashboard uses OTB as_of_date as reference date for cancellation stats and forecasts",
    "Multi-Hotel Active Context: getActiveHotelId() uses cookie→session→fallback chain with permission validation",
    "Super Admin fallback: first real hotel by created_at (skips Demo Hotel) for deterministic behavior",
    "Cookie is a preference, not authorization: server validates user has access to cookie hotel_id",
    "Auto-assign Demo Hotel: existing users with 0 hotel assignments get Demo Hotel automatically on login",
    "signIn callback creates user, jwt callback assigns Demo Hotel if needed (race condition fix)",
    "Performance: Vercel Functions must be in same region as DB (icn1=Seoul) to minimize query latency",
    "Performance: cachedStats used findMany + JS reduce without hotel_id filter = full table scan",
    "Performance: Dashboard had 3 sequential batches, batch 3 only needed actualOtbDate (known after batch 1)",
    "Performance: CancellationSection had 3 sequential queries without hotel_id = full table scan x3",
    "V01.8: Dynamic Pricing engine is pure function (no DB calls) — all data passed as params",
    "V01.8: Cell drill-down panel reads trace[] from API response — NO client-side recompute",
    "V01.8: CSV export includes metadata and respects current viewMode (BAR/Display/NET)",
    "V01.8: OCC tiers saved atomically via $transaction (delete all + create all)",
    "V01.8: Season date ranges validated server-side for no overlaps within same hotel",
    "V01.8: Guardrails are advisory (red border + tooltip) not blocking — GM can still save",
    "V01.9: Phase 03 — PromotionsTab.tsx must NOT contain any pricing math. Removed validate(), dedupeBySubcategory(), pickBestGenius(), all stacking logic",
    "V01.9: resolveTimingConflicts() moved server-side only — client reads validation.warnings from API response",
    "V01.9: usePricingPreview hook replaces all direct fetch() calls in PromotionsTab — single source of truth for preview data",
    "V01.9: AbortController cancels in-flight requests when user toggles promo rapidly — prevents race condition stale data",
    "V01.9: Insight text must use plain Vietnamese — no RM jargon. GM reads without asking anyone. Labels: Tình hình, Ý nghĩa, Nên làm, Tác động ước tính",
    "V01.9: InsightsPanel tabs auto-hide when no compression extras — single tab view if only top actions exist",
    "V01.9: insightsV2Engine days30 must filter by actual calendar date range (today + 30d), not use all input days",
    "V02.0: Org-based subscriptions: subscription.hotel_id must be used (not org_id) for current legacy compatibility",
    "V02.0: Seat counting changed from OrgMembers to HotelUsers — team page displayed 2 but count showed 3 due to OrgMember including org-level user not assigned to hotel",
    "V02.0: Auto-sync room_band uses $executeRaw instead of Prisma updateMany — bypasses stale Prisma client types during dev (DLL lock prevents regeneration)",
    "V02.0: Sidebar isActive: exact match for /settings, /dashboard; startsWith for all other routes",
    "V02.1: Trip.com Campaign = EXCLUSIVE in engine — BA confirmed: Campaign blocks Regular, Targeted, Package, Trip.plus. Only highest Campaign applied. If no Campaign → Portfolio max + Targeted max + additive others",
    "V02.1: PricingExplanation must NOT compute local math — was iterating all is_active campaigns (ignoring server dedup). Fixed: use previewData.trace[] which only includes server-resolved promos",
    "V02.1: Booking.com catalog.ts IDs must match seed-pricing.ts — Mismatch caused getCatalogItem() to return undefined → stackBehavior lost → wrong branch in resolveVendorStacking",
    "V02.1: Trip.com Campaign badge override — isTripCampaign check added to both card view (PromotionGroup) and table view badge logic in PromotionsTab.tsx",
    "V02.1: Self-healing catalog pattern — getCatalogItem(promoId).groupType takes priority over DB group_type in service.ts (3 builders) and PromotionsTab.tsx (2 views). No DB migration required. If catalog has correct groupType, engine and UI auto-correct even if DB is stale",
    "V02.1: Trip.com seed-pricing had group_type SEASONAL (should be CAMPAIGN) + allow_stack true (should be false) — root cause of 95% stacking bug. Engine checked d.group==='CAMPAIGN' but DB returned 'SEASONAL' so exclusive logic never fired",
    "V02.1: Trip.com missing from static catalog.ts — getCatalogItem() returned undefined → stackBehavior undefined → engine couldn't determine stacking rules. Fixed by adding CTRIP_PROMOTIONS array"
  ],
  "ui_design": {
    "theme": "SaaS Pro Light",
    "colors": {
      "background": "#F5F7FB (lavender gray)",
      "surface": "#ffffff (white cards)",
      "primary": "#1E3A8A (royal blue)",
      "sidebar": "#204184 (LOGO_BLUE)",
      "text": "#1e293b (dark gray)",
      "border": "slate-200/80"
    },
    "brand_colors": {
      "primary": "#204183 (from logo)",
      "dark": "#0B1E3A (deep background)",
      "mid": "#16325F (gradient middle)",
      "light": "#AABAD1 (hover/highlight)"
    },
    "components": {
      "surface": "rounded-2xl bg-white border border-slate-200/80 shadow-[0_1px_2px_rgba(16,24,40,0.06)]",
      "header": "rounded-2xl px-6 py-4 text-white shadow-sm background: linear-gradient(to right, #1E3A8A, #102A4C)",
      "container": "mx-auto max-w-[1400px] px-8 py-6 space-y-6",
      "sidebar": "fixed left-0 w-64 h-screen bg-[#204184] text-white (hidden on mobile with hamburger toggle)",
      "login_page": "Gradient background (#0B1E3A → #16325F → #204183), glassmorphism card (bg-white/10 backdrop-blur-xl)"
    },
    "responsive": {
      "breakpoint": "lg (1024px)",
      "mobile": "Hamburger menu in fixed header, sidebar slides from left, overlay for close",
      "desktop": "Fixed sidebar always visible, ml-64 for main content"
    }
  },
  "knowledge_items": {
    "gotchas": [
      "DOMParser is browser-only, use fast-xml-parser for Node.js",
      "Prisma Date comparison requires exact match - normalize to midnight",
      "Prisma generate fails while dev server running (file lock) - restart server",
      "PrismaClient cannot run in Edge Middleware - use API routes for DB calls",
      "Vercel monorepo: Must set Root Directory to 'apps/web' in Project Settings",
      "Vercel monorepo: Framework Preset must be 'Next.js', not 'Other'",
      "TypeScript IDE may need restart after prisma generate to pick up new types",
      "Admin pages need layout.tsx to include sidebar (app/admin/layout.tsx)",
      "V01.1: Prisma.ModelGetPayload<object> for inferred types",
      "V01.1: Use prisma.$transaction for atomic bridge updates",
      "JWT callback: Nested Prisma include fails silently in Edge runtime - use separate queries",
      "JWT callback: Only fetch user data on initial sign-in (when account is present), not every request",
      "Session stale: If user's hotel assignments changed, they must logout and login again to refresh JWT",
      "Cookie activeHotelId may point to invalid hotel - middleware clears it and redirects to /select-hotel",
      "React hydration mismatch warnings from browser extensions (Liner) - safe to ignore",
      "DEFAULT_HOTEL_ID env var may not match uploaded data - always auto-detect hotel_id from reservations_raw",
      "Dashboard/cancellation queries using today's date will miss historical data - use OTB as_of_date",
      "NEXT_PUBLIC_DEFAULT_HOTEL_ID removed from client components - use getActiveHotelData() server action instead",
      "signIn callback creates user → jwt callback sees user exists but 0 hotels → must auto-assign Demo Hotel in jwt",
      "/api/debug-user endpoint doesn't exist → no-hotel-access page was calling it → JSON parse error (HTML 404)",
      "OTB date used today's date as fallback when no data → misleading. Changed to null + 'Chưa có dữ liệu'",
      "HotelSwitcher white dropdown clashes with dark sidebar → redesigned with dark theme (bg-[#0f1d36])",
      "setHours(0,0,0,0) on Date object in client timezone (UTC+7) shifts date back 1 day when sent to server as UTC → use ISO string instead",
      "Next.js loading.tsx convention auto-shows skeleton during server data fetch → prevents user clicking repeatedly",
      "NEXTAUTH_URL on Vercel MUST be custom domain (rms.pakhos.com), NOT *.vercel.app — OAuth callback 404 DEPLOYMENT_NOT_FOUND",
      "Google OAuth redirect URI must match NEXTAUTH_URL — add https://rms.pakhos.com/api/auth/callback/google in Google Cloud Console",
      "Logo.png with transparent bg + dark content is invisible on dark navbar → use inline SVG instead",
      "Emoji icons (💹🏨) on hospitality landing page look unprofessional → use SVG line-art icons",
      "PowerShell does not support && operator — use semicolons (;) to chain commands",
      "ingestCSV was missing hotel validation → FK error on importJob.create if cookie has stale hotel_id",
      "RunForecast used max(booking_date) as as_of_date but features built with today's date → 0 results",
      "DeleteByMonth was not filtering by hotel_id → could delete data across all hotels",
      "OTB as_of_date = loaded_at (upload date), NOT booking_date → deleting by month of data doesn't delete OTB",
      "V01.6: PromotionGroup enum must be synced across 3 files: schema.prisma, types.ts, catalog.ts GROUP_COLORS/VENDOR_GROUP_LABELS",
      "V01.6: Free Nights X/Y inverse calc can produce rounding artifacts (e.g. Stay 7 / Pay 6 = 14.28% not 14%)",
      "V01.6: Git push can hang if credential helper dialog is hidden behind other windows — terminate after 15s and retry",
      "V01.6: catalog.ts constants are NOT used by /api/pricing/catalog — the API reads from DB (prisma.promotionCatalog). Must run seed-pricing.ts after updating catalog.ts",
      "V01.6: seed-pricing.ts group_type values must match catalog.ts groupType values — mismatch causes picker to show 0 items in tabs",
      "V01.7: Early Bird + Last-Minute are mutually exclusive — resolveTimingConflicts() must be applied in BOTH calc-matrix API AND PromotionsTab parent before totalDiscount computation",
      "V01.7: In bar_to_net mode, do NOT use calcNetFromBar() — it internally resolves conflicts creating double-discount mismatch. Compute NET=display×(1-commission%) directly",
      "V01.7: React controlled input: value={input || fallback} prevents clearing. Use value={input} directly + initialize default via useEffect on mode/room change",
      "V01.8: Git commit can hang when GPG sign is configured but agent is hidden — use --no-gpg-sign flag or terminate after 30s",
      "V01.8: PowerShell && operator not supported in older versions — use semicolons (;) to chain commands",
      "V01.8: UUPM skill installed to .agent/skills/ (project-level) not global — __pycache__ should be gitignored",
      "V01.9: PromotionsTab.tsx client-side pricing math causes drift from server engine — MUST use usePricingPreview hook instead",
      "V01.9: AbortController abort() fires before new fetch starts — check signal.aborted in response handler to avoid stale state",
      "V01.9: calc-preview route without force-dynamic gets cached by Next.js — add export const dynamic = 'force-dynamic'",
      "V01.9: Booking.com stackBehavior must be propagated in 3 places in service.ts (genius, targeted, portfolio) — missing any one silently defaults to EXCLUSIVE",
      "V01.9: Analytics DodChips import must be removed from AnalyticsTabContent when DOD is merged into KPI strip — unused import causes build warning",
      "V02.0: Prisma $executeRaw needed to update room_band field because DLL lock prevents prisma generate → stale types → lint errors on new fields",
      "V02.0: Sidebar /settings double-highlight: pathname.startsWith('/settings') matches both /settings and /settings/team → must use exact match for /settings",
      "V02.0: OrgMember count > HotelUser count when org has users not assigned to specific hotel → seat count inflated",
      "V02.1: seed-pricing.ts group_type must match engine expectations — tripcom-campaign-2026 had SEASONAL but engine checks d.group==='CAMPAIGN'. Root cause: data bug not logic bug",
      "V02.1: catalog.ts MUST include ALL vendors — Trip.com was missing → getCatalogItem() returned undefined → stackBehavior lost → wrong branch in resolveVendorStacking",
      "V02.1: Self-healing pattern needed in BOTH server (service.ts) AND client (PromotionsTab.tsx) — fixing only server fixes calculation but UI badges/labels still read stale DB values",
      "V02.1: Campaign type field used in 3 separate places in PromotionsTab.tsx (card view line 176, table view badge line 1365, table group pill line 1372) — must fix ALL or UI still shows wrong labels",
      "V02.1: datetime-local input sends value WITHOUT timezone (e.g. '2026-02-16T16:20'). new Date() parses as UTC → 7h ahead in Vietnam → config becomes 'Scheduled' instead of 'Active'. Fix: append '+07:00'",
      "V02.1: unstable_cache + revalidateTag incompatible with Next.js 16 (revalidateTag requires 2 args). Removed both — pricing functions now read fresh from DB on every call",
      "V02.1: PricingTab form 'Thêm mới' (Add New) creates NEW config but doesn't deactivate old one → two Active configs for same tier. User must Edit existing config or Delete old one first",
      "V02.1: getAllDynamicPrices quarterly value is already per-month discounted price — do NOT divide by 3 again in UI (was causing 990000/2/3=165000 instead of 990000/2=495000)"
    ],
    "formulas": {
      "rooms_otb": "SUM(num_rooms) from reservations for that stay_date",
      "remaining_supply": "Capacity − rooms_otb",
      "adr": "revenue_otb ÷ rooms_otb",
      "recommended_price": "PricingLogic.optimize(ADR, forecast_demand, remaining_supply)",
      "time_travel_active": "book_time <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)"
    },
    "data_pipeline": {
      "step1": "Upload CSV/Excel/XML → reservations_raw (auto-detect format)",
      "step1b": "Upload Cancellation XML → cancellations_raw → Bridge → reservations_raw",
      "step2": "Build OTB (time-travel, as_of_date = loaded_at) → daily_otb",
      "step3": "Build Cancel Stats → cancel_rate_stats (by lead-time bucket × segment × season)",
      "step4": "Build Features (as_of_date = today) → features_daily (incl. expected_cxl, net_remaining via cancel forecast engine)",
      "step5": "Run Demand Forecast (demandModelV03) → demand_forecast",
      "step6": "Run Price Optimizer → price_recommendations (OCC-based with guardrails)",
      "full_pipeline": "POST /api/analytics/pipeline — runs steps 3→4→5→6 sequentially"
    }
  }
}