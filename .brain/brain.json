{
  "meta": {
    "schema_version": "2.0.0",
    "awf_version": "4.1.2",
    "last_updated": "2026-02-14T22:26:00+07:00"
  },
  "project": {
    "name": "revenue-management-system",
    "type": "SaaS Web App",
    "status": "Production - Deployed to Vercel (icn1 region)",
    "description": "RMS Version 02.0 - Revenue Management System with Room Band Pricing + Organization-based Multi-Hotel (C√°ch 2) + OTB Time-Travel + OTA Pricing + Dynamic Pricing by OCC + Unified Pricing Logic + InsightsPanel V2 (plain Vietnamese). Full-stack TypeScript.",
    "github": "https://github.com/4tkhospitality/revenue-managment-system",
    "landing_page": {
      "path": "apps/landing",
      "framework": "Next.js 16.1.6 (App Router)",
      "domain": "pakhos.com / www.pakhos.com",
      "status": "V3 - Professional Visual Overhaul pushed to GitHub, pending Vercel deployment",
      "design": {
        "palette": "Navy #204184 (from logo) + Emerald #10b981 + Gold #d4a24e",
        "typography": "Inter (Google Fonts)",
        "icons": "Inline SVG line-art (no emoji)",
        "logo": "Inline SVG (white circle + 4TK text) ‚Äî not PNG"
      },
      "i18n": "Vietnamese (vi.ts) + English (en.ts) with toggle",
      "sections": "Hero, How It Works, Revenue Share Model, Comparison Table, Technology, Results, Case Studies, Clients, Team, FAQ, Lead Form, Footer",
      "api": "/api/lead (POST ‚Äî validates fields, logs lead, placeholder for Resend email)"
    }
  },
  "tech_stack": {
    "frontend": {
      "framework": "Next.js 16.1.6 (App Router + Turbopack)",
      "language": "TypeScript",
      "styling": "Tailwind CSS",
      "components": "Custom + Lucide Icons",
      "charts": "Recharts",
      "theme": "Light SaaS Pro (lavender gray #F5F7FB, white surfaces, subtle shadows)"
    },
    "backend": {
      "framework": "Next.js Server Actions + API Routes",
      "auth": "NextAuth.js v5 (Google OAuth)",
      "csv_parser": "Papaparse",
      "xml_parser": "fast-xml-parser",
      "forecasting": "Heuristic (TS)",
      "pricing": "Ladder Pricing Strategy (TS)"
    },
    "database": {
      "type": "PostgreSQL 16",
      "orm": "Prisma 5.10.2",
      "hosting": "Supabase"
    },
    "deployment": {
      "vcs": "GitHub",
      "hosting": "Vercel",
      "tools": "Docker, Shell Scripts",
      "strategy": "Git-based Auto Deploy",
      "vercel_config": {
        "root_directory": "apps/web",
        "framework": "Next.js",
        "build_command": "npm run build (auto)",
        "output_directory": "Next.js default",
        "region": "icn1 (Seoul - same as Supabase DB ap-northeast-2)",
        "env_vars": [
          "DATABASE_URL",
          "DIRECT_URL",
          "DEFAULT_HOTEL_ID",
          "NEXT_PUBLIC_DEFAULT_HOTEL_ID",
          "GOOGLE_CLIENT_ID",
          "GOOGLE_CLIENT_SECRET",
          "ADMIN_EMAIL"
        ]
      }
    }
  },
  "database_schema": {
    "summary": "RMS Schema V02.0: Organization-based multi-tenancy (C√°ch 2) with Room Band Pricing. Subscription owned by Org, not Hotel. Seats counted at OrgMember level.",
    "tables": [
      {
        "name": "hotels",
        "description": "Tenant root. Stores hotel metadata, capacity, pricing config, timezone, ladder_steps."
      },
      {
        "name": "users",
        "description": "System users with global role (super_admin/viewer) and is_active flag.",
        "v01_changes": "Added UserRole enum, is_active field, hotel_users relation",
        "v012_changes": "Added phone field for contact number"
      },
      {
        "name": "hotel_users",
        "description": "Junction table for User-Hotel many-to-many with per-hotel roles (hotel_admin/manager/viewer).",
        "v01_new": true
      },
      {
        "name": "import_jobs",
        "description": "Tracks CSV/XML file uploads and processing status."
      },
      {
        "name": "reservations_raw",
        "description": "Append-only raw booking data from PMS. Linked to ImportJob.",
        "v011_changes": "Added book_time, cancel_time, cancel_reason, cancel_source, last_modified_time, reservation_id_norm, room_code, room_code_norm. FK from cancellations_raw."
      },
      {
        "name": "cancellations_raw",
        "description": "Cancellation records from Crystal Reports XML. Linked to ImportJob.",
        "v011_changes": "Added folio_num_norm, room_code_norm, matched_reservation_id (FK), matched_at, match_status, match_notes. Unique constraint uq_cancel_event."
      },
      {
        "name": "daily_otb",
        "description": "Fact table. Snapshots of OTB by stay_date. Built from reservations with time-travel logic."
      },
      {
        "name": "features_daily",
        "description": "Computed features (Pickup T30/15/7/5, Pace, Weekend, Month)."
      },
      {
        "name": "demand_forecast",
        "description": "Forecast outputs. Remaining Demand predictions."
      },
      {
        "name": "price_recommendations",
        "description": "Pricing engine outputs. Suggestions for GM."
      },
      {
        "name": "pricing_decisions",
        "description": "Audit log of user actions (Accept/Override)."
      },
      {
        "name": "room_types",
        "description": "V01.2: Room types with NET base prices for OTA pricing.",
        "v012_new": true
      },
      {
        "name": "ota_channels",
        "description": "V01.2: OTA channels with commission rates and calc mode (Progressive/Additive).",
        "v012_new": true
      },
      {
        "name": "promotion_catalog",
        "description": "V01.2: Global promotion templates for 5 OTAs. 61 promotions total (Agoda:17, Booking:15, Traveloka:10, Trip.com:11, Expedia:8). Includes allow_stack, description fields.",
        "v012_new": true
      },
      {
        "name": "campaign_instances",
        "description": "V01.2: Links promotions to OTA channels per hotel.",
        "v012_new": true
      },
      {
        "name": "pricing_settings",
        "description": "V01.2: Hotel-specific pricing settings (currency, rounding, max discount).",
        "v012_new": true
      },
      {
        "name": "hotel_invites",
        "description": "V01.3: Team invite system. Token-based with hashed storage, expiration, rate limiting.",
        "v013_new": true
      },
      {
        "name": "product_events",
        "description": "V01.3: Product analytics tracking. User actions, trial triggers, exports.",
        "v013_new": true
      },
      {
        "name": "rate_limit_hits",
        "description": "V01.3: IP-based rate limiting table (Vercel-safe, no in-memory).",
        "v013_new": true
      },
      {
        "name": "subscriptions",
        "description": "V02.0: Org-level subscription with plan (STANDARD/SUPERIOR/DELUXE/SUITE), room_band (R30/R80/R150/R300P), capacity_snapshot, price_multiplier. Owned by org_id (not hotel_id).",
        "v020_updated": true
      },
      {
        "name": "organizations",
        "description": "V02.0: Tenant root for multi-hotel. Every hotel belongs to 1 org. Subscription is per-org. Has name, slug.",
        "v020_new": true
      },
      {
        "name": "org_members",
        "description": "V02.0: User-Org membership with OrgRole (OWNER/ADMIN/MEMBER). Seats counted here. Unique(org_id, user_id).",
        "v020_new": true
      },
      {
        "name": "occ_tiers",
        "description": "V01.8: Occupancy-based pricing tiers. Each tier has label, occ_min/occ_max (0-1), multiplier. Per-hotel. Indexed by hotel_id.",
        "v018_new": true
      },
      {
        "name": "seasons",
        "description": "V01.8: Named date ranges (Peak, Shoulder, Off-Peak, Tet, etc) with multiplier. Per-hotel. Validates no overlapping date ranges.",
        "v018_new": true
      },
      {
        "name": "season_rates",
        "description": "V01.8: Override BAR per room_type √ó season. Links to seasons and room_types. Unique constraint on (season_id, room_type_id).",
        "v018_new": true
      }
    ],
    "enums": [
      {
        "name": "UserRole",
        "values": [
          "super_admin",
          "hotel_admin",
          "manager",
          "viewer"
        ],
        "description": "Role hierarchy: super_admin > hotel_admin > manager > viewer"
      },
      {
        "name": "CalcType",
        "values": [
          "PROGRESSIVE",
          "ADDITIVE",
          "SINGLE_DISCOUNT"
        ],
        "description": "V01.2: BAR calculation mode. PROGRESSIVE = NET/(1-comm)/Œ†(1-d·µ¢), ADDITIVE = NET/(1-comm)/(1-Œ£d·µ¢), SINGLE_DISCOUNT = only highest discount applied"
      },
      {
        "name": "PromotionGroup",
        "values": [
          "SEASONAL",
          "ESSENTIAL",
          "TARGETED",
          "GENIUS",
          "PORTFOLIO",
          "CAMPAIGN"
        ],
        "description": "V01.6: 2-layer architecture. Engine layer (source-of-truth for stacking): SEASONAL/ESSENTIAL/TARGETED/GENIUS/PORTFOLIO/CAMPAIGN. UI layer: vendor-specific display labels."
      },
      {
        "name": "StackBehavior (TS type)",
        "values": [
          "STACKABLE",
          "HIGHEST_WINS",
          "EXCLUSIVE",
          "ONLY_WITH_GENIUS"
        ],
        "description": "V01.6: Engine-layer stacking rule per promotion. STACKABLE=combines with others, HIGHEST_WINS=portfolio pick best, EXCLUSIVE=blocks all, ONLY_WITH_GENIUS=blocks all except Genius."
      },
      {
        "name": "CalcMode (per channel defaults)",
        "values": [
          "ADDITIVE (Agoda 20%, Traveloka 15%, CTRIP 18%)",
          "PROGRESSIVE (Booking.com 18%)",
          "SINGLE_DISCOUNT (Expedia 17% - no stacking)"
        ],
        "description": "OTA-specific calculation modes for promotion stacking. Source of truth: lib/pricing/seed-defaults.ts"
      },
      {
        "name": "RoomBand",
        "values": [
          "R30",
          "R80",
          "R150",
          "R300P"
        ],
        "description": "V02.0: Room count bands for pricing. R30=‚â§30, R80=31-80, R150=81-150, R300P=151-300+."
      },
      {
        "name": "OrgRole",
        "values": [
          "OWNER",
          "ADMIN",
          "MEMBER"
        ],
        "description": "V02.0: Organization-level role. OWNER=billing admin, ADMIN=manage members, MEMBER=access."
      },
      {
        "name": "SubscriptionStatus",
        "values": [
          "ACTIVE",
          "CANCELLED",
          "PAST_DUE"
        ],
        "description": "V02.0: Subscription lifecycle status."
      }
    ],
    "v011_indexes": [
      "idx_res_raw_match1 (hotel_id, reservation_id_norm, arrival_date, room_code_norm)",
      "idx_res_raw_match2 (hotel_id, reservation_id_norm, arrival_date)",
      "idx_res_raw_otb (hotel_id, book_time, cancel_time, arrival_date, departure_date)",
      "idx_cancel_match_status (hotel_id, match_status)",
      "uq_cancel_event (hotel_id, folio_num_norm, arrival_date, cancel_time)"
    ]
  },
  "api_endpoints": [
    {
      "path": "Server Action: ingestCSV",
      "explained": "Processes uploaded CSV, validates rows, saves to reservations_raw."
    },
    {
      "path": "Server Action: ingestXML",
      "explained": "Parses Crystal Reports PMS XML format. Aggregates by ConfirmNum."
    },
    {
      "path": "Server Action: ingestCancellationXml",
      "explained": "V01.1: Parses cancellation XML, normalizes keys, runs bridge to match reservations.",
      "v011_new": true
    },
    {
      "path": "Server Action: buildDailyOTB",
      "explained": "V01.1: Time-travel OTB with asOfTs, book_time fallback, revenue split per night.",
      "v011_updated": true
    },
    {
      "path": "Server Action: backfillOTB",
      "explained": "V01.1: Backfill OTB snapshots for historical dates.",
      "v011_new": true
    },
    {
      "path": "POST /api/user/switch-hotel",
      "explained": "Sets active hotel via httpOnly cookie (rms_active_hotel).",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/users",
      "explained": "List all users with hotel assignments (super_admin only).",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/users",
      "explained": "Create new user with optional hotel assignments.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]",
      "explained": "Update user role, is_active status.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/users/[id]/hotels",
      "explained": "Replace user's hotel assignments.",
      "v01_new": true
    },
    {
      "path": "GET /api/admin/hotels",
      "explained": "List all hotels with user counts.",
      "v01_new": true
    },
    {
      "path": "POST /api/admin/hotels",
      "explained": "Create new hotel.",
      "v01_new": true
    },
    {
      "path": "PUT /api/admin/hotels/[id]",
      "explained": "Update hotel settings.",
      "v01_new": true
    },
    {
      "path": "GET /api/pricing/room-types",
      "explained": "V01.2: List room types for active hotel.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/room-types",
      "explained": "V01.2: Create room type with NET price.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/room-types/[id]",
      "explained": "V01.2: Update or delete room type.",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/ota-channels",
      "explained": "V01.2: List OTA channels with active campaigns.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/ota-channels",
      "explained": "V01.2: Create OTA channel with commission and calc mode.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/ota-channels/[id]",
      "explained": "V01.2: Update or delete OTA channel.",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/campaigns",
      "explained": "V01.2: List campaigns (promo instances) for hotel.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/campaigns",
      "explained": "V01.2: Create campaign linking promo to OTA channel.",
      "v012_new": true
    },
    {
      "path": "PATCH/DELETE /api/pricing/campaigns/[id]",
      "explained": "V01.2: Update or delete campaign.",
      "v012_new": true
    },
    {
      "path": "POST /api/pricing/calc-matrix",
      "explained": "V01.2: Calculate full price matrix (RoomTypes √ó Channels).",
      "v012_new": true
    },
    {
      "path": "GET /api/pricing/catalog",
      "explained": "V01.2: Get promotion catalog by vendor (agoda, booking, traveloka, ctrip, expedia).",
      "v012_updated": true
    },
    {
      "path": "POST /api/onboarding",
      "explained": "V01.3: Create hotel during onboarding wizard, auto-create subscription.",
      "v013_new": true
    },
    {
      "path": "POST /api/onboarding/complete",
      "explained": "V01.3: Mark onboarding complete, extend trial by 7 bonus days.",
      "v013_new": true
    },
    {
      "path": "POST /api/trial/activate",
      "explained": "V01.3: Trigger 7-day trial after quality import (‚â•10 reservations).",
      "v013_new": true
    },
    {
      "path": "POST /api/invite/create",
      "explained": "V01.3: Create team invite with token, role, expiration.",
      "v013_new": true
    },
    {
      "path": "POST /api/invite/redeem",
      "explained": "V01.3: Redeem invite token with rate limiting and atomic transaction.",
      "v013_new": true
    },
    {
      "path": "GET /api/otb/snapshots",
      "explained": "V01.4: List available OTB snapshots with row count per as_of_date.",
      "v014_new": true
    },
    {
      "path": "POST /api/otb/snapshots/build",
      "explained": "V01.4: Build single OTB snapshot with advisory lock. Supports rebuild flag.",
      "v014_new": true
    },
    {
      "path": "POST /api/otb/snapshots/backfill",
      "explained": "V01.4: Batch backfill snapshots with generate_series, chunking (limit=3), missing_only.",
      "v014_new": true
    },
    {
      "path": "POST /api/lead (landing)",
      "explained": "Landing page lead form submission. Validates required fields (name/email/phone/hotel/rooms), logs lead summary, placeholder for Resend email.",
      "v02_new": true
    },
    {
      "path": "GET /api/features/latest-date",
      "explained": "Returns max(as_of_date) from features_daily for a hotel. Used by RunForecast to align with Build Features.",
      "v02_new": true
    },
    {
      "path": "DELETE /api/data/delete-by-month?includeOtb=true",
      "explained": "Deletes reservations, cancellations, and optionally OTB+FeaturesDaily by month. Hotel_id filtered.",
      "v02_new": true
    },
    {
      "path": "GET/POST /api/pricing/occ-tiers",
      "explained": "V01.8: CRUD occupancy tiers per hotel. POST replaces all tiers atomically in transaction.",
      "v018_new": true
    },
    {
      "path": "GET/POST /api/pricing/seasons + DELETE /api/pricing/seasons/[id]",
      "explained": "V01.8: CRUD seasons per hotel. Validates no overlapping date ranges.",
      "v018_new": true
    },
    {
      "path": "GET/POST /api/pricing/season-rates + POST /api/pricing/season-rates/import",
      "explained": "V01.8: Season rate overrides per room_type√óseason. Import bulk-creates rates.",
      "v018_new": true
    },
    {
      "path": "POST /api/pricing/dynamic-matrix",
      "explained": "V01.8: Calculate dynamic pricing matrix. Returns per-cell finalPrice, trace[], violations[], effectiveDiscount. Inputs: room_types, channels, campaigns, occ_tiers, seasons, stayDate.",
      "v018_new": true
    },
    {
      "path": "POST /api/pricing/calc-preview",
      "explained": "V01.8: Quick preview of pricing for a single room√óchannel with full trace.",
      "v018_new": true
    }
  ],
  "features": [
    "PMS-agnostic CSV Import",
    "Crystal Reports XML Import",
    "Cancellation XML Import with Auto-Bridge (V01.1)",
    "Data Inspector Page with Build OTB, Build Features, Run Forecast buttons",
    "Reset & Rebuild Button (clears derived data)",
    "Import Jobs Pagination (10/page)",
    "Daily OTB Time-Travel with asOfTs (V01.1)",
    "Dashboard with KPI Cards, OTB Chart, Recommendations Table",
    "Real Pricing Engine Integration (Ladder Strategy)",
    "Settings: Timezone, Fiscal Start Day, Ladder Config",
    "Comprehensive Guide/Help Page",
    "Excel Export",
    "SaaS Pro Light Theme (consistent across all pages)",
    "Google OAuth Authentication (NextAuth.js v5)",
    "Role-Based Access Control (super_admin/hotel_admin/manager/viewer)",
    "Multi-Hotel User Support with HotelSwitcher",
    "Admin Panel (Users + Hotels management)",
    "Blocked User auto sign-out",
    "Mobile Responsive Layout with Hamburger Menu",
    "Dashboard Cancellation Stats (Room-nights + Lost Revenue)",
    "Data Inspector Match Status Breakdown (Matched/Unmatched/Ambiguous)",
    "Login Page with 4TK Brand Colors (#204183, Glassmorphism)",
    "Sidebar Logout Button with User Info",
    "Consistent Gradient Headers across all pages (including Admin)",
    "V01.2: OTA Pricing Module - Calculate BAR from NET with commissions and promotions",
    "V01.2: Room Types Management (CRUD)",
    "V01.2: OTA Channels Configuration (commission, calc mode)",
    "V01.2: Promotions Tab (campaign picker, validation panel)",
    "V01.2: Overview Tab (price matrix, heatmap, CSV export)",
    "V01.2: Booking.com Promotions (Genius, Mobile, Deals) - 16 promotions with 2-layer architecture",
    "V01.2: Editable Discount Percentage - User can modify % per campaign",
    "V01.2: Demo Hotel - Default hotel for new users without assignment",
    "V01.2: User Phone Field - Contact number in user profile",
    "V01.2: Vendor-specific Discount Validation - Agoda 80% cap, Booking.com no limit",
    "Delete Data By Month - Super admin can delete reservations/cancellations by month with confirmation",
    "Cached Stats with TTL - 5-minute cache for reservation and cancellation statistics",
    "Top 3 Agents by Company Name - Groups agents from XML ClientName field",
    "All-time Cancellation Stats - Uses all data instead of 30-day filter for accurate display",
    "V01.2: Full 5-OTA Promotion Catalogs - Agoda(17), Booking(15), Traveloka(10), Trip.com(11), Expedia(8) = 61 total",
    "V01.2: OTA-Specific Validation Rules - Expedia ISOLATED, Trip.com ADDITIVE boxes, Booking Deep Deals no-stack",
    "V01.2: Promotion Descriptions - Each promo has description field from OTA Partner Hubs",
    "Auto-detect Hotel ID - Dashboard, Build OTB, Build Features, Forecast, Reset all auto-detect from reservation data",
    "Super Admin Demo Hotel Bypass - Super Admin sees all features (Settings, Guide) even on Demo Hotel",
    "Dashboard date-aware cancellation stats - uses OTB as_of_date instead of today for historical data",
    "Multi-Hotel Active Context - getActiveHotelId() prioritizes cookie > session > fallback. All pages use active hotel instead of auto-detect",
    "HotelSwitcher Dark Sidebar - Super Admin sees ALL hotels dropdown, dark theme matching sidebar, blue accent for active hotel",
    "Auto Demo Hotel Assignment - New users auto-assigned to Demo Hotel on first login (auth.ts jwt callback)",
    "OTB Date Display - Shows 'Ch∆∞a c√≥ d·ªØ li·ªáu' with amber styling when no OTB data exists",
    "Upload Hotel Banner - Upload page shows active hotel name + ID for clarity",
    "No-Hotel-Access Auto-Refresh - Page auto-refreshes session to trigger Demo Hotel assignment, Zalo support link",
    "V01.3: 4-Step Onboarding Wizard - Hotel Info ‚Üí Pricing ‚Üí Data Upload ‚Üí Complete",
    "V01.3: Trial System - 7 days base + 7 days bonus for completing onboarding",
    "V01.3: Team Invite System - Token-based with rate limiting, expiration",
    "V01.3: Quota Management - Export/Team seat limits per subscription tier",
    "V01.3: Paywall Modal - Feature gating for export, team, audit",
    "V01.3: Data Validation Split - basicValidation (free) + auditReport (paid)",
    "V01.3: AuditTeaser Component - Upsell to Pro for full audit report",
    "V01.3: IP-based Rate Limiting - DB-backed, Vercel serverless safe",
    "V01.4: OTB Time-Travel Date Picker - Select historical as_of_date via URL (?as_of_date=YYYY-MM-DD)",
    "V01.4: OTB Snapshot APIs - GET list, POST build (single), POST backfill (batch)",
    "V01.4: Half-Open Cutoff Semantics - book_time < D+1 00:00, cancel_time >= D+1 00:00",
    "V01.4: Backfill with generate_series - Continuous calendar months, no gaps",
    "V01.4: Advisory Lock - pg_try_advisory_lock prevents concurrent builds",
    "V01.4: Chunked Backfill - Limit 3 snapshots/request for Vercel timeout safety",
    "Performance: Vercel Functions region icn1 (Seoul) matching Supabase DB region",
    "Performance: Prisma query logging (dev: query+warn+error, prod: warn+error)",
    "Performance: cachedStats.ts rewritten with aggregate/groupBy + hotel_id filter + 5-min TTL cache",
    "Performance: CancellationSection Promise.all + hotel_id filter (was 3 sequential queries)",
    "Performance: Dashboard batch merge 3‚Üí2 (cancellation query moved to batch 2)",
    "UX: Loading skeletons for Dashboard, Data, Pace & Pickup, So s√°nh gi√° pages",
    "Fix: Timezone bug in BuildFeatures - ISO string instead of Date object to prevent UTC+7 shift",
    "V01.5: OTA Growth Playbook - COMPLETE - 8 components integrated into Pricing page 'T·ªëi ∆∞u OTA' tab",
    "V01.5: OTAPlaybookGuide orchestrator with 6 sub-tabs (Scorecard, Booking, Agoda, ROI, Review, Boost)",
    "V01.5: BookingChecklist (411 lines) - 5 categories with localStorage persistence",
    "V01.5: AgodaChecklist (338 lines) - Content Score weights from Partner Hub",
    "V01.5: OTAHealthScorecard (223 lines) - Dual OTA weighted scoring with ScorecardInputModal",
    "V01.5: ROICalculator (263 lines) - Slider+input with Recharts bar chart visualization",
    "V01.5: ReviewCalculator (245 lines) - 2 modes: Official (no %) + Estimator (disclaimer)",
    "V01.5: WhenToBoost (251 lines) - 5 scenarios + Decision Log with localStorage",
    "V01.5: OTAGrowthPaywall - Premium gating for demo/non-paying users",
    "V01.5: Phase B (Booking APIs) conditional on Connectivity Partner access (currently paused)",
    "V01.5: Pricing page has 5 tabs: H·∫°ng ph√≤ng, K√™nh OTA, Khuy·∫øn m√£i, B·∫£ng gi√°, T·ªëi ∆∞u OTA",
    "Landing V2: Revenue-share messaging - 'No fixed salary, we earn % of revenue' as core message",
    "Landing V2: How It Works funnel (RMS ‚Üí Pilot 30d ‚Üí Done-for-you)",
    "Landing V2: Revenue Share Model - 4 pillars + transparency + media cost clarification",
    "Landing V2: Comparison Table - In-house vs 4TK (cost, risk, speed, tools, KPI)",
    "Landing V2: FAQ Accordion - 7 sensitive questions (%, revenue base, ads, contracts)",
    "Landing V2: Lead Form with qualifying fields (rooms, OCC/ADR, channels, PMS, needs)",
    "Landing V3: Professional visual overhaul - remove all emoji, SVG line-art icons",
    "Landing V3: Brand colors from logo (#204184 navy), Emerald accent, Gold secondary",
    "Landing V3: Inline SVG logo (white circle + 4TK) instead of dark PNG",
    "Excel (.xlsx) Upload Support - ingestCSV auto-detects CSV vs Excel format",
    "Split Excel Templates - Separate Booked and Cancelled templates with download links",
    "OTB Reset on Data Delete - Checkbox to clear OTB snapshots + FeaturesDaily when deleting month data",
    "Hotel Validation Before Import - Validates hotel_id exists before creating importJob (prevents FK errors)",
    "Friendly Upload Error Messages - Translates FK/unique/connection errors to Vietnamese",
    "Forecast as_of_date Alignment - RunForecast uses max(as_of_date) from features_daily instead of max(booking_date) from reservationsRaw",
    "Delete-by-month Hotel Filter - hotel_id in WHERE clause for both GET preview and DELETE operation",
    "V01.6: Booking.com 2-Layer Architecture - Engine groupType (GENIUS/TARGETED/PORTFOLIO/CAMPAIGN) separated from UI display labels",
    "V01.6: Free Nights Deal - Stay X / Pay Y input with auto-calculated discount % instead of manual entry",
    "V01.6: Stack Behavior Badges - Visual STACKABLE/EXCLUSIVE/HIGHEST_WINS indicators per promotion",
    "V01.6: 3-Tier Exclusion Engine - Campaign EXCLUSIVE‚ÜíBusiness Bookers‚ÜíPortfolio HIGHEST_WINS validation pipeline",
    "V01.6: Portfolio Highest-Wins Note - UI shows 'Booking ch·ªâ √°p d·ª•ng deal t·ªët nh·∫•t' below Portfolio group",
    "V01.6: Booking Toggle Label - 'K·∫øt h·ª£p gi·∫£m gi√° (l≈©y ti·∫øn theo Booking rules)' for Booking.com channels",
    "V01.7: Guide Page - Comprehensive OTA Pricing Section with 5-channel detailed documentation",
    "V01.7: Guide Dual Formulas - NET‚ÜíBAR and BAR‚ÜíNET with correct formulas per calc type",
    "V01.7: Guide Channel Cards - Agoda(ADDITIVE 20%), Booking(PROGRESSIVE 18%), Expedia(SINGLE_DISCOUNT 17%), Traveloka(ADDITIVE 15%), CTRIP(ADDITIVE 18%)",
    "V01.7: Guide Comparison Table - Quick comparison of all 5 channels: calc type, stacking, commission",
    "V01.7: Guide 3 Calc Types Explainer - Additive vs Progressive vs Single Discount with channel mapping",
    "V01.8: Dynamic Pricing by OCC - Occupancy-based tier pricing with season multipliers, guardrails (min_rate, max_discount), trace engine",
    "V01.8: OCC Tier Editor - CRUD with dirty-state tracking, inline row errors, beforeunload warning, disable Save when clean",
    "V01.8: Season Config Panel - Named seasons with date ranges, multiplier, color-coded labels",
    "V01.8: Season Rate Editor - Override BAR per room_type √ó season, import from CSV",
    "V01.8: Dynamic Pricing Matrix - Grid view (Room √ó Channel), cell-level guardrail borders (red left border + tooltip), sticky headers",
    "V01.8: Context Bar Chips - 3 chips: OCC% (blue/purple), Season (emerald/purple), Tier (indigo) + Override toggle",
    "V01.8: Cell Drill-Down Panel - Click cell ‚Üí 320px side panel, read-only trace[], guardrail status, effective discount",
    "V01.8: Effective Discount Label - Shows 'Effective discount: X%' when BAR‚â†Display price, per-cell -X% tag",
    "V01.8: Enriched CSV Export - 8-line metadata header (hotel/channel/stayDate/season/occPct/tier/asOfTs/roundingStep) + viewMode-aware",
    "V01.8: Pricing page 6 tabs: H·∫°ng ph√≤ng, K√™nh OTA, Khuy·∫øn m√£i, B·∫£ng gi√°, Gi√° Linh Ho·∫°t, T·ªëi ∆∞u OTA",
    "V01.8: Architecture doc ARCHITECTURE_PRICING.md - Describes engine pipeline, trace format, guardrail system",
    "V01.8: Golden tests pricing-golden.test.ts - Snapshot tests for pricing engine correctness",
    "V01.8: Lint script lint-pricing-architecture.ts - Validates no direct DB calls in engine, no client recompute",
    "V01.9: Phase 03 Unified Pricing ‚Äî server-only engine as single source of truth, ~210 lines removed from PromotionsTab.tsx",
    "V01.9: usePricingPreview hook ‚Äî AbortController for stale request cancellation, debounce 250ms, isRefreshing state",
    "V01.9: StackingResult type in engine.ts ‚Äî ignored[] with human-readable reasons per dropped promo",
    "V01.9: PreviewResult enriched in service.ts ‚Äî breakdown[], resolvedPromotions, calc_version v3.0.0",
    "V01.9: Promotions Tab loading states ‚Äî Loader2 spinner replaces icons during refresh, opacity-60 transition",
    "V01.9: Golden tests expanded to 13 cases ‚Äî Genius L1+L2 dedup, rounding tolerance ¬±1000, ignored[] verification",
    "V01.9: force-dynamic in calc-preview route.ts ‚Äî prevents Next.js caching of pricing API responses",
    "V01.9: Booking.com 3-branch stacking ‚Äî EXCLUSIVE (Deep Deal blocks ALL incl Genius), ONLY_WITH_GENIUS (Getaway + Genius), no-campaign (normal)",
    "V01.9: stackBehavior field propagated from catalog.ts through service.ts to engine.ts DiscountItem",
    "V01.9: Analytics tab redesign ‚Äî charts-first layout, compact KPI strip with DOD inline, horizontal DatesToWatch chips",
    "V01.9: AnalyticsKpiRow compact strip ‚Äî 7 metrics + DOD merged inline (~48px vs ~120px)",
    "V01.9: DatesToWatchPanel horizontal chip strip ‚Äî scrollable pills (~48px vs ~200px vertical list)",
    "V01.9: InsightsPanel V2 Engine ‚Äî 6 generators (compression, revenue_opportunity, pace_stly, pickup_acceleration, cancel_tiers, segment_mix) with top3 scoring",
    "V01.9: Insight Text Plain Vietnamese ‚Äî All RM jargon (RN, ADR, STLY, OCC, pickup, forecast, uplift, RevPAR, segment, commission, leakage, promo) replaced with natural language",
    "V01.9: InsightsPanel 2-Tab Layout ‚Äî Tab 1: Top actions + other insights, Tab 2: Ng√†y ch√∫ √Ω kh√°c (compression extras). Pill-style tabs with count badges",
    "V01.9: Insight Card Labeled Sections ‚Äî Expanded cards show T√¨nh h√¨nh / √ù nghƒ©a / N√™n l√†m / T√°c ƒë·ªông ∆∞·ªõc t√≠nh labels for GM readability",
    "V01.9: Forecast Data Fix ‚Äî days30 limited to actual 30-day window, forecast query take:90 matching OTB coverage"
  ],
  "cancellation_bridge_v011": {
    "status": "Implemented",
    "description": "Bridges cancellation records to reservations for accurate OTB calculation",
    "files": [
      "lib/normalize.ts - Key normalization (UPPER, TRIM, alphanumeric only)",
      "lib/cancellationBridge.ts - Bridge logic with matching, conflict resolution, DQ checks"
    ],
    "matching_algorithm": {
      "strategy": "take:2 for ambiguity detection",
      "order": [
        "last_modified_time desc",
        "book_time desc",
        "loaded_at desc"
      ],
      "keys": [
        "reservation_id_norm",
        "arrival_date",
        "room_code_norm (optional)"
      ]
    },
    "match_statuses": [
      "matched",
      "unmatched",
      "ambiguous",
      "conflict",
      "dq_issue",
      "unsupported_partial"
    ],
    "time_travel_otb": {
      "formula": "booking_date <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)",
      "book_time_fallback": "booking_date at 00:00:00 if book_time is null",
      "revenue_split": "total/nights per night, remainder to last night"
    }
  },
  "user_management_v01": {
    "status": "Implemented",
    "roles": {
      "super_admin": "Global admin - access all hotels, all features",
      "hotel_admin": "Per-hotel admin - full access within assigned hotels",
      "manager": "Per-hotel manager - view + some edit permissions",
      "viewer": "Per-hotel read-only access"
    },
    "pages": [
      "/admin/users - User management with create/assign modals",
      "/admin/hotels - Hotel management with create/edit modals",
      "/select-hotel - Multi-hotel picker for users with multiple assignments",
      "/blocked - Blocked user page (auto sign-out)",
      "/no-hotel-access - Users without hotel assignments",
      "/unauthorized - Permission denied page"
    ],
    "components": [
      "HotelSwitcher - Dropdown in sidebar to switch active hotel",
      "Sidebar - Hamburger menu on mobile, logout button with user info in footer",
      "LoginPage - Glassmorphism card with 4TK brand gradient background",
      "AdminPages - Gradient blue header matching Data Inspector style"
    ]
  },
  "decisions": [
    "Full-stack Next.js for MVP speed",
    "UUIDs for all Primary Keys (SaaS scalability)",
    "Append-Only reservations for audit trail",
    "Use Supabase for Database Hosting",
    "Heuristic Forecasting instead of ML for V01",
    "Ladder Pricing Strategy with configurable presets",
    "Use fast-xml-parser for server-side XML parsing",
    "Light SaaS Pro theme with lavender gray (#F5F7FB) background",
    "NextAuth.js v5 with Google OAuth for authentication",
    "JWT-based session with user role and accessible hotels",
    "httpOnly cookie for active hotel persistence",
    "HotelUser junction table for many-to-many user-hotel relationships",
    "Separate global role (User.role) and per-hotel role (HotelUser.role)",
    "V01.1: Bridge cancellations to reservations for accurate OTB",
    "V01.1: Use timestamptz for cancel_time and book_time",
    "V01.1: Time-travel OTB using asOfTs parameter",
    "V01.2: Progressive mode = BAR / (1-comm) / Œ†(1-d·µ¢) - compounds discounts",
    "V01.2: Additive mode = BAR / (1-comm) / (1-Œ£d·µ¢) - sums discounts",
    "V01.2: Validation rules: max 1 Seasonal, max 1 Targeted per subcategory",
    "V01.2: Vendor-specific max discount: Agoda 80%, Booking.com no limit",
    "V01.2: Booking.com promotions mapped to existing PromotionGroup types",
    "V01.2: Demo Hotel (ID: 159fe315-79a0-48a3-adac-f47d4f56b748) as fallback for new users",
    "V01.2: Traveloka Channel Rate - applied before campaigns (Additive mode, 15% commission)",
    "V01.2: Trip.com ADDITIVE mode - same box pick 1, different boxes stack additively (d‚ÇÅ+d‚ÇÇ+...)",
    "V01.2: Expedia ISOLATED mode - each promotion creates separate rate plan, no stacking",
    "V01.2: Booking.com Deep Deals (Limited-time, Deal of the Day) - allow_stack=false",
    "V01.6: 2-layer architecture for promotions: Engine layer = groupType + stackBehavior (source-of-truth for rules), UI layer = display labels (for GM usability)",
    "V01.6: GENIUS separated from TARGETED in PromotionGroup enum - Genius L1/L2/L3 are always stackable with everything",
    "V01.6: Campaign EXCLUSIVE blocks everything except Genius deals (Genius always passes through)",
    "V01.6: Business Bookers is EXCLUSIVE and blocks ALL including Genius (different from Campaign EXCLUSIVE)",
    "V01.6: Free Nights uses inverse formula: Stay X / Pay Y ‚Üí discount_pct = round((1 - Y/X) √ó 100)",
    "V01.9: Booking.com 3-branch: EXCLUSIVE (Deep Deal/Black Friday) blocks ALL; ONLY_WITH_GENIUS (Getaway/Early2026) stacks with Genius only; no-campaign = normal stacking",
    "V01.9: stackBehavior from catalog propagated to DiscountItem ‚Äî engine reads it for branch selection",
    "V01.9: Analytics charts-first layout ‚Äî GM sees STLY+Supply immediately after KPI, Room Mix+LeadTime in row 4",
    "Auto-detect hotel_id from reservations_raw (groupBy most reservations) instead of env var DEFAULT_HOTEL_ID",
    "Super Admin bypasses Demo Hotel restrictions (Settings page, Guide page, OTA Growth tab)",
    "OTA Growth Playbook integrated into Pricing page (not Guide page) for logical grouping with OTA Pricing tabs",
    "Dashboard uses OTB as_of_date as reference date for cancellation stats and forecasts",
    "Multi-Hotel Active Context: getActiveHotelId() uses cookie‚Üísession‚Üífallback chain with permission validation",
    "Super Admin fallback: first real hotel by created_at (skips Demo Hotel) for deterministic behavior",
    "Cookie is a preference, not authorization: server validates user has access to cookie hotel_id",
    "Auto-assign Demo Hotel: existing users with 0 hotel assignments get Demo Hotel automatically on login",
    "signIn callback creates user, jwt callback assigns Demo Hotel if needed (race condition fix)",
    "Performance: Vercel Functions must be in same region as DB (icn1=Seoul) to minimize query latency",
    "Performance: cachedStats used findMany + JS reduce without hotel_id filter = full table scan",
    "Performance: Dashboard had 3 sequential batches, batch 3 only needed actualOtbDate (known after batch 1)",
    "Performance: CancellationSection had 3 sequential queries without hotel_id = full table scan x3",
    "V01.8: Dynamic Pricing engine is pure function (no DB calls) ‚Äî all data passed as params",
    "V01.8: Cell drill-down panel reads trace[] from API response ‚Äî NO client-side recompute",
    "V01.8: CSV export includes metadata and respects current viewMode (BAR/Display/NET)",
    "V01.8: OCC tiers saved atomically via $transaction (delete all + create all)",
    "V01.8: Season date ranges validated server-side for no overlaps within same hotel",
    "V01.8: Guardrails are advisory (red border + tooltip) not blocking ‚Äî GM can still save",
    "V01.9: Phase 03 ‚Äî PromotionsTab.tsx must NOT contain any pricing math. Removed validate(), dedupeBySubcategory(), pickBestGenius(), all stacking logic",
    "V01.9: resolveTimingConflicts() moved server-side only ‚Äî client reads validation.warnings from API response",
    "V01.9: usePricingPreview hook replaces all direct fetch() calls in PromotionsTab ‚Äî single source of truth for preview data",
    "V01.9: AbortController cancels in-flight requests when user toggles promo rapidly ‚Äî prevents race condition stale data",
    "V01.9: Insight text must use plain Vietnamese ‚Äî no RM jargon. GM reads without asking anyone. Labels: T√¨nh h√¨nh, √ù nghƒ©a, N√™n l√†m, T√°c ƒë·ªông ∆∞·ªõc t√≠nh",
    "V01.9: InsightsPanel tabs auto-hide when no compression extras ‚Äî single tab view if only top actions exist",
    "V01.9: insightsV2Engine days30 must filter by actual calendar date range (today + 30d), not use all input days"
  ],
  "ui_design": {
    "theme": "SaaS Pro Light",
    "colors": {
      "background": "#F5F7FB (lavender gray)",
      "surface": "#ffffff (white cards)",
      "primary": "#1E3A8A (royal blue)",
      "sidebar": "#204184 (LOGO_BLUE)",
      "text": "#1e293b (dark gray)",
      "border": "slate-200/80"
    },
    "brand_colors": {
      "primary": "#204183 (from logo)",
      "dark": "#0B1E3A (deep background)",
      "mid": "#16325F (gradient middle)",
      "light": "#AABAD1 (hover/highlight)"
    },
    "components": {
      "surface": "rounded-2xl bg-white border border-slate-200/80 shadow-[0_1px_2px_rgba(16,24,40,0.06)]",
      "header": "rounded-2xl px-6 py-4 text-white shadow-sm background: linear-gradient(to right, #1E3A8A, #102A4C)",
      "container": "mx-auto max-w-[1400px] px-8 py-6 space-y-6",
      "sidebar": "fixed left-0 w-64 h-screen bg-[#204184] text-white (hidden on mobile with hamburger toggle)",
      "login_page": "Gradient background (#0B1E3A ‚Üí #16325F ‚Üí #204183), glassmorphism card (bg-white/10 backdrop-blur-xl)"
    },
    "responsive": {
      "breakpoint": "lg (1024px)",
      "mobile": "Hamburger menu in fixed header, sidebar slides from left, overlay for close",
      "desktop": "Fixed sidebar always visible, ml-64 for main content"
    }
  },
  "knowledge_items": {
    "gotchas": [
      "DOMParser is browser-only, use fast-xml-parser for Node.js",
      "Prisma Date comparison requires exact match - normalize to midnight",
      "Prisma generate fails while dev server running (file lock) - restart server",
      "PrismaClient cannot run in Edge Middleware - use API routes for DB calls",
      "Vercel monorepo: Must set Root Directory to 'apps/web' in Project Settings",
      "Vercel monorepo: Framework Preset must be 'Next.js', not 'Other'",
      "TypeScript IDE may need restart after prisma generate to pick up new types",
      "Admin pages need layout.tsx to include sidebar (app/admin/layout.tsx)",
      "V01.1: Prisma.ModelGetPayload<object> for inferred types",
      "V01.1: Use prisma.$transaction for atomic bridge updates",
      "JWT callback: Nested Prisma include fails silently in Edge runtime - use separate queries",
      "JWT callback: Only fetch user data on initial sign-in (when account is present), not every request",
      "Session stale: If user's hotel assignments changed, they must logout and login again to refresh JWT",
      "Cookie activeHotelId may point to invalid hotel - middleware clears it and redirects to /select-hotel",
      "React hydration mismatch warnings from browser extensions (Liner) - safe to ignore",
      "DEFAULT_HOTEL_ID env var may not match uploaded data - always auto-detect hotel_id from reservations_raw",
      "Dashboard/cancellation queries using today's date will miss historical data - use OTB as_of_date",
      "NEXT_PUBLIC_DEFAULT_HOTEL_ID removed from client components - use getActiveHotelData() server action instead",
      "signIn callback creates user ‚Üí jwt callback sees user exists but 0 hotels ‚Üí must auto-assign Demo Hotel in jwt",
      "/api/debug-user endpoint doesn't exist ‚Üí no-hotel-access page was calling it ‚Üí JSON parse error (HTML 404)",
      "OTB date used today's date as fallback when no data ‚Üí misleading. Changed to null + 'Ch∆∞a c√≥ d·ªØ li·ªáu'",
      "HotelSwitcher white dropdown clashes with dark sidebar ‚Üí redesigned with dark theme (bg-[#0f1d36])",
      "setHours(0,0,0,0) on Date object in client timezone (UTC+7) shifts date back 1 day when sent to server as UTC ‚Üí use ISO string instead",
      "Next.js loading.tsx convention auto-shows skeleton during server data fetch ‚Üí prevents user clicking repeatedly",
      "NEXTAUTH_URL on Vercel MUST be custom domain (rms.pakhos.com), NOT *.vercel.app ‚Äî OAuth callback 404 DEPLOYMENT_NOT_FOUND",
      "Google OAuth redirect URI must match NEXTAUTH_URL ‚Äî add https://rms.pakhos.com/api/auth/callback/google in Google Cloud Console",
      "Logo.png with transparent bg + dark content is invisible on dark navbar ‚Üí use inline SVG instead",
      "Emoji icons (üíπüè®) on hospitality landing page look unprofessional ‚Üí use SVG line-art icons",
      "PowerShell does not support && operator ‚Äî use semicolons (;) to chain commands",
      "ingestCSV was missing hotel validation ‚Üí FK error on importJob.create if cookie has stale hotel_id",
      "RunForecast used max(booking_date) as as_of_date but features built with today's date ‚Üí 0 results",
      "DeleteByMonth was not filtering by hotel_id ‚Üí could delete data across all hotels",
      "OTB as_of_date = loaded_at (upload date), NOT booking_date ‚Üí deleting by month of data doesn't delete OTB",
      "V01.6: PromotionGroup enum must be synced across 3 files: schema.prisma, types.ts, catalog.ts GROUP_COLORS/VENDOR_GROUP_LABELS",
      "V01.6: Free Nights X/Y inverse calc can produce rounding artifacts (e.g. Stay 7 / Pay 6 = 14.28% not 14%)",
      "V01.6: Git push can hang if credential helper dialog is hidden behind other windows ‚Äî terminate after 15s and retry",
      "V01.6: catalog.ts constants are NOT used by /api/pricing/catalog ‚Äî the API reads from DB (prisma.promotionCatalog). Must run seed-pricing.ts after updating catalog.ts",
      "V01.6: seed-pricing.ts group_type values must match catalog.ts groupType values ‚Äî mismatch causes picker to show 0 items in tabs",
      "V01.7: Early Bird + Last-Minute are mutually exclusive ‚Äî resolveTimingConflicts() must be applied in BOTH calc-matrix API AND PromotionsTab parent before totalDiscount computation",
      "V01.7: In bar_to_net mode, do NOT use calcNetFromBar() ‚Äî it internally resolves conflicts creating double-discount mismatch. Compute NET=display√ó(1-commission%) directly",
      "V01.7: React controlled input: value={input || fallback} prevents clearing. Use value={input} directly + initialize default via useEffect on mode/room change",
      "V01.8: Git commit can hang when GPG sign is configured but agent is hidden ‚Äî use --no-gpg-sign flag or terminate after 30s",
      "V01.8: PowerShell && operator not supported in older versions ‚Äî use semicolons (;) to chain commands",
      "V01.8: UUPM skill installed to .agent/skills/ (project-level) not global ‚Äî __pycache__ should be gitignored",
      "V01.9: PromotionsTab.tsx client-side pricing math causes drift from server engine ‚Äî MUST use usePricingPreview hook instead",
      "V01.9: AbortController abort() fires before new fetch starts ‚Äî check signal.aborted in response handler to avoid stale state",
      "V01.9: calc-preview route without force-dynamic gets cached by Next.js ‚Äî add export const dynamic = 'force-dynamic'",
      "V01.9: Booking.com stackBehavior must be propagated in 3 places in service.ts (genius, targeted, portfolio) ‚Äî missing any one silently defaults to EXCLUSIVE",
      "V01.9: Analytics DodChips import must be removed from AnalyticsTabContent when DOD is merged into KPI strip ‚Äî unused import causes build warning"
    ],
    "formulas": {
      "rooms_otb": "SUM(num_rooms) from reservations for that stay_date",
      "remaining_supply": "Capacity ‚àí rooms_otb",
      "adr": "revenue_otb √∑ rooms_otb",
      "recommended_price": "PricingLogic.optimize(ADR, forecast_demand, remaining_supply)",
      "time_travel_active": "book_time <= asOfTs AND (cancel_time IS NULL OR cancel_time > asOfTs)"
    },
    "data_pipeline": {
      "step1": "Upload CSV/Excel/XML ‚Üí reservations_raw (auto-detect format)",
      "step1b": "Upload Cancellation XML ‚Üí cancellations_raw ‚Üí Bridge ‚Üí reservations_raw",
      "step2": "Build OTB (time-travel, as_of_date = loaded_at) ‚Üí daily_otb",
      "step3": "Build Features (as_of_date = today) ‚Üí features_daily",
      "step4": "Run Forecast (as_of_date = max from features_daily) ‚Üí demand_forecast",
      "step5": "Pricing Engine ‚Üí recommended_price (calculated on-the-fly)"
    }
  }
}